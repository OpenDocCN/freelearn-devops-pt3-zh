<html><head></head><body>
		<div id="_idContainer048">
			<h1 id="_idParaDest-187" class="chapter-number"><a id="_idTextAnchor252"/>10</h1>
			<h1 id="_idParaDest-188"><a id="_idTextAnchor253"/>Puppet Platform Parts and Functions</h1>
			<p>So far, we have discussed Puppet as a language, but in this chapter and the following chapters, we will start to focus on Puppet as a platform and the infrastructure and components of <span class="No-Break">the platform.</span></p>
			<p>In <span class="No-Break"><em class="italic">Figure 10</em></span><em class="italic">.1</em>, the full architecture of services involved in Puppet Server and the Puppet client, to be discussed in this chapter, is shown. These services focus on how Puppet code is enforced <span class="No-Break">on servers:</span></p>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="image/B18492_10_01.jpg" alt="Figure 10.1 – Puppet server and client components"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – Puppet server and client components</p>
			<p>We will start by highlighting that we do not run through installation methods in this book. There are several open source projects to base automation on for open source Puppet and Puppet Enterprise; throughout this book, we have used the <strong class="source-inline">pead</strong>znd <strong class="source-inline">pecd</strong>m modules as the most automated mechanism for installing <strong class="bold">Puppet Editor</strong> (<strong class="bold">PE</strong>). As components are discussed, it will be noted how the versioning of Puppet packages can differ, and we’ll look at some related install versions, as well as the key users, directories, configuration files, and <span class="No-Break">services installed.</span></p>
			<p>First of all, we will examine the core services provided by the Puppet Server. These services include catalog compilation to receive requests from clients, process their current state, and determine how they should be configured based on Puppet code. A <strong class="bold">certificate authority </strong>(<strong class="bold">CA</strong>) allows<a id="_idIndexMarker688"/> agents to register and communicate with the Puppet server securely. It also includes some associated API services to access, request, and control <span class="No-Break">those services.</span></p>
			<p>Having established how the server functions, we will then show how the Puppet agent communicates with the server, requesting to have a key signed by the CA, what the communication for a catalog compilation involves, and how the agent processes and stores the <span class="No-Break">returned catalog.</span></p>
			<p>We’ll then view how PuppetDB is used to store, facts, catalogs, and events and how we can access this information via both APIs<a id="_idIndexMarker689"/> and <strong class="bold">Puppet Query Language </strong>(<strong class="bold">PQL</strong>). The relationship between PuppetDB and PostgreSQL will be examined as a frontend application to a backend database architecture, and we will also discuss how other data is stored in PostgreSQL by the Puppet <span class="No-Break">services directly.</span></p>
			<p>It will then be shown how the compilation can horizontally scale to compile catalogs of hundreds of thousands of servers using <span class="No-Break">compile servers.</span></p>
			<p>Throughout these topics, subtle differences between how PE and Puppet open source are set up will <span class="No-Break">be highlighted.</span></p>
			<p>This chapter will not cover the PE-specific features of the orchestrator, the PE console, or the supported architectures (which can allow for these services to be split out into more scalable infrastructure); these will be covered in <a href="B18492_14.xhtml#_idTextAnchor340"><span class="No-Break"><em class="italic">Chapter 14</em></span></a><span class="No-Break">.</span></p>
			<p>In this chapter, we’re going to cover the following <span class="No-Break">main topics:</span></p>
			<ul>
				<li>Puppet platform installation <span class="No-Break">and versioning</span></li>
				<li><span class="No-Break">Puppet Server</span></li>
				<li>Puppet agent-to-server <span class="No-Break">life cycle</span></li>
				<li>PuppetDB <span class="No-Break">and PostgreSQL</span></li>
				<li>Scaling <span class="No-Break">with compilers</span></li>
			</ul>
			<p class="callout-heading">Note</p>
			<p class="callout">As part of an effort to remove harmful terminology from its products, Puppet dropped the use of the terms <em class="italic">master server </em>and <em class="italic">compile master </em>and now uses <em class="italic">primary server </em>and <em class="italic">compile server</em>. As these names were quite embedded, there will be some places where classes or configuration settings do still refer <span class="No-Break">to </span><span class="No-Break"><em class="italic">master</em></span><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-189"><a id="_idTextAnchor254"/>Technical requirements</h1>
			<p>Clone the control repo from <a href="https://github.com/puppetlabs/control-repo ">https://github.com/puppetlabs/control-repo </a>to your GitHub account in a repo <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">controlrepo-chapter10</strong></span><span class="No-Break">.</span></p>
			<p>Build a large cluster with three compilers and three clients by downloading the <strong class="source-inline">params.json</strong> file from <a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/params.json">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/params.json</a> and update it with the location of your control repo and your SSH key for the control repo. Then, run the following command from your <span class="No-Break"><strong class="source-inline">pecdm</strong></span><span class="No-Break"> directory:</span></p>
			<pre class="source-code">
bolt --verbose plan run pecdm::provision –-params @params.json</pre>
			<h1 id="_idParaDest-190"><a id="_idTextAnchor255"/>Puppet platform installation and versioning</h1>
			<p>This book <a id="_idIndexMarker690"/>makes the choice not to go into the methods of installing Puppet; there is little to add to the installation instructions for open source, documented at <a href="https://puppet.com/docs/puppet/latest/server/install_from_packages.html">https://puppet.com/docs/puppet/latest/server/install_from_packages.html</a>, and any further choice of automation will depend heavily on the use case of your organization and available tooling and product sets you want to <span class="No-Break">integrate with.</span></p>
			<p>For open source Puppet, there<a id="_idIndexMarker691"/> are a number of projects automating the deployment, configuration, and integration of Puppet, such as example42’s <strong class="source-inline">psick</strong> (<a href="https://github.com/example42/psick">https://github.com/example42/psick</a>) or the Foreman project (<a href="https://github.com/theforeman/foreman-installer">https://github.com/theforeman/foreman-installer</a>), which has a specific module for installing Puppet Server (<a href="https://forge.puppet.com/modules/theforeman/puppet">https://forge.puppet.com/modules/theforeman/puppet</a>) that can be used even outside of Foreman to install Puppet. Dashboards similar to what has been provided by the PE setup can also be found in projects such as Puppetboard (<a href="https://forge.puppet.com/modules/puppet/puppetboard">https://forge.puppet.com/modules/puppet/puppetboard</a>) or Puppet <span class="No-Break">Summary (</span><a href="https://github.com/skx/puppet-summary"><span class="No-Break">https://github.com/skx/puppet-summary</span></a><span class="No-Break">).</span></p>
			<p>For PE, although manual instructions are available at <a href="https://puppet.com/docs/pe/2021.7/installing_pe.html">https://puppet.com/docs/pe/2021.7/installing_pe.html</a>, the automation choice is clear with the Puppet-supported <strong class="source-inline">peadm</strong> module; in <a href="B18492_12.xhtml#_idTextAnchor293"><span class="No-Break"><em class="italic">Chapter 12</em></span></a>, we will review how the module is used for the lab along with <strong class="source-inline">pecdm</strong> as a <span class="No-Break">B</span><span class="No-Break">olt project.</span></p>
			<p>Key points to<a id="_idIndexMarker692"/> recognize with the<a id="_idIndexMarker693"/> packages installed are that Puppet repositories provide set versions of Ruby, OpenSSL, Hiera, and Facter to use for different versions of Puppet and that packages such as <strong class="source-inline">puppetserver </strong>may not match the Puppet version being installed—for example, Puppet 7.17 will have Puppet server version 7.8 installed; these associated versions are available in the release notes. For PE, you can see all the underlying open source package versions in the documentation <span class="No-Break">at </span><a href="https://puppet.com/docs/pe/2021.7/component_versions_in_recent_pe_releases.html#component_versions_in_recent_pe_releases"><span class="No-Break">https://puppet.com/docs/pe/2021.7/component_versions_in_recent_pe_releases.html#component_versions_in_recent_pe_releases</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-191"><a id="_idTextAnchor256"/>Puppet Server</h1>
			<p>In historic versions of <a id="_idIndexMarker694"/>Puppet, Ruby-based solutions such as WEBrick or Passenger were used for running the Puppet service, but in all modern versions of Puppet, to improve scaling and performance, Puppet Server is run as a Clojure and Ruby application <a id="_idIndexMarker695"/>on a <strong class="bold">Java Virtual Machine </strong>(<strong class="bold">JVM</strong>). Puppet Server has a number of related services that share state and route requests between them. These services run inside a single JVM process, using the Trapperkeeper service framework, which is a Clojure framework for hosting <span class="No-Break">long-running applications.</span></p>
			<p>Puppet Server is installed via the <strong class="source-inline">puppetserver </strong>package in open source Puppet and the <strong class="source-inline">pe-puppetserver </strong>package in PE. This will create a system service of the same name and configuration files that, by default, will be placed in <strong class="source-inline">/etc/puppetlabs/puppetserver/conf.d </strong>in <strong class="bold">Human-Optimized Config Object Notation </strong>(<span class="No-Break"><strong class="bold">HOCON</strong></span><span class="No-Break">) format.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">The Puppet <strong class="source-inline">hocon </strong>module is the best way to automate the management of HOCON <span class="No-Break">files (</span><a href="https://forge.puppet.com/modules/puppetlabs/hocon"><span class="No-Break">https://forge.puppet.com/modules/puppetlabs/hocon</span></a><span class="No-Break">).</span></p>
			<p>Next, we’ll look at the services that make up <span class="No-Break">Puppet Server.</span></p>
			<h2 id="_idParaDest-192"><a id="_idTextAnchor257"/>The embedded web server</h2>
			<p>Puppet<a id="_idIndexMarker696"/> contains a Jetty-based web server in the JVM that sets up the mount points and communications necessary for web requests to take place between components and to access <span class="No-Break">the APIs.</span></p>
			<p>The <strong class="source-inline">webserver.conf </strong>file sets the main configuration for the web server, such as the file location <a id="_idIndexMarker697"/>of <strong class="bold">Secure Sockets Layer </strong>(<strong class="bold">SSL</strong>) keys, the port, and the host IP, which should only ever need adjusting if using an external CA. The <strong class="source-inline">web-routes.conf </strong>file sets the mount points for web API access by mounting the handlers, as shown in the following <span class="No-Break">example file:</span></p>
			<pre class="source-code">
# Configure the mount points for the web apps.
web-router-service: {
    # These two should not be modified because the Puppet 4 agent expects them to
    # be mounted at these specific paths.
    "puppetlabs.services.ca.certificate-authority-service/certificate-authority-service": "/puppet-ca"
    "puppetlabs.services.master.master-service/master-service": "/puppet"
    # This controls the mount point for the Puppet administration API.
    "puppetlabs.services.puppet-admin.puppet-admin-service/puppet-admin-service": "/puppet-admin-api"
}</pre>
			<p>The core mount points that can be seen in this file required for client-to-server communication are <span class="No-Break">listed here:</span></p>
			<p>The <strong class="source-inline">puppet-ca </strong>mount point is used by clients to communicate with the CA service and check or <a id="_idIndexMarker698"/>make a <strong class="bold">certificate signing </strong><span class="No-Break"><strong class="bold">request </strong></span><span class="No-Break">(</span><span class="No-Break"><strong class="bold">CSR</strong></span><span class="No-Break">).</span></p>
			<ul>
				<li><strong class="source-inline">master-service </strong>provides a mount point used by clients to request catalogs that are compiled via <span class="No-Break">JRuby interpreters.</span></li>
				<li>The request logging configuration set by default in <strong class="source-inline">webserver.c<a id="_idTextAnchor258"/>onf </strong>is at <strong class="source-inline">/etc/puppetlabs/puppetserver/request-logging.xml </strong>and determines how HTTP access requests are logged. By default, messages will be logged <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">/var/log/puppetlabs/puppetserver/puppetserver-access.log</strong></span><span class="No-Break">.</span></li>
			</ul>
			<p>This section<a id="_idIndexMarker699"/> should have given you an understanding of how the embedded web service sets up a web server in the JVM with the mount points necessary for requests to be made to the different components of Puppet Server and how it will log these requests. Now, we will see the two core APIs accessed via the endpoints made available by the mount points, Puppet API via <strong class="source-inline">/puppet </strong>and <strong class="source-inline">/puppet_ca</strong>, and then the Admin API <span class="No-Break">via </span><span class="No-Break"><strong class="source-inline">/puppet_admin_api</strong></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-193"><a id="_idTextAnchor259"/>The Puppet API service</h2>
			<p>The <a id="_idIndexMarker700"/>Puppet API service is made up of two endpoints created by the embedded web server—<strong class="source-inline">/puppet </strong>for configuration-related services and <strong class="source-inline">/puppet-ca </strong>for <span class="No-Break">the CA.</span></p>
			<p>Both are versioned with a string such as <strong class="source-inline">/v3 </strong>and authorization is controlled via the <strong class="source-inline">auth.conf </strong>file, a HOCON formatted file. It is unlikely you will need to edit this file unless requiring more advanced access to integrate services, but to show an example of content, the following code allows Puppet nodes to request their own catalog from <span class="No-Break">the API:</span></p>
			<pre class="source-code">
        {
            # Allow nodes to retrieve their own catalog
            match-request: {
                path: "^/puppet/v3/catalog/([^/]+)$"
                type: regex
                method: [get, post]
            }
            allow: "$1"
            sort-order: 500
            name: "puppetlabs v3 catalog from agents"
        },</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">More detailed instructions for customization authorization are available <span class="No-Break">at </span><a href="https://github.com/puppetlabs/trapperkeeper-authorization/blob/main/doc/authorization-config.md"><span class="No-Break">https://github.com/puppetlabs/trapperkeeper-authorization/blob/main/doc/authorization-config.md</span></a><span class="No-Break">.</span></p>
			<p>The Puppet agent <a id="_idIndexMarker701"/>on all modern versions of Puppet 5 to 8 uses <strong class="source-inline">/puppet/v3 </strong>endpoint services to manage clients. The <strong class="source-inline">v3 </strong>API has two types<a id="_idIndexMarker702"/> of <a id="_idIndexMarker703"/>endpoints—<strong class="bold">indirectors </strong>and <span class="No-Break"><strong class="bold">environment </strong></span><span class="No-Break">endpoints.</span></p>
			<p>Indirectors take the <span class="No-Break">form </span><span class="No-Break"><strong class="source-inline">/puppet/v3/&lt;indirection&gt;/&lt;key&gt;?environment=&lt;environment&gt;</strong></span><span class="No-Break">.</span></p>
			<p>Here, the indirection value is the indirector requested, the key is the key relevant to the call to the indirector, and the environment is the environment that should be used for this request. For example, to request a catalog be compiled, a client would construct <span class="No-Break">the following:</span></p>
			<pre class="source-code">
/puppet/v3/catalog/pe.example.com?environment=production</pre>
			<p>The following indirectors exist under <strong class="source-inline">/puppet/v3/ </strong><span class="No-Break">for clients:</span></p>
			<ul>
				<li><strong class="source-inline">Facts</strong>: The <strong class="source-inline">facts</strong> endpoint allows setting facts for the specified <span class="No-Break">node name</span></li>
				<li><strong class="source-inline">Catalog:</strong> Returns a catalog for the <span class="No-Break">specified node</span></li>
				<li><strong class="source-inline">Node</strong>: Returns node information such <span class="No-Break">as classification</span></li>
				<li><strong class="source-inline">File bucket</strong> <strong class="source-inline">file</strong>: Manages the contents of a <span class="No-Break">file bucket</span></li>
				<li><strong class="source-inline">File content</strong>: Returns file content such as files <span class="No-Break">in modules</span></li>
				<li><strong class="source-inline">File metadata</strong>: Returns the metadata of a file such as the permissions of a file <span class="No-Break">in modules</span></li>
				<li><strong class="source-inline">Report</strong>: Allows the storing of Puppet reports <span class="No-Break">for nodes</span></li>
			</ul>
			<p>The following<a id="_idIndexMarker704"/> indirectors exist under <strong class="source-inline">/puppet/v3/ </strong>for <span class="No-Break">the server:</span></p>
			<ul>
				<li><strong class="bold">Environment classes</strong>: Returns all the classes that can be parsed in the <span class="No-Break">requested environment</span></li>
				<li><strong class="bold">Environment modules</strong>: Returns information about all the modules found in an environment, such as their names <span class="No-Break">and versions</span></li>
				<li><strong class="bold">Static file content</strong>: Returns the file content of a specific version of a file resource in <span class="No-Break">an environment</span></li>
			</ul>
			<p>The separate environment endpoint that was not an indirector allows a simple call to <strong class="source-inline">/puppet/v3/environments </strong>that returns all environments known to the server. In the next chapter, we will talk about environments in <span class="No-Break">more detail.</span></p>
			<p>Tools and services can also access these same endpoints to examine data, and a <strong class="source-inline">v4 </strong>API exists with a catalog endpoint that allows for more extensive use of PuppetDB to manipulate facts and the catalog. It is used by tools such as <strong class="source-inline">octocatalog-diff </strong>(<a href="https://github.com/github/octocatalog-diff">https://github.com/github/octocatalog-diff</a>), which can generate, compare, and <span class="No-Break">manipulate catalogs.</span></p>
			<p>The <strong class="source-inline">/puppet-ca </strong>endpoint follows a similar format using <strong class="source-inline">v1 </strong>and indirectors, <span class="No-Break">as follows:</span></p>
			<ul>
				<li><strong class="bold">Certificate</strong>: Returns the certificate of a <span class="No-Break">specified name</span></li>
				<li><strong class="bold">Certificate Clean</strong>: Revokes and deletes <span class="No-Break">a certificate</span></li>
				<li><strong class="bold">Certificate Status</strong>: Requests the status of a certificate or <span class="No-Break">a CSR</span></li>
				<li><strong class="bold">Certificate Revocation List</strong>: Requests the <strong class="bold">Certificate Revocation List </strong>(<span class="No-Break"><strong class="bold">CRL</strong></span><span class="No-Break">) file</span></li>
			</ul>
			<p>As an example, to request a certificate for <strong class="source-inline">server.example.com</strong>, the following endpoint would be <span class="No-Break">hit: </span><span class="No-Break"><strong class="source-inline">/puppet-ca/v1/certificate/server.example.com</strong></span><span class="No-Break">.</span></p>
			<p>These actions will be discussed in more detail in the <em class="italic">CA </em>section of <span class="No-Break">this chapter.</span></p>
			<p>In this section, we did not go into full detail about each endpoint and making API calls to them, but later<a id="_idIndexMarker705"/> in the chapter, where we look at the client-to-server lifecycle, we will follow the logging of calls and highlight their use to show how these APIs are used by Puppet. Full details of the endpoints can be viewed <span class="No-Break">at </span><a href="https://puppet.com/docs/puppet/latest/http_api/http_report.html"><span class="No-Break">https://puppet.com/docs/puppet/latest/http_api/http_report.html</span></a><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-194"><a id="_idTextAnchor260"/>The Admin API</h2>
			<p>The Admin API <a id="_idIndexMarker706"/>has just two endpoints at <strong class="source-inline">/puppet_admin/v1/</strong>, <span class="No-Break">as follows:</span></p>
			<ul>
				<li><strong class="bold">Environment cache</strong>: Used <a id="_idIndexMarker707"/>to clear the cache of <span class="No-Break">environment data</span></li>
				<li><strong class="bold">JRuby pool</strong>: Used <a id="_idIndexMarker708"/>to clear the JRuby pool or retrieve a Ruby thread dump of running <span class="No-Break">JRuby instances</span></li>
			</ul>
			<p>Both endpoints are for more in-depth development work, so are beyond the scope of this book but help complete the picture of the Puppet server components. Details of these endpoints can be viewed at <a href="https://puppet.com/docs/puppet/latest/server/admin-api/v1/jruby-pool.html ">https://puppet.com/docs/puppet/latest/server/admin-api/v1/jruby-pool.html </a><span class="No-Break">and </span><a href="https://puppet.com/docs/puppet/latest/server/admin-api/v1/environment-cache.html"><span class="No-Break">https://puppet.com/docs/puppet/latest/server/admin-api/v1/environment-cache.html</span></a><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-195"><a id="_idTextAnchor261"/>CA</h2>
			<p>By default, Puppet <a id="_idIndexMarker709"/>uses its own in-built CA and <strong class="bold">public key infrastructure </strong>(<strong class="bold">PKI</strong>) to <a id="_idIndexMarker710"/>secure all <span class="No-Break">SSL communications.</span></p>
			<p>Two commands are used to interact with the Puppet CA setup—<strong class="source-inline">puppetserver ca </strong>for server-side actions such as signing or revoking certificates and <strong class="source-inline">puppet ssl </strong>for agent-side tasks such as requesting and downloading certificates. These commands make calls to the <strong class="source-inline">puppet-ca </strong>endpoint via <span class="No-Break">the CLI.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Despite the introduction of the <strong class="source-inline">puppet-ca </strong>endpoint, the five commands of the previous <strong class="source-inline">ruby ca </strong>implementation were still available until their removal in Puppet 6: <strong class="source-inline">puppet certificate</strong>, <strong class="source-inline">puppet cert</strong>, <strong class="source-inline">puppet certificate_request</strong>, <strong class="source-inline">puppet ca</strong>, and <strong class="source-inline">puppet certificate_revocation_list</strong>. They have all been replaced by the <strong class="source-inline">puppetserver ca </strong>and <strong class="source-inline">puppet ssl </strong>commands. Even if you are using Puppet 5, it is strongly advised not to use these Ruby commands as using both API and Ruby implementations simultaneously can corrupt <span class="No-Break">the CA.</span></p>
			<p>While the<a id="_idIndexMarker711"/> automation of installation discussed in the introduction should cover the initial setup, it is worth knowing whether the CA setup has been performed by running <strong class="source-inline">puppetserver ca setup</strong>. Before the <strong class="source-inline">puppetserver/pe-puppetserver </strong>service has started, it will create a separate root CA and an intermediate signing CA. If the <strong class="source-inline">puppetserver/pe-puppetserver </strong>service is started before this step, it will create a single combined root and signing CA, which was the prior way Puppet operated. Unless you have a specific need for a single certificate, this should be avoided. From PE 2019.x and Puppet 6.x, these certificates last 15 years; previously, this was 5 years, and it’s important to understand that upgrading Puppet versions does not extend <span class="No-Break">the CA.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Extending an expired CA is possible via<a id="_idIndexMarker712"/> the <strong class="source-inline">ca_extend </strong><span class="No-Break">module (</span><a href="https://forge.puppet.com/modules/puppetlabs/ca_extend"><span class="No-Break">https://forge.puppet.com/modules/puppetlabs/ca_extend</span></a><span class="No-Break">).</span></p>
			<p>The keys and certificates created in this step will be created in a directory called <strong class="source-inline">/etc/puppetlabs/puppetserver/ca </strong>for Puppet 7 and above or one called <strong class="source-inline">/etc/puppetlabs/puppet/ca </strong>for Puppet 6 and below. There is a <strong class="bold">symbolic link </strong>(<strong class="bold">symlink</strong>) for <strong class="source-inline">/etc/puppetlabs/puppet/ca </strong>to the new location to avoid confusion. The<a id="_idIndexMarker713"/> directory will contain <span class="No-Break">the following:</span></p>
			<ul>
				<li><strong class="source-inline">ca_crl.pem</strong>: <span class="No-Break">The CRL</span></li>
				<li><strong class="source-inline">ca_crt.pem</strong>: The CA-signed certificate <span class="No-Break">public certificate</span></li>
				<li><strong class="source-inline">ca_key.pem</strong>: The CA <span class="No-Break">private key</span></li>
				<li><strong class="source-inline">ca_pub.pem</strong>: The CA <span class="No-Break">public key</span></li>
				<li><strong class="source-inline">inventory.txt</strong>: A list of certificates the CA signed with their serial numbers and <span class="No-Break">expiry dates</span></li>
				<li><strong class="source-inline">requests</strong>: Unsigned <span class="No-Break">CSR files</span></li>
				<li><strong class="source-inline">root_key.pem</strong>: This is the root key used to sign the CA certificate if using a separate root CA and an <span class="No-Break">intermediate CA</span></li>
				<li><strong class="source-inline">serial</strong>: This file contains an incrementing counter of the new serial number <span class="No-Break">for certificates</span></li>
				<li><strong class="source-inline">signed</strong>: This folder contains all signed <span class="No-Break">CSR files</span></li>
			</ul>
			<p>In addition<a id="_idIndexMarker714"/> to these files, an infrastructure CRL can be maintained, which by default is not used in open source Puppet but is used in PE. To have a smaller CRL, the <strong class="source-inline">infra_inventory.txt </strong>file is managed to contain the Puppet infrastructure servers; when revoked, these systems are added to <strong class="source-inline">infra_crl.pem</strong>. This is enabled by setting <strong class="source-inline">infra certificate-authority.enable-infra-crl </strong>to <strong class="source-inline">true </strong>in the <strong class="source-inline">puppet.conf </strong>file. We will talk in more detail about the <strong class="source-inline">puppet.conf </strong>file later in this chapter. This approach means the Puppet clients only need to receive the small infrastructure CRL, which is important for estates with a high churn of servers. The following files will <span class="No-Break">be maintained:</span></p>
			<ul>
				<li><strong class="source-inline">Infra_inventory.txt</strong>: A list of certificates the CA signed for <span class="No-Break">infrastructure servers</span></li>
				<li><strong class="source-inline">Infra_serials</strong>: This file contains an incrementing counter of the new serial number for <span class="No-Break">infrastructure servers</span></li>
				<li><strong class="source-inline">Infra_crl.pem</strong>: The CRL of <span class="No-Break">infrastructure servers</span></li>
			</ul>
			<p>If your organization requires the use of an external CA, it is possible to use your organization’s own root CA and import it using the <strong class="source-inline">puppetserver ca import </strong>command (the full process is outlined at <a href="https://puppet.com/docs/puppet/latest/server/intermediate_ca.html">https://puppet.com/docs/puppet/latest/server/intermediate_ca.html</a>), leaving Puppet to act just as an intermediate CA. Alternatively, the CA service can be disabled by deploying a single externally generated root and signing CA, as outlined at <a href="https://puppet.com/docs/puppet/latest/config_ssl_external_ca.html">https://puppet.com/docs/puppet/latest/config_ssl_external_ca.html</a>. This book recommends against using this approach as it would require automating the distribution of certificates, which Puppet services no <span class="No-Break">longer perform.</span></p>
			<p>When an agent <a id="_idIndexMarker715"/>makes a request to the CA, a CSR is sent and the signing policy by default has to wait for a manual signing with the CSR stored in the <strong class="source-inline">requests </strong>folder. Waiting requests can be reviewed by running <strong class="source-inline">puppetserver ca list </strong>and then signed by running <strong class="source-inline">puppetserver ca sign --certname &lt; certname to sign &gt;</strong>. All certificates that have been signed can be viewed by running <strong class="source-inline">puppetserver ca </strong><span class="No-Break"><strong class="source-inline">list --all</strong></span><span class="No-Break">.</span></p>
			<p>If you are using PE, certificate signing can be performed and viewed on the PE web console, as pictured in <span class="No-Break"><em class="italic">Figure 10</em></span><span class="No-Break"><em class="italic">.2</em></span><span class="No-Break">:</span></p>
			<div>
				<div id="_idContainer045" class="IMG---Figure">
					<img src="image/B18492_10_02.jpg" alt="Figure 10.2 – PE console certificate signing"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – PE console certificate signing</p>
			<p>Certificates can be revoked using the <strong class="source-inline">puppetserver ca revoke --certname &lt; certname to revoke &gt; </strong>command, and to clean up and remove a revoked certificate from the CA, you can then run <strong class="source-inline">puppetserver ca clean --certname &lt; revoked </strong><span class="No-Break"><strong class="source-inline">certname &gt;</strong></span><span class="No-Break">.</span></p>
			<p>It is common when manual auto signing is used for a workflow that tools such as VMware’s <strong class="bold">vRealize Orchestrator </strong>(<strong class="bold">VRO</strong>) will <a id="_idIndexMarker716"/>make calls to the CA API as part of the deployment and decommissioning <span class="No-Break">of servers.</span></p>
			<p>To <a id="_idIndexMarker717"/>automate this process, auto signing can be configured in three ways. In what is known <a id="_idIndexMarker718"/>as <strong class="bold">naïve signing </strong>whereby <strong class="source-inline">autosign = true </strong>is added to the <strong class="source-inline">master </strong>section of <strong class="source-inline">puppet.conf</strong>, this change causes the CA to sign any request and should never be used in a <span class="No-Break">production environment.</span></p>
			<p>The second way is to create an <strong class="source-inline">autosign.conf </strong>file at <strong class="source-inline">/etc/puppetlabs/puppet/autosign.conf</strong>. In this file, there can be server names or domain name globs where each line represents a node name or a domain that can be auto-signed. For example, let’s say a file had the <span class="No-Break">following content:</span></p>
			<pre class="source-code">
server1.puppet.com
*.example.com</pre>
			<p>This would mean that <strong class="source-inline">server1.puppet.com </strong>and any server in the <strong class="source-inline">example.com </strong>domain would <span class="No-Break">be auto-signed.</span></p>
			<p>The third method is to set the <strong class="source-inline">autosign </strong>value in the <strong class="source-inline">puppet.conf </strong>file to be equal to a script. This script can be in any language and will receive as its first argument the certificate name and then the CSR contents as standard input. The script should then end with a zero-return code to sign the script or a non-zero code to not sign it. This leads to a common method of CSRs containing a secret to check in the script, or in the public cloud, tags can be used. It is beyond the scope of this book to discuss writing these scripts, and while Puppet only provides a description of how to construct these scripts at <a href="https://puppet.com/docs/puppet/latest/ssl_autosign.html#ssl_policy_based_autosigning">https://puppet.com/docs/puppet/latest/ssl_autosign.html#ssl_policy_based_autosigning</a>, Amazon gives an excellent example <span class="No-Break">at </span><a href="https://aws.amazon.com/blogs/mt/aws-opsworks-puppet-enterprise-and-an-alternate-implementation-for-policy-based-auto-signing/"><span class="No-Break">https://aws.amazon.com/blogs/mt/aws-opsworks-puppet-enterprise-and-an-alternate-implementation-for-policy-based-auto-signing/</span></a><span class="No-Break">.</span></p>
			<p>This section has laid out how a CA is configured and run as a Puppet server. Later in this chapter, the full lifecycle of agents will be reviewed, showing how the client creates a CSR and uses the CA to finish the services offered by Puppet Server and looking at <span class="No-Break">JRuby interpreters.</span></p>
			<h2 id="_idParaDest-196"><a id="_idTextAnchor262"/>JRuby interpreters</h2>
			<p>JRuby<a id="_idIndexMarker719"/> is a Java<a id="_idIndexMarker720"/> implementation of Ruby allowing for the use of Ruby on JVMs; this allows for greater scalability than with traditional Ruby deployments such as Ruby on Rails as most Ruby interpreters aren’t capable of thread safety and use locks to run one thread at a time. Puppet Server has a pool of JRuby interpreters/instances that are available to perform various application work such as compiling catalogs and handling reports. The number of interpreters in the pool reflects how many Ruby application actions can be run simultaneously and can be configured with the <strong class="source-inline">max-active-instances  </strong>parameter in the <strong class="source-inline">puppetserver.conf </strong>file, in PE via Hiera in the console, or in code via <strong class="source-inline">puppet_enterprise::master::puppetserver:: jruby_max_active_instances</strong>. We will be looking at this in more detail in <a href="B18492_13.xhtml#_idTextAnchor321"><span class="No-Break"><em class="italic">Chapter 13</em></span></a>, where we discuss the metrics and tooling to review and set <span class="No-Break">this sizing.</span></p>
			<p>Having discussed the components of Puppet Server, we will now look at the configuration such as users, logging, and filesystems to understand where these services can be customized and what is required <span class="No-Break">by them.</span></p>
			<h2 id="_idParaDest-197"><a id="_idTextAnchor263"/>Configuration and logs for Puppet Server</h2>
			<p>We briefly <a id="_idIndexMarker721"/>touched on certain configuration files and the settings available as <a id="_idIndexMarker722"/>we discussed each component, but we will give a summary here. For most of the configuration files, it is unnecessary to customize them, and most defaults will meet <span class="No-Break">your requirements.</span></p>
			<p>For PE, the <strong class="source-inline">pe-puppetserver </strong>Puppet Server service will run under a <strong class="source-inline">pe-puppet </strong>account, while on open source Puppet, the <strong class="source-inline">puppetserver </strong>service will be run under the <strong class="source-inline">puppet </strong>account. In both accounts, they will have a <strong class="source-inline">nologin </strong>shell set so that the user just provides an account to run the service and own relevant files for <span class="No-Break">the service.</span></p>
			<p>The following configuration files and application directories will be created <span class="No-Break">and used:</span></p>
			<ul>
				<li><strong class="source-inline">/etc/puppetlabs/puppetserver/bootstrap.cfg</strong>: A file containing a list of services that Trapperkeeper should start up; these are the handlers mounted by the embedded <span class="No-Break">web server.</span></li>
				<li><strong class="source-inline">/etc/puppetlabs/puppetserver/request-logging.xml</strong>: A file defining how HTTP access requests <span class="No-Break">are logged.</span></li>
				<li><strong class="source-inline">/etc/puppetlabs/puppetserver/conf.d</strong>: This directory contains the following main configuration files for components in <span class="No-Break">HOCON format:</span><ul><li><strong class="source-inline">global.conf</strong>: This file sets global configuration settings for Puppet and by default just contains the logging config <span class="No-Break">file location.</span></li><li><strong class="source-inline">webserver.conf</strong>: This file configures the embedded web server with details such as port <span class="No-Break">and logging.</span></li><li><strong class="source-inline">web-routes.conf</strong>: This file sets mount points for Puppet’s <span class="No-Break">web services.</span></li><li><strong class="source-inline">puppetserver.conf</strong>: This file sets the configuration for the core Puppet server application such as the number of <strong class="source-inline">jruby </strong><span class="No-Break">instances running.</span></li><li><strong class="source-inline">auth.conf</strong>: This file sets the access permissions for endpoints mounted <span class="No-Break">by </span><span class="No-Break"><strong class="source-inline">web-routes.conf</strong></span><span class="No-Break">.</span></li><li><strong class="source-inline">ca.conf</strong>: This file configures settings for <span class="No-Break">the CA.</span></li><li><strong class="source-inline">products.conf</strong>: An <a id="_idIndexMarker723"/>optional file that can set product settings such as analytics data and <span class="No-Break">update checks.</span></li></ul></li>
				<li><strong class="source-inline">/etc/puppetlabs/puppetserver/ssl/ca</strong>: Certificates and keys related<a id="_idIndexMarker724"/> to the Puppet CA (<strong class="source-inline">/etc/puppetlabs/puppet/ssl/ca </strong>in Puppet 6 <span class="No-Break">and below).</span></li>
				<li><strong class="source-inline">/opt/puppetlabs/puppet/lib/ruby/vendor_gems</strong>: Puppet Server puts Ruby gems related to the operation of the CA in <span class="No-Break">this directory.</span></li>
				<li><strong class="source-inline">/opt/puppetlabs/server</strong>: This directory contains the <strong class="source-inline">JRuby-gems </strong>and binaries for running <span class="No-Break">Puppet Server.</span></li>
				<li><strong class="source-inline">/var/run/puppetlabs/puppetserver/puppetserver.pid</strong>: This file contains the PID of the running <span class="No-Break">Puppet process.</span></li>
				<li><strong class="source-inline">/etc/puppetlabs/puppet.conf</strong>: This file holds the configuration for both the Puppet client and Puppet Server on the primary. These settings can be viewed by running <strong class="source-inline">puppet </strong><span class="No-Break"><strong class="source-inline">config print</strong></span><span class="No-Break">.</span></li>
			</ul>
			<p>The vast majority <a id="_idIndexMarker725"/>of settings in the files will be used at default values unless external integrations such as the external root CA are required and are only worth mentioning as a reference to understand the setup of the Puppet. A full reference and options for settings can be reviewed at  <a href="https://puppet.com/docs/puppet/latest/server/configuration.html ">https://puppet.com/docs/puppet/latest/server/configuration.html </a>for <strong class="source-inline">/</strong><span class="No-Break"><strong class="source-inline">etc/puppetlab/puppetserver</strong></span><span class="No-Break">-based settings.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">If you have chosen one of the open source Puppet automation tools/modules discussed in the introduction, it may allow the setting of configuration values <span class="No-Break">on install</span><span class="No-Break">ation</span><span class="No-Break">.</span></p>
			<p>PE users should be aware due to extra automation of configuration that a lot of those settings such as those in <strong class="source-inline">puppetserver.conf </strong>are configured via Hiera, and the documentation at <a href="https://puppet.com/docs/pe/2021.7/config_puppetserver.html ">https://puppet.com/docs/pe/2021.7/config_puppetserver.html </a>should be followed for <span class="No-Break">the configuration</span><span class="No-Break">.</span></p>
			<p>The <a id="_idIndexMarker726"/>configuration for tuning these settings will be looked at in more detail in <a href="B18492_13.xhtml#_idTextAnchor321"><span class="No-Break"><em class="italic">Chapter 13</em></span></a><span class="No-Break">.</span></p>
			<p>The full options for the settings for <strong class="source-inline">/etc/puppetlabs/puppet.conf </strong>can be reviewed at <a href="https://www.puppet.com/docs/puppet/latest/config_file_main.html">https://www.puppet.com/docs/puppet/latest/config_file_main.html</a>; the file itself provides sections that can configure the Puppet server, the Puppet agent, and how <strong class="source-inline">puppet apply </strong>runs. The sections are <strong class="source-inline">main</strong>, which provides default values, <strong class="source-inline">agent</strong>, which provides settings to the Puppet client, <strong class="source-inline">user</strong>, which provides settings for when using Puppet <strong class="source-inline">apply</strong>, and <strong class="source-inline">master</strong>/<strong class="source-inline">server </strong>for applying settings to the <span class="No-Break">Puppet server.</span></p>
			<p>Since Puppet 6, it has been possible to use a <strong class="source-inline">server </strong>section instead of a <strong class="source-inline">master </strong>section, but many automation tools have not caught up with this change, and as they are not interchangeable terms and could create confusion, be careful to only use the term relevant to <span class="No-Break">your implementation.</span></p>
			<p>Puppet applies settings from the <strong class="source-inline">master</strong>/<strong class="source-inline">server</strong>, <strong class="source-inline">apply</strong>, or <strong class="source-inline">agent </strong>section first, then falls back to the <strong class="source-inline">main </strong>section and, if it finds no setting, will use <span class="No-Break">a default.</span></p>
			<p>Let’s look at some example content of a file on a <strong class="source-inline">peadm</strong> built Puppet <span class="No-Break">lab server:</span></p>
			<pre class="source-code">
[master]
node_terminus = classifier
storeconfigs = true
storeconfigs_backend = puppetdb
reports = puppetdb
certname = pe-server-davidsand-0-cffe02.tq2kpafq5bsehkpub4ur5a35ya.xx.internal.cloudapp.net</pre>
			<p>The square<a id="_idIndexMarker727"/> brackets indicate the name of a section and then a set of key-value pairs. The settings here show the certificate name (<strong class="source-inline">certname</strong>) of our Puppet server and also show that it sends reports to PuppetDB via the <strong class="source-inline">reports </strong>setting, that it is set up to store catalog, node, and fact information with <strong class="source-inline">storeconfigs</strong> set to <strong class="source-inline">true</strong>, that these will be stored in PuppetDB, and that <strong class="source-inline">storeconfigs_backend </strong>is set to PuppetDB. Finally, <strong class="source-inline">node_terminus </strong>is set to <strong class="source-inline">classifier</strong>, which reflects how the primary server should classify clients. This will be discussed in greater detail in the <span class="No-Break">next chapter.</span></p>
			<p>The best<a id="_idIndexMarker728"/> way to view and manipulate the settings including defaults not set by <strong class="source-inline">puppet.conf</strong> is by using the <strong class="source-inline">puppet</strong> <strong class="source-inline">config</strong> command, which can show all settings. By running <strong class="source-inline">puppet config print all known</strong>, the settings will be printed, or an individual setting can be printed by detailing the section and value to print via <strong class="source-inline">puppet config print</strong> <strong class="source-inline">--section</strong> <strong class="source-inline">master</strong> <strong class="source-inline">certname</strong>. The <strong class="source-inline">puppet</strong> <strong class="source-inline">config </strong>command can also add or remove values using the <strong class="source-inline">set</strong> or <strong class="source-inline">delete</strong> options and selecting a section key and value to perform an action on. For example, the following commands will delete <strong class="source-inline">storeconfigs</strong> from the <strong class="source-inline">master</strong> section and change the certificate name <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">newname.example.com</strong></span><span class="No-Break">:</span></p>
			<pre class="source-code">
puppet config delete --section master storeconfigs
puppet config add --section master certname newname.example.com</pre>
			<p>These commands will automatically add a section if it’s not already in the file, but the Puppet service would need to be restarted for any changes to <span class="No-Break">take place.</span></p>
			<p>We will work with more examples of manipulating the <strong class="source-inline">puppet.conf </strong>file as we look at the agent lifecycle in the next section, but the full options and syntax for the <strong class="source-inline">puppet.conf </strong>file can be viewed <span class="No-Break">at </span><a href="https://puppet.com/docs/puppet/latest/config_file_main.html"><span class="No-Break">https://puppet.com/docs/puppet/latest/config_file_main.html</span></a><span class="No-Break">.</span></p>
			<p>Puppet Server <a id="_idIndexMarker729"/>by <a id="_idIndexMarker730"/>default keeps logs at <strong class="source-inline">/var/log/puppetlabs/puppetserver </strong>in the <span class="No-Break">following files:</span></p>
			<ul>
				<li><strong class="source-inline">Puppetserver.log</strong>: This is where the primary server logs activity such as compilation errors <span class="No-Break">and warnings</span></li>
				<li><strong class="source-inline">Puppetserver-access.log</strong>: This is where requests to HTTP endpoints <span class="No-Break">are logged</span></li>
				<li><strong class="source-inline">Puppetserver_gc.log</strong>: This is where logs of garbage collection <span class="No-Break">are gathered</span></li>
			</ul>
			<p>Now that we have reviewed the Puppet server components fully, we will look at the Puppet agent configuration and lifecycle, which will show how these services are used by a client, and how to monitor and review the logging of <span class="No-Break">a cycle.</span></p>
			<h1 id="_idParaDest-198"><a id="_idTextAnchor264"/>The Puppet agent-to-server lifecycle</h1>
			<p>This section <a id="_idIndexMarker731"/>will look at how the Puppet agent makes requests to the Puppet server components we have run through and how it secures its communications before requesting configuration to enforce from the Puppet servers. It should be noted the Puppet servers themselves also contain <span class="No-Break">Puppet agents.</span></p>
			<p>The installation of Puppet agents is detailed at <a href="https://puppet.com/docs/puppet/latest/install_agents.html#install_agents ">https://puppet.com/docs/puppet/latest/install_agents.html#install_agents </a>for open source and <a href="https://puppet.com/docs/pe/2021.7/installing_agents.html#installing_agents ">https://puppet.com/docs/pe/2021.7/installing_agents.html#installing_agents </a>for PE. Integrating this install with your server deployment workflow and ensuring the necessary configuration is placed at <strong class="source-inline">/etc/puppetlab/puppet.conf </strong>is critical <span class="No-Break">for automation.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">The <strong class="source-inline">puppet_conf </strong>module provides tasks to manage Puppet configuration <span class="No-Break">files (</span><a href="https://forge.puppet.com/modules/puppetlabs/puppet_conf"><span class="No-Break">https://forge.puppet.com/modules/puppetlabs/puppet_conf</span></a><span class="No-Break">).</span></p>
			<p>Most of the <a id="_idIndexMarker732"/>settings will depend on your environment setup, but for most environments, the defaults will be taken with the critical setting of ensuring that the server setting in the <strong class="source-inline">agent</strong> section is set so that the agent knows which Puppet server to contact – open source Puppet or PE-Puppet. The PE service can then be started under the root user. This will contact the Puppet server every 30 minutes by default or can be triggered by running the <strong class="source-inline">puppet agent -</strong><span class="No-Break"><strong class="source-inline">t </strong></span><span class="No-Break">command.</span></p>
			<p><span class="No-Break"><em class="italic">Figure 10</em></span><em class="italic">.3 </em>shows the workflow of this Puppet certificate process as the client ensures it has the signed SSL certificate to ensure secure communication with the <span class="No-Break">Puppet server:</span></p>
			<div>
				<div id="_idContainer046" class="IMG---Figure">
					<img src="image/B18492_10_03.jpg" alt="Figure 10.3 – Puppet client certificate workflow"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.3 – Puppet client certificate workflow</p>
			<p>The first step is <a id="_idIndexMarker733"/>to validate the certificates. In the <strong class="source-inline">ssl </strong>directory titled <strong class="source-inline">/etc/puppetlabs/puppet/ssl</strong>, the following files will already exist or be created in <span class="No-Break">this process:</span></p>
			<ul>
				<li><strong class="source-inline">private_keys/&lt;certificate_name&gt;.pem</strong>: The private key used to create <span class="No-Break">a CSR</span></li>
				<li><strong class="source-inline">certs/&lt;certificate_name&gt;.pem</strong>: The signed certificate returned for <span class="No-Break">this client</span></li>
				<li><strong class="source-inline">certs/ca.pem</strong>: A copy of the CA certificate sent from the <span class="No-Break">Puppet server</span></li>
				<li><strong class="source-inline">crl.pem</strong>: The CRL from the <span class="No-Break">Puppet server</span></li>
				<li><strong class="source-inline">certificate_requests/&lt;certificate_name&gt;.pem</strong>: The CSR to be sent to the Puppet server, which is deleted once a signed certificate <span class="No-Break">is received</span></li>
			</ul>
			<p>In addition to this directory, it is possible to create a  <strong class="source-inline">/etc/puppetlabs/puppet/csr_attributes.yaml </strong>file and include the trusted facts to be created in the CSR. This will cause the trusted facts to be included in the certificate for the client when the CSR is signed by the <span class="No-Break">Puppet server.</span></p>
			<p>Using trusted facts can be useful to ensure hard classification information is not changed, such as a production server being reclassified for development, or the role being changed, since both could result in lower levels of security. The <strong class="bold">organization ID </strong>(<strong class="bold">OID</strong>) numbers<a id="_idIndexMarker734"/> translate into names, which can be reviewed at <a href="https://puppet.com/docs/puppet/latest/ssl_attributes_extensions.html">https://puppet.com/docs/puppet/latest/ssl_attributes_extensions.html</a>. This file must exist before the CSR is created; otherwise, the only way to change the CSR or certificate is to <span class="No-Break">start again.</span></p>
			<p>As <span class="No-Break"><em class="italic">Figure 10</em></span><em class="italic">.3 </em>shows, if a private key doesn’t exist, the client makes a new key before checking for local copies of <strong class="source-inline">ca.pem </strong>and <strong class="source-inline">CRL.pem</strong>, making a request to the server, and downloading if either is absent. The next step is to then check whether a signed certificate exists and request it from the client if it does not. If a signed client certificate exists, it can continue to request node data; otherwise, it will create a CSR file and send it to the primary server. If the <strong class="source-inline">waitcert </strong>setting is enabled in <strong class="source-inline">puppet.conf</strong>, the client will then wait for the CSR to be signed by the server and check the status with the primary server every 2 minutes On future runs, the client will present its signed certificate to the server as proof of <span class="No-Break">its identity.</span></p>
			<p>Having <a id="_idIndexMarker735"/>secured communication, the first step is to perform plugin sync from the server to the client, which ensures all facts, functions, resource types, resource providers, and Augeas lenses are downloaded to the client using the <span class="No-Break"><strong class="source-inline">file_metadata </strong></span><span class="No-Break">endpoint.</span></p>
			<p>Once this has been completed, the client runs <strong class="source-inline">facter</strong>, sends the output to the Puppet client, and requests a catalog from the Puppet server using the <strong class="source-inline">\catalog </strong>endpoint. A copy of this catalog is stored in the <strong class="source-inline">cache </strong>directory (configured using the <strong class="source-inline">vardir </strong>parameter in <strong class="source-inline">puppet.conf</strong>) on the client, which by default is <strong class="source-inline">%PROGRAMDATA%\PuppetLabs\puppet\cache\client_data\catalog\&lt;certname&gt;.json</strong>. (<strong class="source-inline">PROGRAMDATA </strong>is generally <strong class="source-inline">C:\Program Data\ </strong>on Windows and <strong class="source-inline">/opt/puppetlabs/puppet/cache/client_data/catalog/&lt;certname&gt;.json </strong>for Linux- and Unix-based systems.) The client then receives this catalog and implements the steps, enforcing the state described in the Puppet code, or if the client is set to be run in no-op mode, it will simulate the catalog. The client generates a report, which is then sent back by default to the Puppet server using the <strong class="source-inline">report </strong>endpoint. This can be configured to send the report to other report processors such as Splunk, which will be discussed in <a href="B18492_13.xhtml#_idTextAnchor321"><span class="No-Break"><em class="italic">Chapter 13</em></span></a><span class="No-Break">.</span></p>
			<p>In addition to the catalog in the <strong class="source-inline">client_data </strong>folder, several other useful files for investigation are generated in the <span class="No-Break"><strong class="source-inline">cache </strong></span><span class="No-Break">directory:</span></p>
			<ul>
				<li><strong class="source-inline">lib</strong>: This is a cache for various plugins synced by plugin sync from the <span class="No-Break">primary server.</span></li>
				<li><strong class="source-inline">facter</strong>: This will contain <span class="No-Break">custom facts.</span></li>
				<li><strong class="source-inline">facts.d</strong>: Here, external facts are cached by plugin sync from <span class="No-Break">the primary.</span></li>
				<li><strong class="source-inline">reports</strong>:  This contains the last generated <span class="No-Break">report file.</span></li>
				<li><strong class="source-inline">state</strong>: This directory contains the files and directories associated with the state of previous <span class="No-Break">Puppet runs</span><span class="No-Break">:</span><ul><li><strong class="source-inline">classes.txt</strong>: A list of classes that were included in the last <span class="No-Break">catalog applied</span></li><li><strong class="source-inline">graphs</strong>: If the <strong class="source-inline">graph</strong> option is used during a Puppet run, the generated .dot graph files of resources and dependencies will be <span class="No-Break">saved here</span></li><li><strong class="source-inline">last_run_report.yaml</strong>: This is a full report of all resources and how they were checked or changed during the <span class="No-Break">catalog enforcement</span></li><li><strong class="source-inline">resources.txt</strong>: A list of resources that were included in the last <span class="No-Break">catalog applied</span></li><li><strong class="source-inline">state.yaml</strong>: A list of all resources and when they were last checked or synced, used with features such <span class="No-Break">as </span><span class="No-Break"><strong class="source-inline">audit</strong></span></li></ul></li>
			</ul>
			<p>Several <a id="_idIndexMarker736"/>directories and files have been ignored as they are either for legacy purposes or for practices that this book does not recommend, such as <strong class="source-inline">filebucket</strong>. A full listing can be seen <span class="No-Break">at </span><a href="https://puppet.com/docs/puppet/latest/dirs_vardir.html"><span class="No-Break">https://puppet.com/docs/puppet/latest/dirs_vardir.html</span></a><span class="No-Break">.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">The cached catalog will be used in the event of the client losing communication with the Puppet infrastructure to ensure it continues to enforce its last <span class="No-Break">known state.</span></p>
			<p>The last step of the agent-to-server cycle is to send the event report to the Puppet Server. These reports will reflect events of what happened for each resource in the catalog. These events can have one of the <span class="No-Break">following states</span><span class="No-Break">:</span></p>
			<ul>
				<li>Failure –  This will be an event with errors in applying the catalog or issues such as dependencies or an issue with that <span class="No-Break">particular resource</span></li>
				<li>Corrective – The resource was in the correct state in the previous run but has had to <span class="No-Break">be corrected</span></li>
				<li>Intentional – The resource had to be created or corrected but was not in the correct state in the <span class="No-Break">previous run</span></li>
				<li>Unchanged – The resource is in the correct state and requires <span class="No-Break">no change</span></li>
			</ul>
			<p>Unchanged events are not reported in Puppet 8 by default. This change was made to reduce the store space required for storing reports. This can be changed by setting <strong class="source-inline">exclude_unchanged_resources=false </strong>in each agent's <span class="No-Break"><strong class="source-inline">puppet.conf</strong></span><span class="No-Break"> file.</span></p>
			<p>The report <a id="_idIndexMarker737"/>events will also reflect what mode the client agent is running or whether a resource is set to be applied differently from the client. While the same event states still apply, each event will report if the event took place in execution mode or in no-op mode. As was previously discussed in <a href="B18492_03.xhtml#_idTextAnchor048"><span class="No-Break"><em class="italic">Chapter 3</em></span></a><em class="italic">, </em>no-op mode means the resource is only effectively tested to see whether the resource will need to be changed to meet its declared state. In <a href="B18492_15.xhtml#_idTextAnchor359"><span class="No-Break"><em class="italic">Chapter 15</em></span></a>, we will discuss how this can be useful in heritage envionments where we want to see how big the configuration drift is and choose a progressive approach to get there to avoid causing issues on <span class="No-Break">production systems.</span></p>
			<p>In terms of accessing these reports, we will see in <a href="B18492_13.xhtml#_idTextAnchor321"><span class="No-Break"><em class="italic">Chapter 13</em></span></a><em class="italic"> </em>how report processors can be used to send them to third-party tools and in <a href="B18492_14.xhtml#_idTextAnchor340"><span class="No-Break"><em class="italic">Chapter 14</em></span></a><em class="italic"> </em>how Puppet Enterprise provides an event viewer interface as part of its <span class="No-Break">graphical console.</span></p>
			<h2 id="_idParaDest-199"><a id="_idTextAnchor265"/>Lab – monitoring certificate signing logging</h2>
			<p>To <a id="_idIndexMarker738"/>better understand the process, we will now describe how we can monitor the process of a Puppet <a id="_idIndexMarker739"/>run by removing the certificates of our node and re-registering. During the registration, we will monitor the logs to see the API requests made through this process and note the steps of the process. Here are <span class="No-Break">the steps:</span></p>
			<ol>
				<li>Open SSH terminal sessions to the Linux client and two separate SSH terminal sessions to the primary <span class="No-Break">Puppet server.</span></li>
				<li>On the Linux client, run the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">puppet ssl clean</strong></pre></li>
				<li>On one of the server sessions, run <strong class="source-inline">puppetserver ca clean --certname &lt;instance name&gt; </strong>(note that this should be the certificate name, which can be checked via <strong class="source-inline">puppet config print certname </strong>on <span class="No-Break">the node).</span></li>
				<li>On the Linux client, move the <strong class="source-inline">ssl </strong>directory to a backed-up location using the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">mv /etc/puppetlabs/puppet/ssl /etc/puppetlabs/puppet/ssl.old</strong></pre></li>
				<li>On<a id="_idIndexMarker740"/> one of <a id="_idIndexMarker741"/>the Puppet server’s sessions, run <strong class="source-inline">tail -f /var/log/puppetlabs/puppetserver/puppetserver-access.log</strong>, and on the other, run <strong class="source-inline">tail -</strong><span class="No-Break"><strong class="source-inline">f /var/log/puppetlabs/puppetserver/puppetserver.log</strong></span><span class="No-Break">.</span></li>
				<li>On the node, run <strong class="source-inline">puppet agent -t </strong>and see the calls on the Puppet <span class="No-Break">server sessions.</span></li>
				<li>On the web console, under the <strong class="bold">Certificates </strong>section, select the <strong class="bold">Unsigned </strong>tab, sign the certificate request, and then run <strong class="source-inline">puppet agent –t </strong>on the client. Note the new calls on the server in the <strong class="source-inline">access.log </strong>and <strong class="source-inline">puppetserver.log </strong>files and how this relates to the steps discussed in <span class="No-Break">this section.</span></li>
				<li>View the catalog received for the client and investigate the other files in <span class="No-Break">the cache.</span></li>
			</ol>
			<p class="callout-heading">Hint</p>
			<p class="callout">Using a tool such as <strong class="source-inline">jq </strong>can make viewing JSON much <span class="No-Break">easier (</span><a href="https://stedolan.github.io/jq/download/"><span class="No-Break">https://stedolan.github.io/jq/download/</span></a><span class="No-Break">).</span></p>
			<p>To view an example output of logging for this lab, see the <span class="No-Break">following files:</span></p>
			<p><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_access_log_extract">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_access_log_extract</a> shows the access logs with comments explaining <span class="No-Break">the output</span></p>
			<p><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_server_log_extract">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_server_log_extract</a> shows the Puppet server log with <a id="_idIndexMarker742"/>comments explaining <span class="No-Break">the output</span></p>
			<p><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_client_terminal.txt">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_client_terminal.txt</a> shows the client terminal and <span class="No-Break">commands entered</span></p>
			<p><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_server_terminal.txt">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/puppet_server_terminal.txt</a> shows the server terminal and <span class="No-Break">commands entered</span></p>
			<h1 id="_idParaDest-200"><a id="_idTextAnchor266"/>PuppetDB and PostgreSQL</h1>
			<p>PuppetDB <a id="_idIndexMarker743"/>allows for the collection of Puppet data and advanced features such as exported resources. In open source Puppet, it is entirely optional, while PE installs PuppetDB by default. The following is kept <span class="No-Break">by PuppetDB:</span></p>
			<ul>
				<li>The last facts from <span class="No-Break">the nodes</span></li>
				<li>The last catalog compiled for <span class="No-Break">each node</span></li>
				<li>14 days (default) of event reports for <span class="No-Break">each node</span></li>
				<li><span class="No-Break">Exported resources</span></li>
			</ul>
			<p>PuppetDB is a Clojure frontend application running on a JVM, using PostgreSQL as a backend database. This common architecture is where the backend database just provides the tables, and the frontend database contains the application objects, giving some key advantages compared to a single database. It eases the updating process of PuppetDB since the actual data can be left in the backend table, and it also allows great scalability—as we will see in the last section of this chapter, <em class="italic">Scaling with compilers</em>—where PuppetDB can be scaled horizontally by running PuppetDB on many compiler servers, as a result reducing the load on the primary server <span class="No-Break">PuppetDB service.</span></p>
			<p>Information on the installation <a id="_idIndexMarker744"/>and configuration of PuppetDB is provided at <a href="https://forge.puppet.com/modules/puppetlabs/puppetdb">https://forge.puppet.com/modules/puppetlabs/puppetdb</a>. PuppetDB is likely to be included in any automation you choose and is part <span class="No-Break">of PE.</span></p>
			<p>PostgreSQL<a id="_idIndexMarker745"/> creates a <strong class="source-inline">pe-postgres </strong>user for PE or a <strong class="source-inline">postgres </strong>user for open source Puppet, which is created as a user to run the PostgreSQL database. This user will use a <strong class="source-inline">nologin </strong>shell and own relevant files for running Postgres. The following directories are used <span class="No-Break">by PostgreSQL:</span></p>
			<ul>
				<li><strong class="source-inline">/opt/puppetlabs/server/apps/postgresql/{version}</strong>: To install the <span class="No-Break">database application</span></li>
				<li><strong class="source-inline">/opt/puppetlabs/server/data/postgresql/{version}</strong>: To contain the data files of <span class="No-Break">the database</span></li>
				<li><strong class="source-inline">/var/log/puppetlabs/postgresql/{version}</strong>: To contain the logs of <span class="No-Break">the database</span></li>
			</ul>
			<p>PuppetDB <a id="_idIndexMarker746"/>creates a <strong class="source-inline">pe-puppetdb </strong>user for PE or a <strong class="source-inline">puppetdb </strong>user for open source Puppet, which is created as a user to run the PuppetDB database under with a <strong class="source-inline">nologin </strong>shell and to own the relevant file for running PuppetDB. As PuppetDB is a Clojure application running on the JVM; it is very similar to puppet web server in its structure with a handler mounted at a <strong class="source-inline">/pdb </strong>endpoint and an <strong class="source-inline">auth.conf </strong>file defining who can access this endpoint. The following directories are used by PuppetDB, and some key files <a id="_idIndexMarker747"/><span class="No-Break">are highlighted:</span></p>
			<ul>
				<li><strong class="source-inline">/etc/puppetlabs/puppetdb</strong>: This directory contains configuration files for PuppetDB, including <span class="No-Break">the following:</span><ul><li><strong class="source-inline">bootstrap.conf</strong>: The <strong class="source-inline">bootstrap.conf</strong> file the lists services that should be started in the <span class="No-Break">Trapperkeeper framework</span></li></ul></li>
				<li><strong class="source-inline">/etc/puppetlabs/puppetdb/conf.d</strong>: This directory contains configuration files in an <span class="No-Break"><strong class="source-inline">ini</strong></span><span class="No-Break"> format:</span><ul><li><strong class="source-inline">auth.conf</strong>: Configures authorization for who can access the endpoints <span class="No-Break">made available</span></li><li><strong class="source-inline">routing.ini</strong>: Configures which handlers should be made available <span class="No-Break">at endpoints</span></li></ul></li>
				<li><strong class="source-inline">/opt/puppetlabs/server/apps/puppetdb</strong>: This directory contains the application binaries <span class="No-Break">for PuppetDB</span></li>
				<li><strong class="source-inline">/opt/puppetlabs/server/data/puppetdb</strong>: This directory contains the data <span class="No-Break">of PuppetDB</span></li>
			</ul>
			<p>It is beyond the scope of this book to look at the in-depth configuration of <strong class="source-inline">PuppetDB</strong>, but you can refer to <a href="https://puppet.com/docs/puppetdb/latest/configure.html ">https://puppet.com/docs/puppetdb/latest/configure.html </a>for more information. However, in <a href="B18492_13.xhtml#_idTextAnchor321"><span class="No-Break"><em class="italic">Chapter 13</em></span></a>, we will look in more depth at how to monitor, review, and tune <a id="_idIndexMarker748"/>PuppetDB and PostgreSQL performance and how modules such as <a href="https://forge.puppet.com/modules/puppetlabs/pe_databases">https://forge.puppet.com/modules/puppetlabs/pe_databases</a> can assist <span class="No-Break">with maintenance.</span></p>
			<p>For now, we <a id="_idIndexMarker749"/>will review how the data can be accessed by using PQL with HTTP calls to the <strong class="source-inline">/pdb </strong>endpoint or via the <strong class="source-inline">puppet query </strong>command line to make calls to <span class="No-Break">the endpoint.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">The <strong class="bold">Abstract Syntax Tree </strong>(<strong class="bold">AST</strong>) query <a id="_idIndexMarker750"/>language is also available as a format to use for queries. However, with PQL available, it has little use now but can be reviewed <span class="No-Break">at </span><a href="https://www.puppet.com/docs/puppetdb/8/api/query/v4/ast.html"><span class="No-Break">https://www.puppet.com/docs/puppetdb/8/api/query/v4/ast.html</span></a><span class="No-Break">.</span></p>
			<p>PuppetDB is structured into entities to allow for accessing different types of data. Here is a list of each entity and a brief description of what the <span class="No-Break">endpoint contains:</span></p>
			<ul>
				<li><strong class="source-inline">aggregate_event_counts</strong>: Aggregate counts of the <span class="No-Break"><strong class="source-inline">event_counts </strong></span><span class="No-Break">entity</span></li>
				<li><strong class="source-inline">catalogs</strong>: The catalogs stored for <span class="No-Break">each node</span></li>
				<li><strong class="source-inline">edges</strong>: Edges are relationship information in catalogs such as <em class="italic">contains </em><span class="No-Break">or </span><span class="No-Break"><em class="italic">requires</em></span></li>
				<li><strong class="source-inline">environments</strong>: The environments known <span class="No-Break">to PuppetDB</span></li>
				<li><strong class="source-inline">event_counts</strong>: Event counts about various resources <span class="No-Break">in reports</span></li>
				<li><strong class="source-inline">events</strong>: Events reflect the actions performed for a resource returned by <span class="No-Break">a report</span></li>
				<li><strong class="source-inline">facts</strong>: The facts returned for <span class="No-Break">each node</span></li>
				<li><strong class="source-inline">fact_contents</strong>: This entity is structured to access fact content <span class="No-Break">more easily</span></li>
				<li><strong class="source-inline">fact_names</strong>: All known <span class="No-Break">fact names</span></li>
				<li><strong class="source-inline">fact_paths</strong>: Similar to the <strong class="source-inline">fact_names </strong>entity but provides further granularity for <span class="No-Break">structured facts</span></li>
				<li><strong class="source-inline">nodes</strong>: <span class="No-Break">Node information</span></li>
				<li><strong class="source-inline">producers</strong>: Producers <a id="_idIndexMarker751"/>are the servers that compiled the catalog and sent <span class="No-Break">the report</span></li>
				<li><strong class="source-inline">reports</strong>: Reports contain the outcome of applying <span class="No-Break">a catalog</span></li>
				<li><strong class="source-inline">resources</strong>: Resource information <span class="No-Break">in catalogs</span></li>
			</ul>
			<p>To begin looking at PQL queries, the simplest way is to return all the data in an entity. This can be done by simply listing an entity name and empty curly braces. For example, to return all node data, it would be <strong class="source-inline">nodes {}</strong>; to search for nodes with particular parameters within the curly braces, we use attribute names and the value they should equal (<strong class="source-inline">=</strong>), contain (<strong class="source-inline">~</strong>), be less than (<strong class="source-inline">&lt;</strong>), or greater than (<strong class="source-inline">&gt;</strong>). For example, to return nodes whose last report status was unchanged, the query would be <strong class="source-inline">nodes { latest_report_status = "</strong><span class="No-Break"><strong class="source-inline">unchanged"}</strong></span><span class="No-Break">.</span></p>
			<p>We will not list the output for any of these queries as they can be verbose, but you will try to make examples in your lab at the end of <span class="No-Break">this section.</span></p>
			<p>These attribute statements can be further negated with <strong class="source-inline">!</strong>, chained with <strong class="source-inline">and</strong>/<strong class="source-inline">or</strong>, and parenthesized with brackets <strong class="source-inline">() </strong>to contain different statements. For example, to make a more complicated query to find whether a particular file was declared with the wrong permissions, we could run this <span class="No-Break">PQL query</span><span class="No-Break">:</span></p>
			<pre class="source-code">
resources { (type = "File" and title = "/etc/motd") and ! ( parameters.mode = "0644" and parameters.owner ="root") }</pre>
			<p>On the command line, this can also be run via the <strong class="source-inline">puppet query resource {'latest_report_status = "</strong><span class="No-Break"><strong class="source-inline">unchanged"}'</strong></span><span class="No-Break">.</span></p>
			<p>PuppetDB queries can <a id="_idIndexMarker752"/>also be used in Puppet code with the PuppetDB function. Here’s <span class="No-Break">an example:</span></p>
			<pre class="source-code">
$changed_nodes = puppetdb_query(node[certname]{ resource {'latest_report_status = "unchanged"}}) .map |$value| { $value["certname"] }
notify {"Nodes changed":
    message =&gt; "The following nodes changed on their last run ${join($changed_nodes, ', ')}",
}</pre>
			<p>In all these examples, it has been assumed certificates are set up for secure SSL communication either directly on Puppet infrastructure or with clients running the query. If using default locations, the <strong class="source-inline">puppet query </strong>command picks up the certificates automatically but can also be set <span class="No-Break">like so:</span></p>
			<pre class="source-code">
<strong class="bold">puppet query '&lt;PQL query&gt;' \</strong>
<strong class="bold">  --urls https://puppetdb.example.com:8081 \</strong>
<strong class="bold">  --cacert /etc/puppetlabs/puppet/ssl/certs/ca.pem \</strong>
<strong class="bold">  --cert /etc/puppetlabs/puppet/ssl/certs/&lt;certname_of_local_host&gt;..pem \</strong>
<strong class="bold">  --key /etc/puppetlabs/puppet/ssl/private_keys/&lt;certname_of_local_host&gt;..pem</strong></pre>
			<p>Web points can also be accessed via <strong class="source-inline">curl </strong>or equivalent commands, <span class="No-Break">like so:</span></p>
			<pre class="source-code">
<strong class="bold">curl -X GET &lt;fqdn_of_puppetDB_host&gt;https://&lt;fqdn_of_puppetDB_host&gt;:8081/pdb/query/v4\</strong>
<strong class="bold">  --tlsv1 \</strong>
<strong class="bold">  --cacert /etc/puppetlabs/puppet/ssl/certs/ca.pem \</strong>
<strong class="bold">  --cert /etc/puppetlabs/puppet/ssl/certs/&lt;certname_of_local_host&gt;.pem \</strong>
<strong class="bold">  --key /etc/puppetlabs/puppet/ssl/private_keys/&lt;cert_name_of_local_host.pem \</strong>
<strong class="bold"><a id="_idTextAnchor267"/>  --data-urlencode 'query=&lt;PQL query&gt;'</strong></pre>
			<p>To allow queries to <a id="_idIndexMarker753"/>be made directly from a desktop or other nodes, the Puppet client tools can be used. The setup instructions for installing on Open Source Puppet are detailed at <a href="https://puppet.com/docs/puppetdb/latest/pdb_client_tools.html">https://puppet.com/docs/puppetdb/latest/pdb_client_tools.html</a> and Puppet Enterprise has instructions <span class="No-Break">at </span><a href="https://www.puppet.com/docs/pe/2021.7/installing_pe_client_tools.html"><span class="No-Break">https://www.puppet.com/docs/pe/2021.7/installing_pe_client_tools.html</span></a><span class="No-Break">.</span></p>
			<p>Alternatively, the SSL authentication can be deactivated to allow unauthenticated queries following the instructions at  <a href="https://puppet.com/docs/puppetdb/latest/configure.html#jetty-http-settings">https://puppet.com/docs/puppetdb/latest/configure.html#jetty-http-settings</a>. This book would strongly advise against this as it would open the data for anyone to access on <span class="No-Break">your network.</span></p>
			<p>In this section, we showed some of entities and queries it was possible to use with PQL. It would be impractical to go through all the possible options available to these entities and the range of options available to PQL, but the full details can be seen in the documentation at  <a href="https://puppet.com/docs/puppetdb/latest/api/query/v4/entities.html">https://puppet.com/docs/puppetdb/latest/api/query/v4/entities.html</a>. Additionally further examples of PQL queries can be seen in the documentation at <a href="https://puppet.com/docs/puppetdb/latest/api/query/examples-pql.html">https://puppet.com/docs/puppetdb/latest/api/query/examples-pql.html</a>, and the Vox Pupuli community is building useful examples on its web pages <span class="No-Break">at </span><a href="https://voxpupuli.org/docs/pql_queries/"><span class="No-Break">https://voxpupuli.org/docs/pql_queries/</span></a><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-201"><a id="_idTextAnchor268"/>Lab – querying PuppetDB</h2>
			<p>SSH to<a id="_idIndexMarker754"/> the primary server and query PuppetDB for the <span class="No-Break">following information:</span></p>
			<ul>
				<li>List the memory size of all the compiler servers (<em class="italic">hint</em>: compiler servers all have a trusted fact and Facter has a <span class="No-Break">memory fact)</span></li>
				<li>List all the services being enforced on the <span class="No-Break">Puppet server</span></li>
				<li>List the<a id="_idIndexMarker755"/> start and end times of the latest report of <span class="No-Break">each server</span></li>
			</ul>
			<p>Example answers can be found <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/PQL_samples_answers.txt"><span class="No-Break">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch10/PQL_samples_answers.txt</span></a><span class="No-Break">.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Be careful with these queries in production systems working at scale; some endpoints such as reports could contain a lot of data, and a query may put a lot of stress and load on <span class="No-Break">a system.</span></p>
			<h1 id="_idParaDest-202"><a id="_idTextAnchor269"/>Scaling with compilers</h1>
			<ol>
				<li>The <a id="_idIndexMarker756"/>review of Puppet platform components so far assumes that all components are present on a single primary server. However, as the number of managed nodes increases, it becomes impractical for a single server to handle them. According to Puppet’s documentation, a primary server can manage up to 2,500 clients on default settings. To handle the growing number of nodes, Puppet uses horizontal scaling, which involves using Puppet compile servers. In <span class="No-Break"><em class="italic">Figure 10</em></span><em class="italic">.4</em>, a subset of primary services is shown to be moved onto compile servers. These servers can be configured in a round-robin selection in the client’s configuration file or placed behind a load balancer. This enables multiple nodes to work together to compile catalogs while still allowing certain services to run on the primary server. According to Puppet’s documentation, with the default compiler settings, up to 3,000 clients can be served <span class="No-Break">per compiler:</span></li>
			</ol>
			<div>
				<div id="_idContainer047" class="IMG---Figure">
					<img src="image/B18492_10_04.jpg" alt="Figure 10.4 – Puppet compiler services"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.4 – Puppet compiler services</p>
			<p>A compile server <a id="_idIndexMarker757"/>hosts a subset of services that are present on the primary server, such as Puppet Server and PuppetDB. This enables remote completion and synchronization of catalog compilation requests, thereby increasing the number of JRuby instances required for <span class="No-Break">compiling catalogs.</span></p>
			<ol>
				<li>The most widely used approach for directing client requests to compile servers is to utilize a hardware - or cloud-based load balancer. As there are several load balancer options available, Puppet does not provide explicit instructions on configuration. However, it recommends using the <strong class="source-inline">/status/v1/simple </strong>endpoint to check the health of compile servers. If the load balancer does not support HTTP health checks, checking whether the host is listening for TCP connections on port <strong class="source-inline">8140 </strong>can provide a <span class="No-Break">limited check.</span></li>
				<li>There are alternatives to a load balancer, such as using DNS SRV records, which is detailed at <a href="https://puppet.com/docs/puppet/latest/server/scaling_puppet_server.html#using-dns-srv-records">https://puppet.com/docs/puppet/latest/server/scaling_puppet_server.html#using-dns-srv-records</a>, or using a DNS entry with round-robin settings, as detailed at <a href="https://puppet.com/docs/puppet/latest/server/scaling_puppet_server.html#using-round-robin-dns">https://puppet.com/docs/puppet/latest/server/scaling_puppet_server.html#using-round-robin-dns</a>, but as these tend to be much less frequently used, we will not <a id="_idIndexMarker758"/>go into detail in <span class="No-Break">this book.</span></li>
			</ol>
			<p class="callout-heading">Note</p>
			<p class="callout">In the <strong class="source-inline">puppet.conf </strong>file, it is possible to add a list of servers in the client server value to contact but this list would work only in the event of failures and would not try to balance <span class="No-Break">out connections.</span></p>
			<ol>
				<li value="3">With compile servers, the CA remains on a single Puppet primary server and is referred back to when clients send their CSR or certificates <span class="No-Break">for checking.</span></li>
				<li>As stated at the beginning of the chapter, we will refrain from delving into the installation process in detail, as it would not add much value to Puppet’s own instructions, available at <a href="https://puppet.com/docs/puppet/latest/server/scaling_puppet_server.html ">https://puppet.com/docs/puppet/latest/server/scaling_puppet_server.html </a>for open source and <a href="https://puppet.com/docs/pe/2021.7/installing_compilers.html ">https://puppet.com/docs/pe/2021.7/installing_compilers.html </a>for PE. However, it is essential to note that compile servers may require <strong class="source-inline">dns_alt_names </strong>to be added to their <strong class="source-inline">puppet.conf </strong>file if load balancers are being used in TCP proxying mode or a DNS round-robin method. This is necessary to enable all server names that may be used in requests through the <span class="No-Break">load balancer.</span></li>
				<li>Even with a load balancer enabled, it is possible to just target compile servers directly by running <strong class="source-inline">puppet agent -t server=&lt;server to </strong><span class="No-Break"><strong class="source-inline">send request&gt;</strong></span><span class="No-Break">.</span></li>
				<li>In <a href="B18492_13.xhtml#_idTextAnchor321"><span class="No-Break"><em class="italic">Chapter 13</em></span></a>, we will provide more detailed information on how to monitor and manage server settings for scalability, and in <a href="B18492_14.xhtml#_idTextAnchor340"><span class="No-Break"><em class="italic">Chapter 14</em></span></a>, we will discuss Puppet’s reference<a id="_idIndexMarker759"/> architectures for achieving scalability. However, it is important to note that there may be latency issues if compile servers are located too far away from the primary server. Therefore, it is recommended to keep them within the same region in cloud terms, as per <span class="No-Break">best practices.</span></li>
			</ol>
			<h2 id="_idParaDest-203"><a id="_idTextAnchor270"/>Lab – viewing compiler and load balancer configuration</h2>
			<p>The deployed<a id="_idIndexMarker760"/> lab environment consists of three compile servers. You can view the reports they are compiling and how pecdm configured the load balancer, <span class="No-Break">as</span><span class="No-Break"><a id="_idIndexMarker761"/></span><span class="No-Break"> follows:</span></p>
			<ol>
				<li>Log in to the web console and review the report runs of the Puppet instance server. In the <strong class="bold">Metrics </strong>section of a report, look for the <strong class="bold">Report submitted by </strong>section and note that this may vary in different reports. If there are few reports available, enter the <strong class="bold">Jobs </strong>section and run Puppet several times on your instance node to generate <span class="No-Break">more reports.</span></li>
				<li>View how PECDM created the Azure load balancer in the Terraform module <span class="No-Break">at </span><a href="https://github.com/puppetlabs/terraform-azure-pe_arch/blob/main/modules/loadbalancer/main.tf"><span class="No-Break">https://github.com/puppetlabs/terraform-azure-pe_arch/blob/main/modules/loadbalancer/main.tf</span></a><span class="No-Break">.</span></li>
			</ol>
			<h1 id="_idParaDest-204"><a id="_idTextAnchor271"/>Summary</h1>
			<p>In this chapter, we learned about the services provided by the Puppet server and how the embedded web server attaches handlers to mount points, which can then be requested via HTTP requests <span class="No-Break">to endpoints.</span></p>
			<p>It was shown that the <strong class="source-inline">/puppet </strong>endpoint provides services for configuration requests and how indirectors or environments can request specific components such as requesting a catalog from a server. The <strong class="source-inline">/puppet-ca </strong>endpoint similarly used indirectors to allow for requests to the CA. The <strong class="source-inline">/puppet-admin-api </strong>endpoint was then shown to allow for clearing the environment cache and JRuby instances as more advanced <span class="No-Break">administrative actions.</span></p>
			<p>It was then shown how Puppet creates a CA server with a root CA and an intermediate CA to sign or can run in legacy mode with a single combined CA. The options for using externally provided certificates were then discussed. The process of signing certificate requests was shown, with the <strong class="source-inline">puppetserver certificate </strong>command for managing certificates and requests and the <strong class="source-inline">puppet ssl </strong>command for managing agent certificate management. It was then shown how this process could be automated with auto signing, which could auto-sign everything, based on naming or based on a script running and viewing the <span class="No-Break">certificate request.</span></p>
			<p>JRuby interpreters were discussed, showing how JRuby is an implementation of Ruby on Java and capable of running Puppet’s Ruby components, such as compiling Puppet code, in a scalable and <span class="No-Break">concurrent way.</span></p>
			<p>An overview of the user, service, and configuration files and logging was shown, examining the server side of <strong class="source-inline">puppet.conf</strong> and how to configure and view settings in the file and defaults using the <strong class="source-inline">puppet </strong><span class="No-Break"><strong class="source-inline">config </strong></span><span class="No-Break">commands.</span></p>
			<p>Having reviewed the components of Puppet Server, the Puppet client lifecycle was then viewed, seeing how the agent makes CSRs to the CA and sends facts and a request for a catalog. The logs were viewed to show where requests re made and how this can be tracked through requests. It was shown how the client could be configured via <strong class="source-inline">puppet.conf </strong>and how additional information could be added to <span class="No-Break">the CSR.</span></p>
			<p>PuppetDB and PostgreSQL were then explored as a frontend/backend database architecture that can store reports generated from applying Puppet catalogs along with the latest facts and events from nodes. We reviewed the file directories and logging locations and then saw how PuppetDB could be queried on the API, command line, and Puppet code <span class="No-Break">using PQL.</span></p>
			<p>Compilers were then shown to be able to allow Puppet Server to scale horizontally by allowing Puppet Server and the PuppetDB services to be put onto multiple servers, which could be load-balanced <span class="No-Break">for</span><span class="No-Break"> clients.</span></p>
			<p>In the next chapter, we will show how Puppet classifies clients requesting catalog compilations so that it knows which version of code to apply and which classes. We will show how environments allow multiple versions of code to exist on the primary server and how to use a control repo to manage the modules and versions that should <span class="No-Break">be included.</span></p>
		</div>
	</body></html>