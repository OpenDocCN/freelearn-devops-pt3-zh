- en: '14'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '14'
- en: A Brief Overview of Puppet Enterprise
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Puppet Enterprise 简要概述
- en: This chapter will give an overview of **Puppet Enterprise**, what it is, and
    what it provides compared to **Open Source Puppet**. Although the author of this
    book is a Puppet employee, this is not intended as a hard sell but to present
    where and how to use Puppet Enterprise well. It will cover the extra Enterprise
    console services in the Puppet platform, showing how code deployment, orchestrator
    service, RBAC, web console, and various other services are automatically configured
    and work with each other. This will assist in understanding how Puppet Enterprise
    differs from Open Source Puppet and the preconfigured and built-in features that
    would need to be manually created in Open Source Puppet. Supported architectural
    patterns will be highlighted that help to understand how to deploy and scale Puppet
    infrastructure using Puppet Enterprise packaging and modules to automatically
    deploy these patterns. Some related projects and integrations will be discussed,
    along with how they fit into the Puppet Enterprise environment.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将概述**Puppet Enterprise**，它是什么以及与**开源 Puppet**相比提供了哪些功能。尽管本书的作者是 Puppet 员工，但本章并非强行推销，而是介绍如何有效地使用
    Puppet Enterprise。它将介绍 Puppet 平台中的额外企业控制台服务，展示代码部署、编排服务、RBAC、Web 控制台以及其他各种服务如何自动配置并协同工作。这将有助于理解
    Puppet Enterprise 与开源 Puppet 的区别，以及在开源 Puppet 中需要手动创建的预配置和内建功能。将重点介绍支持的架构模式，帮助理解如何使用
    Puppet Enterprise 包装和模块自动部署这些模式，从而部署和扩展 Puppet 基础设施。还将讨论一些相关项目和集成，以及它们如何融入 Puppet
    Enterprise 环境。
- en: 'In this chapter, we’re going to cover the following main topics:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下主要内容：
- en: What is Puppet Enterprise?
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 什么是 Puppet Enterprise？
- en: Exploring the Puppet Enterprise console and services
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 探索 Puppet Enterprise 控制台和服务
- en: Using Bolt with Puppet Enterprise
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 Puppet Enterprise 中使用 Bolt
- en: Automating deployment and reference architectures
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自动化部署和参考架构
- en: Puppet Enterprise-related projects and tooling
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Puppet Enterprise 相关项目和工具
- en: Lab—Puppet Enterprise extensions and configuration
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实验—Puppet Enterprise 扩展与配置
- en: Technical requirements
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'Clone the control repo from [https://github.com/puppetlabs/control-repo](https://github.com/puppetlabs/control-repo)
    to your `controlrepo-chapter14` GitHub account and update the `Puppetfile` file
    in this repo: [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile).'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 从 [https://github.com/puppetlabs/control-repo](https://github.com/puppetlabs/control-repo)
    克隆控制仓库到你的 `controlrepo-chapter14` GitHub 账户，并更新此仓库中的 `Puppetfile` 文件：[https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile)。
- en: 'Build a large cluster with a replica with three compilers and three clients
    by downloading the `params.json` file from [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json)and
    updating it with the location of your control repo and your SSH key for the control
    repo. Then, run the following command from your `pecdm` directory:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 通过下载来自 [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json)
    的 `params.json` 文件，并根据控制仓库的位置以及控制仓库的 SSH 密钥进行更新，构建一个带有副本的集群，包含三个编译器和三个客户端。然后，从
    `pecdm` 目录运行以下命令：
- en: '[PRE0]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: What is Puppet Enterprise?
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 什么是 Puppet Enterprise？
- en: A common misconception when discussing Puppet Enterprise is that features of
    the product are held back and not available for open source users. The aim of
    Puppet Enterprise isn’t to limit what is available to open source users but to
    instead provide value to customers who want to consume Puppet easily and focus
    on gaining the value of configuration management by putting less of their own
    development and automation work into the platform itself.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在讨论 Puppet Enterprise 时，常见的误解是该产品的某些功能被限制，无法为开源用户提供。Puppet Enterprise 的目标并非限制开源用户可用的功能，而是为那些希望轻松使用
    Puppet 的客户提供价值，使他们能够通过减少自身在平台上的开发和自动化工作，专注于获得配置管理的价值。
- en: Puppet achieves this by ensuring that in Enterprise, the packing of components
    is versioned and tested together with an automated installation script and module,
    reducing the effort required by users managing the infrastructure. Puppet Enterprise
    works on two different types of releases. Puppet Enterprise, which works on an
    *xxxx.y* pattern, is normally updated every 3 months, which at the time of writing
    would be `2023.0`. This version is planned to upgrade to Puppet 8.x versions in
    2023.3 and will receive new features throughout its lifetime. This release is
    recommended for users who want to access the latest features and fixes and will
    require a regular update pattern. The other type of release is the **long-term
    support** (**LTS**) version; this follows an *xxxx.y.z* pattern. This branch is
    normally updated every 3 months, but the updates would only include fixes and
    not new features. The LTS versions last 2 years and have an overlap of 6 months
    with the next major *xxxx* release, so the current 2021.7.z LTS will end mainstream
    support on August 31, 2024, at which point overlap support will continue until
    February 28, 2025, after which users should migrate to whichever version of Puppet
    they require. 2023.y becomes the new LTS release to continue to have support from
    Puppet. The two running Puppet Enterprise versions generally mirror two Open Source
    Puppet versions in active development. The release of 2023.0 retired Puppet 6
    and 2023 should move to Puppet 8 in version 2023.3 or shortly after.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: The most obvious feature of an Enterprise license is support, with access to
    raise support cases with teams who can review infrastructure problems and assist
    with any issues or features required for supported modules.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: Puppet also provides various professional services, such as on-site engagements
    to provide hands-on training and advice. This can lead to architecture reviews
    to understand how best to implement in your environment and to feed into processes
    that develop products and solutions such as the **Puppet Data Service** (**PDS**)
    and **Puppet Enterprise Administration Module** (**peadm**). Further, **technical
    account managers** (**TAMs**) are assigned to give you a regular point of contact
    and champion you in Puppet, supporting you in creating a success plan for your
    organization and focusing your deployment to achieve its goals.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: Puppet provides reference architectures and patterns of Puppet products to show
    how to work at different scales and implementation types. Additional applications
    built on top of the Puppet Server service allow for access control, server classification,
    code deployment, visualization, and searching of data to be completed in a standard
    way from the console. We will look at these in greater detail in the following
    section.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: Exploring the Puppet Enterprise console and services
  id: totrans-20
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'There are several additional services built into a **Puppet Enterprise primary
    server**, as shown in the following diagram:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 14.1 – Puppet Enterprise components](img/B18492_14_01.jpg)'
  id: totrans-22
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.1 – Puppet Enterprise 组件](img/B18492_14_01.jpg)'
- en: Figure 14.1 – Puppet Enterprise components
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.1 – Puppet Enterprise 组件
- en: Puppet Server
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Puppet 服务器
- en: The **Puppet** service is the same as discussed in [*Chapter 10*](B18492_10.xhtml#_idTextAnchor252),
    with the **certificate authority** (**CA**) providing a certificate signing process
    to secure communication and the Puppet agent contacting a compiler’s Puppet Server
    service to request a catalog compilation. **Facter** is used to provide a server
    profile. In *Figure 14**.1*, we opt not to show that the primary server itself
    has a Puppet Server service, and both the compiler and primary server have Puppet
    agents, which both request catalog compilations from the primary server’s Puppet
    server.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: '**Puppet** 服务与[*第 10 章*](B18492_10.xhtml#_idTextAnchor252)中讨论的相同，**证书颁发机构**
    (**CA**) 提供证书签名过程以保证通信安全，Puppet 代理联系编译器的 Puppet 服务器服务请求目录编译。 **Facter** 用于提供服务器配置文件。在
    *图 14**.1* 中，我们选择不显示主服务器本身有一个 Puppet 服务器服务，并且编译器和主服务器都有 Puppet 代理，它们都从主服务器的 Puppet
    服务器请求目录编译。'
- en: Introducing Puppet web console components
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 引入 Puppet Web 控制台组件
- en: The most obvious immediate difference of the Puppet Enterprise server is the
    **web console**, which provides the login view we have been using in our lab throughout
    this book. Several services combine to make up the console services
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise 服务器最明显的直接差异是提供我们在本书实验室中使用的登录视图的 **Web 控制台**。几个服务结合在一起形成控制台服务
- en: The console is a web frontend Jetty-based Clojure service with an NGINX server
    that acts as a reverse proxy. The NGINX server listens on port HTTPS `443` and
    redirects HTTP 80 to HTTPS. The console UI provides an aggregation and translation
    Jetty-based Clojure service to generate the correct pages and access other console
    services.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 控制台是一个基于 Jetty 的 Clojure Web 前端服务，具有充当反向代理的 NGINX 服务器。 NGINX 服务器在 HTTPS 端口 `443`
    上监听并将 HTTP 80 重定向到 HTTPS。控制台 UI 提供聚合和翻译 Jetty-based Clojure 服务以生成正确的页面并访问其他控制台服务。
- en: 'The authentication UI generates login and resets password content pages. The
    simplest way to show this is to use an example of the communication required when
    logging in, as shown in the following diagram:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 认证 UI 生成登录和重置密码内容页面。展示这一点的最简单方式是使用登录时所需的通信示例，如下图所示：
- en: '![Figure 14.2 – Steps to generate the login page](img/B18492_14_02.jpg)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.2 – 生成登录页面的步骤](img/B18492_14_02.jpg)'
- en: Figure 14.2 – Steps to generate the login page
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.2 – 生成登录页面的步骤
- en: It can be seen from the diagram that as a first step, the NGINX server receives
    a `GET` request and, after performing TLS negotiation, redirects to the console
    Jetty page. This page evaluates cookies, establishes the user is not logged in,
    and redirects to the auth/login page, which is requested from NGINX and redirected
    to the authentication UI. The authentication UI generates a login page and gets
    **Security Assertion Markup Language** (**SAML**) configuration from the RBAC
    Jetty page, and this login page is then passed back to the user.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 可以从图表中看出，作为第一步，NGINX 服务器接收 `GET` 请求，并在执行 TLS 协商后重定向到控制台 Jetty 页面。该页面评估 cookie，确认用户未登录，并重定向到
    auth/login 页面，该页面从 NGINX 请求并重定向到认证 UI。认证 UI 生成登录页面，并从 RBAC Jetty 页面获取 **安全断言标记语言**
    (**SAML**) 配置，然后将此登录页面传回用户。
- en: The **RBAC service** has users and roles to construct access policies. It allows
    for both local and remote users in Puppet Enterprise, with integration possible
    to **Lightweight Directory Access Protocol (LDAP**) and SAML services. All users
    by default are denied permission to create, edit, or view any part of Puppet Enterprise,
    and permissions are then granted via roles.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: '**RBAC 服务** 具有用户和角色来构建访问策略。它允许在 Puppet Enterprise 中使用本地和远程用户，并可以集成到 **轻量目录访问协议
    (LDAP)** 和 SAML 服务中。所有用户默认被拒绝创建、编辑或查看 Puppet Enterprise 的任何部分的权限，然后通过角色授予权限。'
- en: By default, there will be a local administrative user who acts as a superuser
    for the Puppet service and an API user for authentication for Puppet services
    to communicate within Puppet Enterprise. It cannot be used for login and only
    authenticates with certificate authentication. There is an allow list that has
    the `certname` values of certificates that can be used with the API user.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，将有一个本地管理员用户作为 Puppet 服务的超级用户以及用于 Puppet 服务内部通信的 API 用户进行身份验证。它不能用于登录，只能通过证书身份验证进行身份验证。有一个允许列表，其中包含可以与
    API 用户一起使用的证书的 `certname` 值。
- en: Roles allow the grouping of permissions to give users permission to perform
    actions. A permission is made up of a **type**, a **permission**, and an **object**.
    The type is what the permission will allow actions on, such as users or node groups.
    A permission is a level of access from create, edit, or view, and an object is
    a specific instance of the type such as the Puppet Enterprise infrastructure node
    group for a node group type.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 角色允许将权限分组，以便授予用户执行操作的权限。权限由**类型**、**权限**和**对象**组成。类型是权限将允许在其上执行操作的对象，例如用户或节点组。权限是创建、编辑或查看的访问级别，而对象是类型的特定实例，例如节点组类型中的Puppet
    Enterprise基础设施节点组。
- en: 'There are five roles provided by default:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 默认提供五个角色：
- en: '**Administrators**: All permissions'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**管理员**：所有权限'
- en: '**Operators**: Permission to create and modify node groups, deploy code, run
    Puppet, run sign certificates, and view the console'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**操作员**：创建和修改节点组、部署代码、运行Puppet、签署证书并查看控制台的权限'
- en: '**Viewers**: Permission to view the console, node groups, and jobs'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**查看者**：查看控制台、节点组和作业的权限'
- en: '**Code deployers**: Permission to deploy code with Code Manager'
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**代码部署者**：使用代码管理器部署代码的权限'
- en: '**Project deployers**: Permission to deploy projects, run tasks and plans from
    projects, and start, stop, and view jobs in orchestrator'
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**项目部署者**：部署项目、从项目中运行任务和计划，并在调度器中启动、停止和查看作业的权限'
- en: Custom roles can be created with the consultation of [https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions](https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions
    ) to find the right granularity of user permissions.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 可以通过参考[https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions](https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions)来创建自定义角色，以找到正确的用户权限粒度。
- en: '**LDAP solutions** such as **Active Directory** (**AD**) can map user groups
    to roles, while **SAML solutions** such as **Okta** can do similar user group
    mapping with attributes to match to roles. Both LDAP and SAML are configured in
    the web console on the **Access control** tab by selecting the corresponding option.'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '**LDAP解决方案**，如**Active Directory**（**AD**）可以将用户组映射到角色，而**SAML解决方案**，如**Okta**，可以通过属性对用户组进行类似的映射，以匹配角色。LDAP和SAML都可以在Web控制台的**访问控制**选项卡中配置，通过选择相应的选项来进行映射。'
- en: Tokens are used for all web sessions, and instead of logging in with a password
    whenever running commands, tokens can be generated for multiple uses. The tokens
    are alphanumeric values between `0` and `2^256 – 1` and stored in the database
    and, depending on the argument, a local file location. Tokens are generated by
    either the token API endpoint, the web console in the `puppet access login` command
    on the CLI. The token is against the user credentials provided, so will have the
    permissions set to that user. By default, the `puppet access login` command will
    write the token to `~/.puppetlabs/token` with a lifetime of 30 minutes unless
    the `--lifetime` is used to set a lifetime such as `5h` for 5 hours.. The `--print`
    flag will cause the token to only be printed and not stored, which is appropriate
    for service-based API access.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 令牌用于所有Web会话，且在运行命令时不需要每次都用密码登录，而是可以生成多个用途的令牌。这些令牌是介于`0`和`2^256 – 1`之间的字母数字值，存储在数据库中，并根据参数存储在本地文件位置。令牌通过令牌API端点、`puppet
    access login`命令的Web控制台或CLI生成。令牌是基于提供的用户凭据生成的，因此将具有该用户设置的权限。默认情况下，`puppet access
    login`命令会将令牌写入`~/.puppetlabs/token`，其生命周期为30分钟，除非使用`--lifetime`选项设置例如`5h`（5小时）的生命周期。`--print`标志会使令牌仅被打印而不存储，这适用于基于服务的API访问。
- en: The classifier service was discussed in [*Chapter 11*](B18492_11.xhtml#_idTextAnchor272),
    where we looked at how it used **node groups** to classify servers in Puppet,
    but to reiterate the key points, node groups are used to classify classes to servers
    either by using facts or directly pinning named servers. Node groups are inheritance
    based, so each child of a node group will inherit everything above it.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 在[*第11章*](B18492_11.xhtml#_idTextAnchor272)中讨论了分类服务，我们探讨了它如何使用**节点组**在Puppet中对服务器进行分类，但为了重申关键点，节点组用于通过使用事实或直接固定命名的服务器来将类分类到服务器。节点组是基于继承的，因此节点组的每个子节点都会继承其上方的所有内容。
- en: Code Manager was discussed in [*Chapter 11*](B18492_11.xhtml#_idTextAnchor272),
    showing how the `r10k` to download modules based on a Puppet file in a control
    repo from a named Git repository, and the `filesync` server and `filesync` clients
    then kept this copy of code in sync across the services.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 代码管理器在[**第11章**](B18492_11.xhtml#_idTextAnchor272)中进行了讨论，展示了如何使用`r10k`从命名的Git存储库中的控制仓库下载基于Puppet文件的模块，然后通过`filesync`服务器和`filesync`客户端保持该代码副本在各个服务之间同步。
- en: The **activity service** is used to log all activities that have taken place
    through the console service and can be viewed by the API endpoint and on the web
    console in various places, such as the **activity** tab on any user and role.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: '**活动服务**用于记录通过控制台服务发生的所有活动，可以通过API端点以及在Web控制台的多个位置查看，例如任何用户和角色的**活动**标签。'
- en: 'The database components of Puppet Enterprise, **PuppetDB** with **PostgreSQL**,
    are the same as was discussed in [*Chapter 10*](B18492_10.xhtml#_idTextAnchor252),
    but several of the services need additional databases to store their state and
    records. So, the following databases are created:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise的数据库组件，**PuppetDB**与**PostgreSQL**，与[**第10章**](B18492_10.xhtml#_idTextAnchor252)中讨论的一样，但几个服务需要额外的数据库来存储它们的状态和记录。因此，创建了以下数据库：
- en: '`pe-activity`: All auditable activities of console services'
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-activity`：控制台服务的所有可审计活动'
- en: '`pe-classifier`: All node group information'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-classifier`：所有节点组信息'
- en: '`pe-inventory`: Agentless client details and their access method for orchestrator'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-inventory`：无代理客户端详细信息及其访问方式，用于编排器'
- en: '`pe-orchestrator`: Job runs, job results, users, and node'
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-orchestrator`：作业运行、作业结果、用户和节点'
- en: '`pe-postgres`: Postgres databases for templating and general access. See [https://www.postgresql.org/docs/current/manage-ag-templatedbs.html](https://www.postgresql.org/docs/current/manage-ag-templatedbs.html)
    to understand template databases further.'
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-postgres`：用于模板和一般访问的Postgres数据库。请参阅[https://www.postgresql.org/docs/current/manage-ag-templatedbs.html](https://www.postgresql.org/docs/current/manage-ag-templatedbs.html)以进一步了解模板数据库。'
- en: '`pe-puppetdb`: Reports, node information, and last run catalog'
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-puppetdb`：报告、节点信息和上次运行的清单'
- en: '`pe-rbac`: Users, roles, groups, and AD/LDAP information'
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-rbac`：用户、角色、组以及AD/LDAP信息'
- en: Note
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: All PostgreSQL communication is done using certificates, including communications
    to replicas.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 所有PostgreSQL通信均使用证书进行，包括与副本的通信。
- en: The one component which was not covered in *Figure 14**.1* was the orchestrator
    services. We will now cover how orchestrator provides the capability of using
    Bolt plans and tasks within Puppet Enterprise.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在*图 14**.1*中未涉及的一个组件是编排器服务。现在我们将介绍编排器如何提供在Puppet Enterprise中使用Bolt计划和任务的能力。
- en: Using Bolt with Puppet Enterprise
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Bolt与Puppet Enterprise
- en: In [*Chapter 12*](B18492_12.xhtml#_idTextAnchor293), it was seen how Bolt was
    run using the `bolt` binary within a Bolt project, but it can be used integrated
    with Puppet Enterprise via the **orchestrator service**, allowing plans and tasks
    to be run as part of Puppet Enterprise.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 在[**第12章**](B18492_12.xhtml#_idTextAnchor293)中，介绍了如何在Bolt项目中使用`bolt`二进制文件运行Bolt，但它可以通过**编排器服务**与Puppet
    Enterprise集成，允许将计划和任务作为Puppet Enterprise的一部分运行。
- en: The key difference is that currently, only Puppet modules containing tasks and
    plans can be deployed (including adding them to a control repo); there is no current
    method of deploying bolt projects to Puppet Enterprise directly.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 主要区别在于，目前只能部署包含任务和计划的Puppet模块（包括将它们添加到控制仓库）；目前没有直接将bolt项目部署到Puppet Enterprise的方法。
- en: Note
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: With plans and tasks deployed through modules, this means the same plan or task
    can have multiple versions, depending on the environment it is run from.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 通过模块部署的计划和任务意味着相同的计划或任务可以有多个版本，具体取决于运行环境。
- en: It is also important to realize not all of the features available to Bolt natively
    will be available within Puppet Enterprise.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 还需要注意，并非Bolt原生提供的所有功能都能在Puppet Enterprise中使用。
- en: 'The following list highlights the key differences when running plans and tasks
    in Puppet Enterprise in orchestrator instead of in native Bolt:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 以下列表突出显示了在编排器中运行Puppet Enterprise的计划和任务与在原生Bolt中运行时的主要区别：
- en: Various Bolt functions for plans, such as `prompt`, `parallelize`, and `file.upload`,
    have not been implemented
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于计划的各种Bolt功能，如`prompt`、`parallelize`和`file.upload`，尚未实现
- en: '`puppet apply` blocks can only be applied to nodes with a Puppet agent'
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`puppet apply`模块只能应用于具有Puppet代理的节点'
- en: Targets and the localhost target are unavailable
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 目标和本地主机目标不可用
- en: File sources must be module based and cannot be absolute paths
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Most of these limitations reflect not running Bolt from a local machine and
    a lack of a prompt to run them. Full details can be viewed in Puppet’s documentation
    at [https://puppet.com/docs/pe/2021.7/plans_limitations.html](https://puppet.com/docs/pe/2021.7/plans_limitations.html).
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: 'Puppet Enterprise handles three types of nodes with plans and tasks:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
- en: Nodes with a Puppet agent installed, using the **Puppet Communications Protocol**
    (**PCP**) and the **PCP Execution** **Protocol** (**PXP**)
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Agentless nodes via the **Windows Remote Management** (**WinRM**) and **Secure
    Shell** (**SSH**) transports
  id: totrans-73
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Agentless devices such as switches or firewalls via transports such as F5 and
    **Palo Alto Netorks Operating system** (**PAN-OS**) or transports provided via
    the resource API
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Having highlighted what orchestrator is capable of running for plans and tasks,
    we will now look at the components that make up orchestrator, highlighting the
    purpose of these services and key details such as log locations and configuration
    files.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: Orchestrator services
  id: totrans-76
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The orchestrator application is a **Clojure** application made up of the services
    shown in the following diagram:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 14.3 – Components of the Puppet orchestrator service](img/B18492_14_03.jpg)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
- en: Figure 14.3 – Components of the Puppet orchestrator service
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s have an overview of these components and their relevant services and
    log files:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: '`pe-orchestration-services.service` and logs to `/var/log/puppetlabs/orchestration-services/orchestration-services.log`.'
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`POST /command/create-connection` inventory API call ([https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints](https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints)).
    These entries are encrypted by a secret key, by default placed at `/etc/puppetlabs/orchestration-services/conf.d/secrets/keys.json`,
    and although listed separately, the inventory service runs within `pe-orchestration-services`.
    It stores its data in the PostgreSQL inventory database.'
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Note
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: Agentless nodes added to the inventory are counted within the overall licensed
    number of nodes for Puppet Enterprise.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: '`pe-bolt-server.service` and logs to `/var/log/puppetlabs/bolt-server/bolt-server.log`.'
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`pe-ace-server.service` and logs to `/var/log/puppetlabs/ace-server/ace-server.log`.'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`/var/log/puppetlabs/orchestration-services/pcp-broker-access.log` and general
    service logs are logged to `/var/log/puppetlabs/orchestration-services/pcp-broker.log`.'
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`pxp-agent.service` and logs to `/var/log/puppetlabs/pxp-agent/pxp-agent.log`.'
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The orchestrator service will verify via RBAC that the Puppet Enterprise console
    user has the correct permissions. For plans, it is only possible to specify users
    or groups and which plans they can run with no limit of nodes or which environment
    the plan will come from. For tasks, task targets allow a list of tasks and either
    a **Puppet Query Language** (**PQL**) query of nodes or groups of nodes to be
    specified, which the tasks can be run against. This can be done either via the
    API call, as shown at [https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target](https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target),
    or in the RBAC GUI, as shown in the following screenshot:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 14.4 – Creating a task target on the web console](img/B18492_14_04.jpg)'
  id: totrans-90
  prefs: []
  type: TYPE_IMG
- en: Figure 14.4 – Creating a task target on the web console
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we will learn how to run tasks, plans, or Puppet runs through
    orchestrator.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
- en: Running jobs
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'When tasks, plans, or Puppet runs are run through orchestrator, they become
    known as **jobs**. There are three ways to run jobs, as follows:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
- en: The first way to do this is via the GUI by selecting the relevant menu on the
    left bar.
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The second is via the CLI on the primary server with largely the same syntax
    as the `puppet task run` and `puppet plan run` Bolt commands. The key differences
    compared to Bolt are that the `--nodes` flag is used instead of `targets` (reflecting
    the fact you will be just providing a node name, for which orchestrator will lookup
    transport information) and extra flags are available, such as the --`node-groups`
    flag, for choosing a node group to run against. Here’s an example:'
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-97
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The third way is via the APIs documented at [https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html](https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html),
    with the key calls listed here:'
  id: totrans-98
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`POST /command/deploy`: Run Puppet on demand'
  id: totrans-99
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '`POST /command/plan_run`: Run a plan'
  id: totrans-100
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '`POST /command/task`: Run a task on a set of nodes'
  id: totrans-101
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Jobs in progress can be stopped by pressing *Ctrl* + *C* on the CLI, selecting
    `POST /command/stop` API command. Although we should be careful to note a stopped
    jobs underlying process may run to completion regardless.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
- en: An API command was introduced in PE 2021.7.1 `POST /command/stop_plan` to allow
    for plans to be stopped.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
- en: It is also possible to schedule jobs in orchestrator via the GUI or by `API
    POST /scheduled_jobs/environment_jobs`, but great care should be taken to be aware
    of the system load of using the scheduler. Orchestrator has limitations with how
    it scales since there is no way to horizontally scale, and the queuing system
    for tasks and plans can be easily blocked by certain types of requests.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: Configuring performance settings
  id: totrans-105
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The settings discussed in this section can all be configured in the Puppet Enterprise
    orchestrator infrastructure node group on the web console or as code in Hiera.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: 'orchestrator can run a maximum number of tasks concurrently; this maximum number
    of concurrent tasks is configured with the `puppet_enterprise::profile::orchestrator::task_concurrency`
    parameter (default: `250`), along with `puppet_enterprise::profile::bolt_server::concurrency`
    (default: `100`) and `puppet_enterprise::profile::ace_server::concurrency` (default:
    `100`), which limit Ace and Bolt directly (they should not be greater than the
    `orchestrator::task_concurrency` total). Their sizes are mainly limited by orchestrator
    memory, which will reserve approximately ± 1 MB of RAM for each instance of capacity
    you add. Tasks are dealt with in the order they are received until they are completed;
    this means long-running tasks and tasks with large numbers of targets can potentially
    block other tasks from running and monopolize resources. Taking the case of running
    tasks taking 10 minutes to complete on 1,000, servers this would result in the
    task using the queue capacity of 250 four times and taking a total executing time
    of 40 minutes to run the tasks on all targets, during which time all other tasks
    would need to queue until it was complete. It is strongly recommended that a task
    should take no longer than 5 minutes and that careful management should take place
    to run tasks in smaller batches. It should also be noted there is no limit in
    the task queue and it risks running `puppet_enterprise::profile::orchestrator::allowed_pcp_status_requests`
    parameter. It is important to understand this does not mean the task has failed
    but simply that orchestrator cannot get a status for it within the timeout. The
    task itself may have completed after this time.'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: For plans, orchestrator is similar to Puppet Server in requiring JRuby instances
    to compile plans. This capacity is set by `puppet_enterprise::profile::orchestrator::jruby_max_active_instances`,
    with heap memory for the JVM set at `puppet_enterprise::profile::orchestrator::java_args`.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
- en: Having discussed the core components and services of Puppet Enterprise, we will
    now look at how these components can be deployed using automated tools, deploying
    to Puppet-advised reference architectures to ensure that infrastructure will scale
    to user requirements.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: Automating deployment and reference architectures
  id: totrans-110
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Puppet Enterprise focuses on creating standard architectures and configurations
    and the automation to deploy them. This ensures that less design effort is required
    from Puppet Enterprise customers who can find the right standard architecture
    and pattern and deploy it using provided tooling.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
- en: Understanding supported architectures
  id: totrans-112
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Puppet documents three supported architectures for Puppet Enterprise, as follows:'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: The **standard installation** is just a standalone primary server and supports
    up to 2,500 clients
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The **large installation** is a primary server with compile servers behind a
    load balancer and supports up to 20,000 clients
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Extra-large installations** are a primary server, a separate server with
    PuppetDB, and compile servers behind a load balancer supporting over 20,000 servers'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'These are illustrated in the following diagram:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 14.5 – Standard architectures](img/B18492_14_05.jpg)'
  id: totrans-118
  prefs: []
  type: TYPE_IMG
- en: Figure 14.5 – Standard architectures
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: The standard architecture is limited by how many clients a primary server can
    run catalogs for by itself, up to 2,500 nodes. Over this level, the large architecture
    allows horizontal scaling using compiler nodes but reaches limits of how much
    load a single primary server can take running all the services together. So, at
    25,000 nodes, the extra-large architecture recommends separating out PuppetDB
    as one of the heaviest services to its own server.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: 'In all these architectures, it is possible to provide a replica server to the
    primary server and a separate PostgreSQL server, through a method named **disaster
    recovery** (**DR**). In the event of loss of the primary or PostgreSQL server,
    DR gives the ability to perform failover actions and recover services with an
    expected loss of some services, as listed in the following tabular breakdown of
    services:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: '| **Service name** | **Replication type** | **Failover approach** |'
  id: totrans-122
  prefs: []
  type: TYPE_TB
- en: '| Puppet Server | None | Active / Active |'
  id: totrans-123
  prefs: []
  type: TYPE_TB
- en: '| Console services UI | None | Read-only until manual promotion |'
  id: totrans-124
  prefs: []
  type: TYPE_TB
- en: '| ACE service | None | Read-only until manual promotion |'
  id: totrans-125
  prefs: []
  type: TYPE_TB
- en: '| Bolt service | None | Read-only until manual promotion |'
  id: totrans-126
  prefs: []
  type: TYPE_TB
- en: '| CA | One-way replication | Read-only until manual promotion |'
  id: totrans-127
  prefs: []
  type: TYPE_TB
- en: '| RBAC | One-way replication | Read-only until manual promotion |'
  id: totrans-128
  prefs: []
  type: TYPE_TB
- en: '| Classifier | One-way replication | Read-only until manual promotion |'
  id: totrans-129
  prefs: []
  type: TYPE_TB
- en: '| Activity | One-way replication | Read-only until manual promotion |'
  id: totrans-130
  prefs: []
  type: TYPE_TB
- en: '| Orchestration | One-way replication | Read-only until manual promotion |'
  id: totrans-131
  prefs: []
  type: TYPE_TB
- en: '| File sync | One-way replication | Read-only until manual promotion |'
  id: totrans-132
  prefs: []
  type: TYPE_TB
- en: '| PuppetDB | Bi-directional | Active – Active |'
  id: totrans-133
  prefs: []
  type: TYPE_TB
- en: Table 14.1 – Service replication and failover approach for DR
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: PuppetDB is unique in its synchronization within Puppet Enterprise; it performs
    a read-write synchronization between primary and replica, which is why it is the
    only service in the previous list that synchronizes and is available on promotion.
    The other services that use PostgreSQL rely on a `PGLogical` synchronization from
    primary to replica, making the data read-only on the replica.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: What can be seen from this list is during the failure of a primary server, the
    replica will only be able to take over and compile catalogs of servers already
    registered, queries and reports from PuppetDB, and queries of node classification
    via the API. This means no new servers can be registered or removed, no new code
    can be deployed, the web console cannot be used, classification cannot be changed,
    and most of the CLI tools will be non-functional until manual promotion actions
    are taken via the `puppet infrastructure promote replica` command on the replica.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: This is an irreversible action, and the original failed primary server must
    be redeployed as a replica before it can be used again. Therefore, for many users
    attempting to fix the original primary server, this is less time-consuming than
    going through the DR process.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: DR should not be confused with **high availability** (**HA**), which would be
    expected for continuous service in the event of the loss of a server, and that
    is not possible in any current Puppet architecture.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: When using DR, peadm ensures that the compilers are split and configured into
    two groups and PuppetDB requests are distributed across the two sides of the PuppetDB
    replication to maximize capacity. If you choose not to use pecdm, ensure you follow
    this optimization, which can be seen in code at [https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp](https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp),
    with the A and B groups setting parameters for databases.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: 'The Puppet architecture also defines a set of multi-region patterns for how
    to deploy across regions both public and private cloud, where a region is defined
    by cloud vendors as data centers with regional low-latency connections. Full details
    are available at [https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html](https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html).
    Best practice requires compilers to have low-latency connections, and these are
    therefore best placed in the same region as primary and replica servers; similarly,
    the connection between primary and replica must be low latency. The best practice
    is, therefore, to use a centralized deployment where all Puppet infrastructure
    is in a management region that all regions can communicate with, as shown in the
    following diagram:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 14.6 – Centralized and federated deployments](img/B18492_14_06.jpg)'
  id: totrans-142
  prefs: []
  type: TYPE_IMG
- en: Figure 14.6 – Centralized and federated deployments
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
- en: Alternatively, a federated model can be used whereby Puppet infrastructure is
    placed in each region, with the downside that no single console views the whole
    estate.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
- en: Having discussed the architectures and patterns in full, it is time to see which
    tooling is available to deploy these patterns.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
- en: Deployment and configuration
  id: totrans-146
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Puppet automates the deployment of its server infrastructure in several layers.
    The first layer uses the Puppet Enterprise installer, a tarball file that is downloaded
    from Puppet containing all the necessary packages and scripts to install Puppet
    Enterprise. Once downloaded on a target server and untarred, the basic install
    can be done by running `./puppet-enterprise-installer`. It is possible to add
    custom configurations by creating a `-c` flag to its location, following the guidance
    at [https://puppet.com/docs/pe/2021.7/installing_pe.html](https://puppet.com/docs/pe/2021.7/installing_pe.html).
    Once a Puppet server is configured, the install scripts can be used to automate
    adding agents; a Bash script for Unix-based systems and a PowerShell script for
    Windows are hosted on a file server on the primary, which ensures the correct
    agent package is installed:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: In the example, the options set `environment` to `production` in the `puppet.conf`
    file and ensure the service is not running. The full range of options is available
    and documented at [https://puppet.com/docs/pe/2021.7/installing_agents.html](https://puppet.com/docs/pe/2021.7/installing_agents.html).
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
- en: This `install` script would only have installed the primary server and would
    require further manual steps to add compilers and replicas depending on the architecture
    we wanted. To deploy the next layer instead of using the Enterprise installer
    directly, we use the peadm module ([https://forge.puppet.com/modules/puppetlabs/peadm](https://forge.puppet.com/modules/puppetlabs/peadm)),
    a supported Puppet module that provides an automated way to run the Puppet Enterprise
    installer script and configure it to one of the supported architectures automatically.
    This module assumes the infrastructure required for the requested configuration
    is available and it is possible to go to another level and automatically provision
    in public cloud environments using the pecdm module ([https://github.com/puppetlabs/puppetlabs-pecdm](https://github.com/puppetlabs/puppetlabs-pecdm)).
    An example of usage of these modules was discussed in detail in [*Chapter 12*](B18492_12.xhtml#_idTextAnchor293)and
    is what we have been using throughout this book to deploy labs.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
- en: The `peadm` module itself goes beyond simple deployment and has plans and tasks
    to show the status of the server and allow the performance of version upgrades
    via its tasks and plans.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
- en: Puppet Enterprise combines modules installed in the `Enterprise` folder and
    configured either in the classifier or Hiera data with other file locations to
    place customizations. The console has a number of configurations that can be set
    either in the classification in the web console or via Hiera, such as failed login
    attempts set by `puppet_enterprise::profile::console::rbac_failed_attempts_lockout`
    and password complexity rules such as minimum password length, set by `puppet_enterprise::profile::console::password_minimum_length`.
    A full list of console customizations can be found at [https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services](https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services).
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
- en: In addition, files can be placed for the console, by placing a file at the path
    specified by `puppet_enterprise::profile::console::disclaimer_content_path`, which
    defaults to `/etc/puppetlabs/console-services`. You can create a message to display
    when logging in to the console, such as a legal warning your organization may
    have.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
- en: Additionally in the console, it is possible to search for nodes based on PQL
    with predefined PQL examples selectable. It is possible to add your own PQL examples
    to the web console by simply placing a file at `/etc/puppetlabs/console-services/custom_pql_queries.json`
    using `/etc/puppetlabs/console-services/custom_pql_queries.json.example` as a
    template. The web console itself uses a self-signed CA by default, and this can
    be replaced with one signed by your organization’s CA system by placing the generated
    certificate at `/etc/puppetlabs/puppet/ssl/certs/console-cert.pem` and `/etc/puppetlabs/puppet/ssl/private_keys/console-cert.pem`.
    One last key file to consider is the license key, which is issued to you by Puppet
    and placed at `/etc/puppetlabs/license.key` with `644 root:root` permissions.
    You can view the details of licensing under the **License** tab on the web console.
    A Puppet agent run should be made for these changes and the console service restarted.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
- en: Some areas of Puppet Enterprise are not currently definable through native code
    such as RBAC, classification, and LDAP, but there are APIs and Puppet modules
    that take advantage of those APIs, which can allow for storing configuration.
    For classification, there is an API to view the classification and configure node
    groups; this can also be done via the **node_manager** module ([https://forge.puppet.com/modules/WhatsARanjit/node_manager](https://forge.puppet.com/modules/WhatsARanjit/node_manager)),
    which is used by peadm. For RBAC and LDAP, the RBAC API ([https://puppet.com/docs/pe/2021.7/rbac-api.htm](https://puppet.com/docs/pe/2021.7/rbac-api.htm))
    has endpoints that can be used to manage groups, roles, and users. A Puppet module
    has been developed to use these APIs ([https://forge.puppet.com/modules/pltraining/rbac](https://forge.puppet.com/modules/pltraining/rbac))
    and it has an LDAP endpoint that has similarly had a module developed to use the
    APIs ([https://forge.puppet.com/modules/abuxton/puppet_ds).](https://forge.puppet.com/modules/abuxton/puppet_ds).
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
- en: )
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
- en: Having reviewed the architecture and deployment recommendations, we will discuss
    other supporting tools and products to work with Puppet in the following section.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
- en: Puppet Enterprise-related projects and tooling
  id: totrans-158
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Puppet Enterprise has several modules and tools developed by Puppet to ease
    the management and support of Puppet infrastructure. The most direct is the built-in
    support script; this command gathers logs and system information and compresses
    it allowing users to send detailed status information to cases with Puppet’s support
    teams. The simple version of the command is shown here: `/opt/puppetlabs/bin/puppet`
    `enterprise support`.'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
- en: Various options can be found in the documentation at [https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script](https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script)
    that allow for selecting services to be collected, to directly **Secure File Transfer
    Protocol** (**SFTP**) upload the archive as part of the command, and to encrypt
    the archive, assuming **GNU Privacy Guard** (**GPG**) keys are available.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
- en: It is possible to use **SOScleaner** to remove hostnames and IP addresses from
    the support script contents. Visit [https://support.puppet.com/hc/en-us/articles/115003312887](https://support.puppet.com/hc/en-us/articles/115003312887)
    for details on how to install and run it.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
- en: Having seen how to deploy Puppet infrastructure, it is important for you to
    understand how to monitor and troubleshoot any issues found, so let’s look at
    that next.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
- en: Monitoring and troubleshooting Puppet Enterprise infrastructure
  id: totrans-164
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The **Puppet Enterprise status_check module** ([https://forge.puppet.com/modules/puppetlabs/pe_status_check](https://forge.puppet.com/modules/puppetlabs/pe_status_check))
    performs checks on both Puppet infrastructure servers and Puppet agents based
    on commonly found issues in support cases, such as confirming services are running,
    disk space is free, and certificates are not expiring. These checks can be run
    as tasks, Puppet code that will notify issues into reports, or as facts—the Splunk
    plugin shown in [*Chapter 13*](B18492_13.xhtml#_idTextAnchor321)has a dashboard
    for displaying the fact output. Using these checks means if you do experience
    any issues when you raise your support case with Puppet, you can reference the
    check number.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
- en: The **support_tasks module** ([https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks](https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks))
    provides tasks that perform actions set out in knowledge base articles such as
    regenerating certificates, running the support script, and printing Puppet database
    table sizes.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
- en: Some extra console views can be configured to be visible and usable in the console;
    value reporting simply needs values entered in the **Value report** tab for how
    much time is to be reclaimed by using tasks, plans, corrective changes, and intentional
    changes, and it will also generate statistics.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
- en: Puppet Enterprise can gather additional information about packages including
    unmanaged packages; this information is made visible in the `puppet_enterprise::profile::agent`
    class to a node group covering nodes you wish to collect from and by setting the
    `package_inventory_enabled` parameter to `true`.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
- en: The final extra that can be enabled allows the monitoring and management of
    patching. In the `pe_patch` class.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
- en: In addition to the core Puppet Enterprise infrastructure, there are additional
    Puppet products allowing management of pipelines for code deployment onto Puppet
    Enterprise and for compliance scans to be run on Puppet nodes.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
- en: Managing deployments and ensuring compliance
  id: totrans-171
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: There are two additional Puppet products to consider using with Puppet Enterprise,
    `v4` catalog API to compile a new catalog with the new code and compare it with
    the current code’s catalog, displaying the difference to ensure the impact is
    as the developer expected. These pipelines can be made in the web console for
    CD4PE or created as code in YAML files inserted into modules and control repos
    to be deployed.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: '**Puppet Comply** is a compliance tool based on the **Centre for Internet Security**
    (**CIS**) benchmarks. It builds automation around the Java scanner developed by
    CIS, CIS-CAT Pro accessor ([https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro](https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro)).
    This allows hosts to be accessed against the CIS benchmarks, using orchestrator
    in Puppet Enterprise to automate and schedule runs of the scanner via tasks and
    producing dashboards of their compliance in a separate Puppet Comply console.
    An example of the home screen of Comply is shown in the following screenshot:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 14.7 – Puppet Comply home dashboard](img/B18492_14_07.jpg)'
  id: totrans-174
  prefs: []
  type: TYPE_IMG
- en: Figure 14.7 – Puppet Comply home dashboard
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: It can be seen from the dashboard how many of the nodes are achieving compliance,
    how many nodes have a compliance profile set, and a list of node results listing
    which profile is assigned and compliance scores in a particular scan.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
- en: It also comes with the premium `cem_linux` ([https://forge.puppet.com/modules/puppetlabs/cem_linux](https://forge.puppet.com/modules/puppetlabs/cem_linux))
    and `cem_windows` ([https://forge.puppet.com/modules/puppetlabs/cem_windows](https://forge.puppet.com/modules/puppetlabs/cem_windows))
    to speed up your adoption of Puppet, allowing base security configuration to be
    taken based on CIS benchmarks via pre-made Puppet modules. These modules are maintained
    and supported by Puppet, ensuring the enforcement code is up to date with the
    latest CIS benchmarks.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: Both products run in the framework known as **Puppet Application Manager** (**PAM**),
    a Kubernetes-based tool for managing Puppet applications.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
- en: Lab – Puppet Enterprise extensions and configuration
  id: totrans-179
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Executing the bolt command in the *technical requirements* section deploys
    a large deployment of Puppet Enterprise 2021.5\. With this infrstructure setup,
    we will try various extensions and configurations we have discussed, as follows:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: Examine the code in peadm and the node groups that set up the A and B groups.
    Note [https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md](https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md)
    provides an explanation of the groups.
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a personal user with permission to view the console and create node groups
    and view the activity log of the administrator user (try to log in without the
    view console permissions).
  id: totrans-182
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Enable package management on the web console for all nodes, log in as your personal
    user, and view the activity log of this.
  id: totrans-183
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Enable patch management for the nodes by applying code using the `node_manager`
    module.
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Customize the login message.
  id: totrans-185
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Perform an upgrade to 2021.6 using the peadm upgrade plan. *Note*: Since pecdm
    includes peadm, this can be performed from your development environment.'
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Sample solutions are provided at [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14).
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-188
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This chapter has reviewed how Puppet Enterprise builds on top of the open source
    tooling, providing the services necessary to secure and automate the deployment
    of Puppet. It was discussed how Puppet Enterprise bundled the open source packages
    into consistent versions, with support offerings and services from Puppet architecture
    and services teams.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: We also discussed the additional services of Puppet Enterprise that secure user
    and API access via RBAC, giving a web frontend and additional APIs in the console
    services the ability to deploy code from Code Manager.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
- en: Puppet orchestrator was then seen, to show how tasks and plans could be run
    in Puppet Enterprise with the orchestrator service running tasks and plans via
    PCP using PXP brokers to direct communication from PXP agents on nodes. The agentless
    clients could be added to the inventory service storing their transport details,
    and tasks or plans to run on them would ego via the Bolt server for nodes connected
    by WinRM or SSH, while other transports’ particular network devices such as switches
    or firewalls used the ACE server. We saw how orchestrator would store all the
    job details updating the activity service. RBAC access was discussed, showing
    how you could only limit which plans were available to a user but could set tasks
    to particular users and particular groups of nodes using target sets. Performance
    and capacity aspects of orchestrator were discussed, as well as how to run tasks
    or plans via the web console GUI or the CLI interface.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: The supported architectures customers could take off the shelf to implement
    Puppet at scale and regional requirements for their estate were reviewed, showing
    the modules and scripts that wrap up to automatically deploy these architectures,
    the pecdm module deploying infrastructure in the public cloud, peadm automating
    the various steps of install and maintenance, and using the installer script.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
- en: Extras services that could be enabled in the web console to help report on the
    value Puppet delivers, patch management, and packaging reporting were reviewed,
    along with customizations and methods to automate configuration within the console
    covering customization of the console message, the certificate used on the web
    console, and the license key. Several modules were then discussed that could assist
    in reporting the status of the infrastructure and running standard tasks in the
    `support_task` and `status_check` modules.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
- en: 'Two further Puppet products that integrate with Puppet Enterprise were then
    discussed: CD4PE, which provides a pipeline to assist in automating the deployment
    of code, and Puppet Comply, which gives pre-written modules and dashboards to
    allow for reporting on CIS benchmarks.'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: While all of the architecture, tooling, packaging, and general automation could
    be achieved with Open Source Puppet, it would require development and support
    work from your own teams. So, Puppet Enterprise should be seen as a decision about
    the skills and people available in your team, tooling already invested in the
    organization and money available for tooling, and where your organization wants
    to focus its work.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
- en: Now, having fully reviewed the language, the platform, and how Puppet Enterprise
    can provide preconfigured infrastructure to reduce the operational burden and
    design required, in the final chapter, we will discuss approaches to adopting
    and using Puppet, focusing on getting the best use in your organization, since
    understanding the technology is only part of the battle while understanding how
    to integrate with people and processes is often the greater challenge.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
