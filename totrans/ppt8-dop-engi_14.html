<html><head></head><body>
		<div id="_idContainer070">
			<h1 id="_idParaDest-269" class="chapter-number"><a id="_idTextAnchor340"/>14</h1>
			<h1 id="_idParaDest-270"><a id="_idTextAnchor341"/>A Brief Overview of Puppet Enterprise</h1>
			<p>This chapter will give an overview of <strong class="bold">Puppet Enterprise</strong>, what it is, and what it provides compared to <strong class="bold">Open Source Puppet</strong>. Although the author of this book is a Puppet employee, this is not intended as a hard sell but to present where and how to use Puppet Enterprise well. It will cover the extra Enterprise console services in the Puppet platform, showing how code deployment, orchestrator service, RBAC, web console, and various other services are automatically configured and work with each other. This will assist in understanding how Puppet Enterprise differs from Open Source Puppet and the preconfigured and built-in features that would need to be manually created in Open Source Puppet. Supported architectural patterns will be highlighted that help to understand how to deploy and scale Puppet infrastructure using Puppet Enterprise packaging and modules to automatically deploy these patterns. Some related projects and integrations will be discussed, along with how they fit into the Puppet <span class="No-Break">Enterprise environment.</span></p>
			<p>In this chapter, we’re going to cover the following <span class="No-Break">main topics:</span></p>
			<ul>
				<li>What is <span class="No-Break">Puppet Enterprise?</span></li>
				<li>Exploring the Puppet Enterprise console <span class="No-Break">and services</span></li>
				<li>Using Bolt with <span class="No-Break">Puppet Enterprise</span></li>
				<li>Automating deployment and <span class="No-Break">reference architectures</span></li>
				<li>Puppet Enterprise-related projects <span class="No-Break">and tooling</span></li>
				<li>Lab—Puppet Enterprise extensions <span class="No-Break">and configuration</span></li>
			</ul>
			<h1 id="_idParaDest-271"><a id="_idTextAnchor342"/>Technical requirements</h1>
			<p>Clone the control repo from <a href="https://github.com/puppetlabs/control-repo">https://github.com/puppetlabs/control-repo</a> to your <strong class="source-inline">controlrepo-chapter14</strong> GitHub account and update the <strong class="source-inline">Puppetfile </strong>file in this <span class="No-Break">repo: </span><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile"><span class="No-Break">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile</span></a><span class="No-Break">.</span></p>
			<p>Build a large cluster with a replica with three compilers and three clients by downloading the <strong class="source-inline">params.json </strong>file from <a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json</a><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineering/blob/main/ch14/params.json "/>and updating it with the location of your control repo and your SSH key for the control repo. Then, run the following command from your <span class="No-Break"><strong class="source-inline">pecdm </strong></span><span class="No-Break">directory:</span></p>
			<pre class="source-code">
bolt --verbose plan run pecdm::provision –-params @params.json</pre>
			<h1 id="_idParaDest-272"><a id="_idTextAnchor343"/>What is Puppet Enterprise?</h1>
			<p>A common <a id="_idIndexMarker1026"/>misconception when discussing Puppet Enterprise is that features of the product are held back and not available for open source users. The aim of Puppet Enterprise isn’t to limit what is available to open source users but to instead provide value to customers who want to consume Puppet easily and focus on gaining the value of configuration management by putting less of their own development and automation work into the <span class="No-Break">platform itself.</span></p>
			<p>Puppet achieves this by ensuring that in Enterprise, the packing of components is versioned and tested together with an automated installation script and module, reducing the effort required by users managing the infrastructure. Puppet Enterprise works on two different types of releases. Puppet Enterprise, which works on an <em class="italic">xxxx.y </em>pattern, is normally updated every 3 months, which at the time of writing would be <strong class="source-inline">2023.0</strong>. This version is planned to upgrade to Puppet 8.x versions in 2023.3 and will receive new features throughout its lifetime. This release is recommended for users who want to access the latest features and fixes and will require a regular update pattern. The other type of<a id="_idIndexMarker1027"/> release is the <strong class="bold">long-term support </strong>(<strong class="bold">LTS</strong>) version; this follows an <em class="italic">xxxx.y.z </em>pattern. This branch is normally updated every 3 months, but the updates would only include fixes and not new features. The LTS versions last 2 years and have an overlap of 6 months with the next major <em class="italic">xxxx </em>release, so the current 2021.7.z LTS will end mainstream support on August 31, 2024, at which point overlap support will continue until February 28, 2025, after which users should migrate to whichever version of Puppet they require. 2023.y becomes the new LTS release to continue to have support from Puppet. The two running Puppet Enterprise versions generally mirror two Open Source Puppet versions in active development. The release of 2023.0 retired Puppet 6 and 2023 should move to Puppet 8 in version 2023.3 or <span class="No-Break">shortly after.</span></p>
			<p>The most obvious feature of an Enterprise license is support, with access to raise support cases with teams who can review infrastructure problems and assist with any issues or features required for <span class="No-Break">supported modules.</span></p>
			<p>Puppet also <a id="_idIndexMarker1028"/>provides various professional services, such as on-site engagements to provide hands-on training and advice. This can lead to architecture reviews to understand how best to implement in your environment and to feed into processes that develop products and solutions such<a id="_idIndexMarker1029"/> as the <strong class="bold">Puppet Data Service </strong>(<strong class="bold">PDS</strong>) and <strong class="bold">Puppet Enterprise Administration Module </strong>(<strong class="bold">peadm</strong>). Further, <strong class="bold">technical account managers </strong>(<strong class="bold">TAMs</strong>) are <a id="_idIndexMarker1030"/>assigned<a id="_idIndexMarker1031"/> to give you a regular point of contact and champion you in Puppet, supporting you in creating a success plan for your organization and focusing your deployment to achieve <span class="No-Break">its goals.</span></p>
			<p>Puppet provides reference architectures and patterns of Puppet products to show how to work at different scales and implementation types. Additional applications built on top of the Puppet Server service allow for access control, server classification, code deployment, visualization, and searching of data to be completed in a standard way from the console. We will look at these in greater detail in the <span class="No-Break">following section.</span></p>
			<h1 id="_idParaDest-273"><a id="_idTextAnchor344"/>Exploring the Puppet Enterprise console and services</h1>
			<p>There are several <a id="_idIndexMarker1032"/>additional services <a id="_idIndexMarker1033"/>built into a <strong class="bold">Puppet Enterprise primary server</strong>, as shown in the <span class="No-Break">following diagram:</span></p>
			<div>
				<div id="_idContainer063" class="IMG---Figure">
					<img src="image/B18492_14_01.jpg" alt="Figure 14.1 – Puppet Enterprise components"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.1 – Puppet Enterprise components</p>
			<h2 id="_idParaDest-274"><a id="_idTextAnchor345"/>Puppet Server</h2>
			<p>The <strong class="bold">Puppet </strong>service is <a id="_idIndexMarker1034"/>the same as discussed in <a href="B18492_10.xhtml#_idTextAnchor252"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>, with the <strong class="bold">certificate authority </strong>(<strong class="bold">CA</strong>) providing<a id="_idIndexMarker1035"/> a certificate signing process to secure communication and the Puppet agent contacting a compiler’s Puppet Server service to request a catalog compilation. <strong class="bold">Facter </strong>is <a id="_idIndexMarker1036"/>used to provide a server profile. In <span class="No-Break"><em class="italic">Figure 14</em></span><em class="italic">.1</em>, we opt not to show that the primary server itself has a Puppet Server service, and both the compiler and primary server have Puppet agents, which both request catalog compilations from the primary server’s <span class="No-Break">Puppet server.</span></p>
			<h2 id="_idParaDest-275"><a id="_idTextAnchor346"/>Introducing Puppet web console components</h2>
			<p>The <a id="_idIndexMarker1037"/>most obvious immediate difference of the Puppet Enterprise server is <a id="_idIndexMarker1038"/>the <strong class="bold">web console</strong>, which provides the login view we have been using in our lab throughout this book. Several services combine to make up the <span class="No-Break">console services</span></p>
			<p>The console is a web frontend Jetty-based Clojure service with an NGINX server that acts as a reverse proxy. The NGINX server listens on port HTTPS <strong class="source-inline">443 </strong>and redirects HTTP 80 to HTTPS. The console UI provides an aggregation and translation Jetty-based Clojure service to generate the correct pages and access other <span class="No-Break">console services.</span></p>
			<p>The authentication UI generates login and resets password content pages. The simplest way to show this is to use an example of the communication required when logging in, as shown in the <span class="No-Break">following diagram:</span></p>
			<p class="IMG---Figure">  </p>
			<div>
				<div id="_idContainer064" class="IMG---Figure">
					<img src="image/B18492_14_02.jpg" alt="Figure 14.2 – Steps to generate the login page"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.2 – Steps to generate the login page</p>
			<p>It can be seen <a id="_idIndexMarker1039"/>from the diagram that as a first step, the NGINX server receives a <strong class="source-inline">GET </strong>request and, after performing TLS negotiation, redirects to the console Jetty page. This page evaluates cookies, establishes the user is not logged in, and redirects to the auth/login page, which is requested from NGINX and redirected to the authentication UI. The authentication UI generates a login page and gets <strong class="bold">Security Assertion Markup Language</strong> (<strong class="bold">SAML</strong>) configuration from the RBAC Jetty page, and this login page is then passed back to <span class="No-Break">the user.</span></p>
			<p>The <strong class="bold">RBAC service </strong>has <a id="_idIndexMarker1040"/>users and roles to construct access policies. It allows for both local and remote users in Puppet Enterprise, with integration possible to <strong class="bold">Lightweight Directory Access Protocol (LDAP</strong>) and SAML services. All users by default are denied permission to create, edit, or view any part of Puppet Enterprise, and permissions are then granted <span class="No-Break">via roles.</span></p>
			<p>By default, there will be a local administrative user who acts as a superuser for the Puppet service and an API user for authentication for Puppet services to communicate within Puppet Enterprise. It cannot be used for login and only authenticates with certificate authentication. There is an allow list that has the <strong class="source-inline">certname </strong>values of certificates that can be used with the <span class="No-Break">API user.</span></p>
			<p>Roles <a id="_idIndexMarker1041"/>allow <a id="_idIndexMarker1042"/>the grouping of permissions to give users permission to perform actions. A permission is made up of a <strong class="bold">type</strong>, a <strong class="bold">permission</strong>, and an <strong class="bold">object</strong>. The type is what the permission will allow actions on, such as users or node groups. A permission is a level of access from create, edit, or view, and an object is a specific instance of the type such as the Puppet Enterprise infrastructure node group for a node <span class="No-Break">group type.</span></p>
			<p>There are five roles provided <span class="No-Break">by default:</span></p>
			<ul>
				<li><strong class="bold">Administrators</strong>: <span class="No-Break">All </span><span class="No-Break"><a id="_idIndexMarker1043"/></span><span class="No-Break">permissions</span></li>
				<li><strong class="bold">Operators</strong>: Permission<a id="_idIndexMarker1044"/> to create and modify node groups, deploy code, run Puppet, run sign certificates, and view <span class="No-Break">the console</span></li>
				<li><strong class="bold">Viewers</strong>: Permission<a id="_idIndexMarker1045"/> to view the console, node groups, <span class="No-Break">and jobs</span></li>
				<li><strong class="bold">Code deployers</strong>: Permission<a id="_idIndexMarker1046"/> to deploy code with <span class="No-Break">Code Manager</span></li>
				<li><strong class="bold">Project deployers</strong>: Permission<a id="_idIndexMarker1047"/> to deploy projects, run tasks and plans from projects, and start, stop, and view jobs <span class="No-Break">in orchestrator</span></li>
			</ul>
			<p>Custom roles can<a id="_idIndexMarker1048"/> be created with the consultation of   <a href="https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions ">https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions </a>to find the right granularity of <span class="No-Break">user permissions.</span></p>
			<p><strong class="bold">LDAP solutions </strong>such <a id="_idIndexMarker1049"/>as <strong class="bold">Active Directory </strong>(<strong class="bold">AD</strong>) can map user groups to roles, while <strong class="bold">SAML solutions </strong>such as <strong class="bold">Okta </strong>can<a id="_idIndexMarker1050"/> do similar user group mapping with attributes to match to roles. Both LDAP and SAML are configured in the web console on the <strong class="bold">Access control </strong>tab by selecting the <span class="No-Break">corresponding option.</span></p>
			<p>Tokens are <a id="_idIndexMarker1051"/>used for all web sessions, and instead of logging in with a password whenever running commands, tokens can be generated for multiple uses. The tokens are alphanumeric values between <strong class="source-inline">0 </strong>and <strong class="source-inline">2^256 – 1 </strong>and stored in the database and, depending on the argument, a local file location. Tokens are generated by either the token API endpoint, the web console in the <strong class="bold">My account </strong>tab, the <strong class="bold">Tokens </strong>tab, or by running the <strong class="source-inline">puppet access login </strong>command on the CLI. The token is against the user credentials provided, so will have the permissions set to that user. By default, the <strong class="source-inline">puppet access login </strong>command will write the token to <strong class="source-inline">~/.puppetlabs/token </strong>with a lifetime of 30 minutes unless the <strong class="source-inline">--lifetime </strong>is used to set a lifetime such as <strong class="source-inline">5h </strong>for 5 hours.. The <strong class="source-inline">--print </strong>flag will cause the token to only be printed and not stored, which is appropriate for service-based <span class="No-Break">API access.</span></p>
			<p>The classifier service was discussed in <a href="B18492_11.xhtml#_idTextAnchor272"><span class="No-Break"><em class="italic">Chapter 11</em></span></a>, where we looked at how it used <strong class="bold">node groups </strong>to<a id="_idIndexMarker1052"/> classify servers in Puppet, but to reiterate the key points, node groups are used to classify classes to servers either by using facts or directly pinning named servers. Node groups are inheritance based, so each child of a node group will inherit everything <span class="No-Break">above it.</span></p>
			<p>Code Manager was discussed in <a href="B18492_11.xhtml#_idTextAnchor272"><span class="No-Break"><em class="italic">Chapter 11</em></span></a>, showing how the <strong class="bold">Code Manager</strong> service used <strong class="source-inline">r10k</strong> to download modules based on a Puppet file in a control repo from a named Git repository, and the <strong class="source-inline">filesync</strong> server and <strong class="source-inline">filesync</strong> clients then kept this copy of code in sync across <span class="No-Break">the services.</span></p>
			<p>The <strong class="bold">activity service </strong>is <a id="_idIndexMarker1053"/>used to log all activities that have <a id="_idIndexMarker1054"/>taken place through the console service and can be viewed by the API endpoint and on the web console in various places, such as the <strong class="bold">activity </strong>tab on any user <span class="No-Break">and role.</span></p>
			<p>The database components of Puppet Enterprise, <strong class="bold">PuppetDB</strong> with <strong class="bold">PostgreSQL</strong>, are the same as was discussed in <a href="B18492_10.xhtml#_idTextAnchor252"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>, but several of the services need additional databases to store their state and records. So, the following databases <span class="No-Break">are created:</span></p>
			<ul>
				<li><strong class="source-inline">pe-activity</strong>: All <a id="_idIndexMarker1055"/>auditable activities of <span class="No-Break">console services</span></li>
				<li><strong class="source-inline">pe-classifier</strong>: All node <span class="No-Break">group information</span></li>
				<li><strong class="source-inline">pe-inventory</strong>: Agentless client details and their access method <span class="No-Break">for orchestrator</span></li>
				<li><strong class="source-inline">pe-orchestrator</strong>: Job runs, job results, users, <span class="No-Break">and node</span></li>
				<li><strong class="source-inline">pe-postgres</strong>: Postgres databases for templating and general access. See <a href="https://www.postgresql.org/docs/current/manage-ag-templatedbs.html">https://www.postgresql.org/docs/current/manage-ag-templatedbs.html</a> to understand template <span class="No-Break">databases further.</span></li>
				<li><strong class="source-inline">pe-puppetdb</strong>: Reports, node <a id="_idIndexMarker1056"/>information, and last <span class="No-Break">run catalog</span></li>
				<li><strong class="source-inline">pe-rbac</strong>: Users, roles, groups, and <span class="No-Break">AD/LDAP information</span></li>
			</ul>
			<p class="callout-heading">Note</p>
			<p class="callout">All PostgreSQL communication is done using certificates, including communications <span class="No-Break">to replicas.</span></p>
			<p>The one component which was not covered in <span class="No-Break"><em class="italic">Figure 14</em></span><em class="italic">.1 </em>was the orchestrator services. We will now cover how orchestrator provides the capability of using Bolt plans and tasks within <span class="No-Break">Puppet Enterprise.</span></p>
			<h2 id="_idParaDest-276"><a id="_idTextAnchor347"/>Using Bolt with Puppet Enterprise</h2>
			<p>In <a href="B18492_12.xhtml#_idTextAnchor293"><span class="No-Break"><em class="italic">Chapter 12</em></span></a>, it was<a id="_idIndexMarker1057"/> seen how Bolt was run using the <strong class="source-inline">bolt </strong>binary within a Bolt project, but it can be used integrated with Puppet Enterprise via the <strong class="bold">orchestrator service</strong>, allowing<a id="_idIndexMarker1058"/> plans and tasks to be run as part of <span class="No-Break">Puppet Enterprise.</span></p>
			<p>The key difference is that currently, only Puppet modules containing tasks and plans can be deployed (including adding them to a control repo); there is no current method of deploying bolt projects to Puppet <span class="No-Break">Enterprise directly.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">With plans and tasks deployed through modules, this means the same plan or task can have multiple versions, depending on the environment it is <span class="No-Break">run from.</span></p>
			<p>It is also important <a id="_idIndexMarker1059"/>to realize not all of the features available to Bolt natively will be available within <span class="No-Break">Puppet Enterprise.</span></p>
			<p>The following list highlights the key differences when running plans and tasks in Puppet Enterprise in orchestrator instead of in <span class="No-Break">native Bolt:</span></p>
			<ul>
				<li>Various Bolt functions for plans, such as <strong class="source-inline">prompt</strong>, <strong class="source-inline">parallelize</strong>, and <strong class="source-inline">file.upload</strong>, have not <span class="No-Break">been implemented</span></li>
				<li><strong class="source-inline">puppet apply </strong>blocks can only be applied to nodes with a <span class="No-Break">Puppet agent</span></li>
				<li>Targets and the localhost target <span class="No-Break">are unavailable</span></li>
				<li>File sources must be module based and cannot be <span class="No-Break">absolute paths</span></li>
			</ul>
			<p>Most of these limitations reflect not running Bolt from a local machine and a lack of a prompt to run them. Full details can be viewed in Puppet’s documentation at  <a href="https://puppet.com/docs/pe/2021.7/plans_limitations.html"><span class="No-Break">https://puppet.com/docs/pe/2021.7/plans_limitations.html</span></a><span class="No-Break">.</span></p>
			<p>Puppet Enterprise handles three<a id="_idIndexMarker1060"/> types of nodes with plans <span class="No-Break">and tasks:</span></p>
			<ul>
				<li>Nodes with a Puppet agent installed, using<a id="_idIndexMarker1061"/> the <strong class="bold">Puppet Communications Protocol </strong>(<strong class="bold">PCP</strong>) and <a id="_idIndexMarker1062"/>the <strong class="bold">PCP Execution </strong><span class="No-Break"><strong class="bold">Protocol </strong></span><span class="No-Break">(</span><span class="No-Break"><strong class="bold">PXP</strong></span><span class="No-Break">)</span></li>
				<li>Agentless nodes via the <strong class="bold">Windows Remote Management</strong> (<strong class="bold">WinRM</strong>) and <strong class="bold">Secure Shell</strong> (<span class="No-Break"><strong class="bold">SSH</strong></span><span class="No-Break">) transports</span></li>
				<li>Agentless devices such as switches or firewalls via transports such as F5 and <strong class="bold">Palo Alto Netorks Operating system</strong> (<strong class="bold">PAN-OS</strong>) or transports provided via the <span class="No-Break">resource API</span></li>
			</ul>
			<p>Having highlighted what orchestrator is capable of running for plans and tasks, we will now look at the components that make up orchestrator, highlighting the purpose of these services and key details such as log locations and <span class="No-Break">configuration files.</span></p>
			<h2 id="_idParaDest-277"><a id="_idTextAnchor348"/>Orchestrator services</h2>
			<p>The <a id="_idIndexMarker1063"/>orchestrator application <a id="_idIndexMarker1064"/>is a <strong class="bold">Clojure </strong>application made up of the<a id="_idIndexMarker1065"/> services shown in the <span class="No-Break">following diagram:</span></p>
			<div>
				<div id="_idContainer065" class="IMG---Figure">
					<img src="image/B18492_14_03.jpg" alt="Figure 14.3 – Components of the Puppet orchestrator service"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.3 – Components of the Puppet orchestrator service</p>
			<p>Let’s have an overview of these components and their relevant services and <span class="No-Break">log files:</span></p>
			<ul>
				<li><strong class="bold">Orchestrator service</strong>: The<a id="_idIndexMarker1066"/> orchestrator service is the core service that requests for jobs, tasks, and plans are made to. Users must first be authenticated, which verifies their user and permission profile, as managed in the RBAC service. For nodes with agents, it contacts PuppetDB to retrieve facts about nodes or inventory for agentless nodes. It will update the PostgreSQL database orchestrator with details of job requests and direct jobs to service based on their transport. The orchestrator service runs under <strong class="source-inline">pe-orchestration-services.service </strong>and logs <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">/var/log/puppetlabs/orchestration-services/orchestration-services.log</strong></span><span class="No-Break">.</span></li>
				<li><strong class="bold">Inventory service</strong>: A<a id="_idIndexMarker1067"/> register of agentless clients and their access method added via the web console inventory page or via the <strong class="source-inline">POST /command/create-connection </strong>inventory API call (<a href="https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints">https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints</a>). These entries are encrypted by a secret key, by default placed at <strong class="source-inline">/etc/puppetlabs/orchestration-services/conf.d/secrets/keys.json</strong>, and although listed separately, the inventory service runs within <strong class="source-inline">pe-orchestration-services</strong>. It <a id="_idIndexMarker1068"/>stores its data in the PostgreSQL <span class="No-Break">inventory database.</span></li>
			</ul>
			<p class="callout-heading">Note</p>
			<p class="callout">Agentless nodes added to the inventory are counted within the overall licensed number of nodes for <span class="No-Break">Puppet Enterprise.</span></p>
			<ul>
				<li><strong class="bold">Bolt service</strong>: A <a id="_idIndexMarker1069"/>Ruby service that allows actions such as tasks and commands to be run over SSH and WinRM tasks to agentless nodes. It will also compute module metadata content. It runs under <strong class="source-inline">pe-bolt-server.service </strong>and logs <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">/var/log/puppetlabs/bolt-server/bolt-server.log</strong></span><span class="No-Break">.</span></li>
				<li><strong class="bold">Ace service</strong>: A <a id="_idIndexMarker1070"/>Ruby service that can run tasks, plans, and Puppet runs on agentless targets remotely, such as network switches and firewall devices using transports such as PAN-OS, F5, or any other transport defined with the resource API. The Ace service runs under <strong class="source-inline">pe-ace-server.service </strong>and logs <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">/var/log/puppetlabs/ace-server/ace-server.log</strong></span><span class="No-Break">.</span></li>
				<li><strong class="bold">PCP broker</strong>: A Clojure <a id="_idIndexMarker1071"/>application running on<a id="_idIndexMarker1072"/> a <strong class="bold">Java Virtual Machine </strong>(<strong class="bold">JVM</strong>) acting as a broker service on compiler servers that routes PXP messages using PCP, which routes PXP messages to an agent and returns them to the orchestrator. API requests are logged to <strong class="source-inline">/var/log/puppetlabs/orchestration-services/pcp-broker-access.log </strong>and general service logs are logged <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">/var/log/puppetlabs/orchestration-services/pcp-broker.log</strong></span><span class="No-Break">.</span></li>
				<li><strong class="bold">PXP agent</strong>: The <a id="_idIndexMarker1073"/>agent that allows requests for tasks to be run on Puppet clients via PXP, which sends requests for task plans etc to be applied and returns results. It runs under <strong class="source-inline">pxp-agent.service </strong>and logs <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">/var/log/puppetlabs/pxp-agent/pxp-agent.log</strong></span><span class="No-Break">.</span></li>
			</ul>
			<p>The orchestrator service will verify via RBAC that the Puppet Enterprise console user has the correct<a id="_idIndexMarker1074"/> permissions. For plans, it is only possible to specify users or groups and which plans they can run with no limit of nodes or which environment the plan will come from. For tasks, task targets allow a list of tasks and either<a id="_idIndexMarker1075"/> a <strong class="bold">Puppet Query Language </strong>(<strong class="bold">PQL</strong>) query of nodes or groups of nodes to be specified, which the tasks can be run against. This can be done either via the API call, as shown at <a href="https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target">https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target</a>, or in the RBAC GUI, as shown in the <span class="No-Break">following screenshot:</span></p>
			<div>
				<div id="_idContainer066" class="IMG---Figure">
					<img src="image/B18492_14_04.jpg" alt="Figure 14.4 – Creating a task target on the web console"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.4 – Creating a task target on the web console</p>
			<p>In the next section, we will learn how to run tasks, plans, or Puppet runs <span class="No-Break">through orchestrator.</span></p>
			<h2 id="_idParaDest-278"><a id="_idTextAnchor349"/>Running jobs</h2>
			<p>When tasks, plans, or Puppet<a id="_idIndexMarker1076"/> runs are run through orchestrator, they <a id="_idIndexMarker1077"/>become known as <strong class="bold">jobs</strong>. There are three ways to run jobs, <span class="No-Break">as </span><span class="No-Break"><a id="_idIndexMarker1078"/></span><span class="No-Break">follows:</span></p>
			<ul>
				<li>The first way to do this is via the GUI by selecting the relevant menu on the <span class="No-Break">left bar.</span></li>
				<li>The second is via the CLI on the primary server with largely the same syntax as the <strong class="source-inline">puppet task run </strong>and <strong class="source-inline">puppet plan run </strong>Bolt commands. The key differences compared to Bolt are that the <strong class="source-inline">--nodes </strong>flag is used instead of <strong class="source-inline">targets </strong>(reflecting the fact you will be just providing a node name, for which orchestrator will lookup transport information) and extra flags are available, such as the --<strong class="source-inline">node-groups </strong>flag, for choosing a node group to run against. Here’s <span class="No-Break">an example:</span><pre class="source-code">
<strong class="bold">puppet task run examplemodule::exampletask paramter1=value1 paramter2=value2 --node-group &lt;node group id&gt;</strong>
<strong class="bold">puppet plan examplemodule::exampleplan parameter1=value1  --nodes examplehost.com,examplehost2.com</strong>
<strong class="bold">puppet job run --query 'inventory { facts.os.name = "windows" }'</strong></pre></li>
				<li>The third way is via the APIs documented at  <a href="https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html">https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html</a>, with the key calls <span class="No-Break">listed here:</span><ul><li><strong class="source-inline">POST /command/deploy</strong>: Run Puppet <span class="No-Break">on demand</span></li><li><strong class="source-inline">POST /command/plan_run</strong>: Run <span class="No-Break">a plan</span></li><li><strong class="source-inline">POST /command/task</strong>: Run a task on a set <span class="No-Break">of nodes</span></li></ul></li>
			</ul>
			<p>Jobs in progress can be stopped by pressing <em class="italic">Ctrl </em>+ <em class="italic">C </em>on the CLI, selecting <strong class="bold">Stop job </strong>on the GUI, or by the <strong class="source-inline">POST /command/stop </strong>API command. Although we should be careful to note a stopped jobs underlying process may run to <span class="No-Break">completion regardless.</span></p>
			<p>An <a id="_idIndexMarker1079"/>API command was introduced in PE 2021.7.1 <strong class="source-inline">POST /command/stop_plan </strong>to allow for plans to <span class="No-Break">be stopped.</span></p>
			<p>It is also possible to schedule jobs in orchestrator via the GUI or by <strong class="source-inline">API POST /scheduled_jobs/environment_jobs</strong>, but great care should be taken to be aware of the system<a id="_idIndexMarker1080"/> load of using the scheduler. Orchestrator has limitations with how it scales since there is no way to horizontally scale, and the queuing system for tasks and plans can be easily blocked by certain types <span class="No-Break">of requests.</span></p>
			<h2 id="_idParaDest-279"><a id="_idTextAnchor350"/>Configuring performance settings</h2>
			<p>The <a id="_idIndexMarker1081"/>settings discussed in this section can all be configured in the Puppet Enterprise orchestrator infrastructure node group on the web console or as code <span class="No-Break">in Hiera.</span></p>
			<p>orchestrator can run a maximum number of tasks concurrently; this maximum number of concurrent tasks is configured with the <strong class="source-inline">puppet_enterprise::profile::orchestrator::task_concurrency </strong>parameter (default: <strong class="source-inline">250</strong>), along with <strong class="source-inline">puppet_enterprise::profile::bolt_server::concurrency </strong>(default: <strong class="source-inline">100</strong>) and <strong class="source-inline">puppet_enterprise::profile::ace_server::concurrency </strong>(default: <strong class="source-inline">100</strong>), which limit Ace and Bolt directly (they should not be greater than the <strong class="source-inline">orchestrator::task_concurrency </strong>total). Their sizes are mainly limited by orchestrator memory, which will reserve approximately ± 1 MB of RAM for each instance of capacity you add. Tasks are dealt with in the order they are received until they are completed; this means long-running tasks and tasks with large numbers of targets can potentially block other tasks from running and monopolize resources. Taking the case of running tasks taking 10 minutes to complete on 1,000, servers this would result in the task using the queue capacity of 250 four times and taking a total executing time of 40 minutes to run the tasks on all targets, during which time all other tasks would need to queue until it was complete. It is strongly recommended that a task should take no longer than 5 minutes and that careful management should take place to run tasks in smaller batches. It should also be noted there is no limit in the task queue and it risks running <strong class="bold">out-of-memory </strong>(<strong class="bold">OOM</strong>) resources <a id="_idIndexMarker1082"/>if too many requests are sent. Another effect can be the time a task takes to time out. Every 12 seconds, orchestrator will request the status of a task and after a default of 35 attempts will time out, meaning a timeout after 7 minutes. This number of attempts can be adjusted by setting the <strong class="source-inline">puppet_enterprise::profile::orchestrator::allowed_pcp_status_requests </strong>parameter. It is important to understand this does not mean the task has failed but simply that orchestrator cannot get a status for it within the timeout. The task itself may have completed after <span class="No-Break">this time.</span></p>
			<p>For <a id="_idIndexMarker1083"/>plans, orchestrator is similar to Puppet Server in requiring JRuby instances to compile plans. This capacity is set by <strong class="source-inline">puppet_enterprise::profile::orchestrator::jruby_max_active_instances</strong>, with heap memory for the JVM set <span class="No-Break">at </span><span class="No-Break"><strong class="source-inline">puppet_enterprise::profile::orchestrator::java_args</strong></span><span class="No-Break">.</span></p>
			<p>Having discussed the core components and services of Puppet Enterprise, we will now look at how these components can be deployed using automated tools, deploying to Puppet-advised reference architectures to ensure that infrastructure will scale to <span class="No-Break">user requirements.</span></p>
			<h1 id="_idParaDest-280"><a id="_idTextAnchor351"/>Automating deployment and reference architectures</h1>
			<p>Puppet Enterprise focuses<a id="_idIndexMarker1084"/> on creating standard architectures and configurations and the automation to deploy them. This ensures that less design effort is required from Puppet Enterprise customers who can find the right standard architecture and pattern and deploy it using <span class="No-Break">provided tooling.</span></p>
			<h2 id="_idParaDest-281"><a id="_idTextAnchor352"/>Understanding supported architectures</h2>
			<p>Puppet documents<a id="_idIndexMarker1085"/> three supported architectures for Puppet Enterprise, <span class="No-Break">as follows:</span></p>
			<ul>
				<li>The <strong class="bold">standard installation </strong>is<a id="_idIndexMarker1086"/> just a standalone primary server and supports up to <span class="No-Break">2,500 clients</span></li>
				<li>The <strong class="bold">large installation </strong>is a <a id="_idIndexMarker1087"/>primary server with compile servers behind a load balancer and supports up to <span class="No-Break">20,000 clients</span></li>
				<li><strong class="bold">Extra-large installations </strong>are a primary server, a separate server with PuppetDB, and <a id="_idIndexMarker1088"/>compile servers <a id="_idIndexMarker1089"/>behind a load balancer supporting over <span class="No-Break">20,000 servers</span></li>
			</ul>
			<p>These are<a id="_idIndexMarker1090"/> illustrated in the <span class="No-Break">following diagram:</span></p>
			<div>
				<div id="_idContainer067" class="IMG---Figure">
					<img src="image/B18492_14_05.jpg" alt="Figure 14.5 – Standard architectures"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.5 – Standard architectures</p>
			<p>The standard architecture is limited by how many clients a primary server can run catalogs for by itself, up to 2,500 nodes. Over this level, the large architecture allows horizontal scaling using compiler nodes but reaches limits of how much load a single primary server can take running all the services together. So, at 25,000 nodes, the extra-large architecture recommends separating out PuppetDB as one of the heaviest services to its <span class="No-Break">own server.</span></p>
			<p>In all these architectures, it is <a id="_idIndexMarker1091"/>possible to provide a replica server to the primary server and a separate PostgreSQL server, through a method<a id="_idIndexMarker1092"/> named <strong class="bold">disaster recovery </strong>(<strong class="bold">DR</strong>). In the event of loss of the primary or PostgreSQL server, DR gives the ability to perform failover actions <a id="_idIndexMarker1093"/>and recover services with an expected loss of some services, as listed in the following tabular breakdown <span class="No-Break">of services:</span></p>
			<table id="table001-6" class="No-Table-Style _idGenTablePara-1">
				<colgroup>
					<col/>
					<col/>
					<col/>
				</colgroup>
				<tbody>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="bold">Service name</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="bold">Replication type</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="bold">Failover approach</strong></span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Puppet Server</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">None</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Active / <span class="No-Break">Active</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>Console <span class="No-Break">services UI</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">None</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">ACE service</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">None</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Bolt service</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">None</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">CA</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">One-way replication</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">RBAC</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">One-way replication</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Classifier</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">One-way replication</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Activity</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">One-way replication</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Orchestration</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">One-way replication</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">File sync</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">One-way replication</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Read-only until <span class="No-Break">manual promotion</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">PuppetDB</span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break">Bi-directional</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Active – <span class="No-Break">Active</span></p>
						</td>
					</tr>
				</tbody>
			</table>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 14.1 – Service replication and failover approach for DR</p>
			<p>PuppetDB is <a id="_idIndexMarker1094"/>unique in its synchronization within Puppet Enterprise; it performs a read-write synchronization between primary and replica, which is why it is the only service in the previous list that synchronizes and is available on promotion. The other services that use PostgreSQL rely on a <strong class="source-inline">PGLogical </strong>synchronization from primary to replica, making the data read-only on <span class="No-Break">the replica.</span></p>
			<p>What can be seen from this list is during the failure of a primary server, the replica will only be able to take over and compile catalogs of servers already registered, queries and reports from PuppetDB, and queries of node classification via the API. This means no new servers can be registered or removed, no new code can be deployed, the web console cannot be used, classification cannot be changed, and most of the CLI tools will be non-functional until manual promotion actions are taken via the <strong class="source-inline">puppet infrastructure promote replica </strong>command on <span class="No-Break">the replica.</span></p>
			<p>This is an irreversible action, and the original failed primary server must be redeployed as a replica before it can be used again. Therefore, for many users attempting to fix the original primary server, this is less time-consuming than going through the <span class="No-Break">DR process.</span></p>
			<p>DR should not be confused <a id="_idIndexMarker1095"/>with <strong class="bold">high availability </strong>(<strong class="bold">HA</strong>), which would be expected for continuous service in the event of the loss of a server, and that is not possible in any current <span class="No-Break">Puppet architecture.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">When using DR, peadm ensures that the compilers are split and configured into two groups and PuppetDB requests are distributed across the two sides of the PuppetDB replication to maximize capacity. If you choose not to use pecdm, ensure you follow this optimization, which can be seen in code at <a href="https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp">https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp</a>, with the A and B groups setting parameters <span class="No-Break">for databases.</span></p>
			<p>The Puppet architecture <a id="_idIndexMarker1096"/>also defines a set of multi-region patterns for how to deploy across regions both public  and private cloud, where a region is defined by cloud vendors as data centers with regional low-latency connections. Full details are available at <a href="https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html">https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html</a>. Best practice requires compilers to have low-latency connections, and these are therefore <a id="_idIndexMarker1097"/>best placed in the same region as primary and replica servers; similarly, the connection between primary and replica must be low latency. The best practice is, therefore, to use a centralized deployment where all Puppet infrastructure is in a management region that all regions can communicate with, as shown in the <span class="No-Break">following diagram:</span></p>
			<div>
				<div id="_idContainer068" class="IMG---Figure">
					<img src="image/B18492_14_06.jpg" alt="Figure 14.6 – Centralized and federated deployments"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.6 – Centralized and federated deployments</p>
			<p>Alternatively, a federated model can be used whereby Puppet infrastructure is placed in each region, with the<a id="_idIndexMarker1098"/> downside that no single console views the <span class="No-Break">whole estate.</span></p>
			<p>Having discussed the architectures and patterns in full, it is time to see which tooling is available to deploy <span class="No-Break">these patterns.</span></p>
			<h2 id="_idParaDest-282"><a id="_idTextAnchor353"/>Deployment and configuration</h2>
			<p>Puppet automates<a id="_idIndexMarker1099"/> the deployment of its server infrastructure in several layers. The first layer uses the Puppet Enterprise installer, a tarball file that is downloaded from Puppet containing all the necessary packages and scripts to install Puppet Enterprise. Once downloaded on a target server and untarred, the basic install can be done by running <strong class="source-inline">./puppet-enterprise-installer</strong>. It is possible to add <a id="_idIndexMarker1100"/>custom configurations by creating a <strong class="bold">Human-Optimized Config Object Notation </strong>(<strong class="bold">HOCON</strong>)-formatted file and adding a <strong class="source-inline">-c </strong>flag to its location, following the guidance at  <a href="https://puppet.com/docs/pe/2021.7/installing_pe.html">https://puppet.com/docs/pe/2021.7/installing_pe.html</a>. Once a Puppet server is configured, the install scripts can be used to automate adding agents; a Bash script for Unix-based <a id="_idIndexMarker1101"/>systems and a PowerShell script for Windows are hosted on a file server on the primary, which ensures the correct agent package <span class="No-Break">is installed:</span></p>
			<pre class="source-code">
uri='https://&lt;PRIMARY_HOST&gt;:8140/packages/current/install.bash' curl --insecure "$uri" | sudo bash -s -- --puppet-service-ensure stopped agent:environment=production
[Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}; $webClient = New-Object System.Net.WebClient; $webClient.DownloadFile('https://&lt;PRIMARY_HOST&gt;:8140/packages/current/install.ps1', 'install.ps1'); .\install.ps1 -PuppetServiceEnsure stopped agent:environment=production</pre>
			<p>In the example, the options set <strong class="source-inline">environment </strong>to <strong class="source-inline">production </strong>in the <strong class="source-inline">puppet.conf </strong>file and ensure the service is not running. The full range of options is available and documented <span class="No-Break">at </span><a href="https://puppet.com/docs/pe/2021.7/installing_agents.html"><span class="No-Break">https://puppet.com/docs/pe/2021.7/installing_agents.html</span></a><span class="No-Break">.</span></p>
			<p>This <strong class="source-inline">install </strong>script would only have installed the primary server and would require further manual steps to add compilers and replicas depending on the architecture we wanted. To deploy the next layer instead of using the Enterprise installer directly, we use the peadm module (<a href="https://forge.puppet.com/modules/puppetlabs/peadm">https://forge.puppet.com/modules/puppetlabs/peadm</a>), a supported Puppet module that provides an automated way to run the Puppet Enterprise installer script and configure it to one of the supported architectures automatically. This module <a id="_idIndexMarker1102"/>assumes the infrastructure required for the requested configuration is available and it is possible to go to another level and automatically provision in public cloud environments using the pecdm module (<a href="https://github.com/puppetlabs/puppetlabs-pecdm">https://github.com/puppetlabs/puppetlabs-pecdm</a>). An example of usage of these modules was discussed in detail in <a href="B18492_12.xhtml#_idTextAnchor293"><span class="No-Break"><em class="italic">Chapter 12</em></span></a><em class="italic"> </em>and is what we have been using throughout this book to <span class="No-Break">deploy labs.</span></p>
			<p>The <strong class="source-inline">peadm </strong>module itself goes beyond simple deployment and has plans and tasks to show the status of the server and allow the performance of version upgrades via its tasks <span class="No-Break">and plans.</span></p>
			<p>Puppet Enterprise <a id="_idIndexMarker1103"/>combines modules installed in the <strong class="source-inline">Enterprise </strong>folder and configured either in the classifier or Hiera data with other file locations to place customizations. The console has a number of configurations that can be set either in the classification in the web console or via Hiera, such as failed login attempts set by <strong class="source-inline">puppet_enterprise::profile::console::rbac_failed_attempts_lockout </strong>and password complexity rules such as minimum password length, set by <strong class="source-inline">puppet_enterprise::profile::console::password_minimum_length</strong>. A full list of console customizations can be found <span class="No-Break">at </span><a href="https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services"><span class="No-Break">https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services</span></a><span class="No-Break">.</span></p>
			<p>In addition, files can be placed for the console, by placing a file at the path specified by <strong class="source-inline">puppet_enterprise::profile::console::disclaimer_content_path</strong>, which defaults to <strong class="source-inline">/etc/puppetlabs/console-services</strong>. You can create a message to display when logging in to the console, such as a legal warning your organization <span class="No-Break">may have.</span></p>
			<p>Additionally in the console, it is possible to search for nodes based on PQL with predefined PQL examples selectable. It is possible to add your own PQL examples to the web console by simply placing a file at <strong class="source-inline">/etc/puppetlabs/console-services/custom_pql_queries.json </strong>using <strong class="source-inline">/etc/puppetlabs/console-services/custom_pql_queries.json.example </strong>as a template. The web console itself uses a self-signed CA by default, and this can be replaced with one signed by your organization’s CA system by placing the generated certificate at <strong class="source-inline">/etc/puppetlabs/puppet/ssl/certs/console-cert.pem </strong>and <strong class="source-inline">/etc/puppetlabs/puppet/ssl/private_keys/console-cert.pem</strong>. One last key file to consider is the license key, which is issued to you by Puppet and placed at <strong class="source-inline">/etc/puppetlabs/license.key </strong>with <strong class="source-inline">644 root:root </strong>permissions. You can view the details of licensing under the <strong class="bold">License </strong>tab on the web console. A Puppet agent run should be made for these changes and the console <span class="No-Break">service restarted.</span></p>
			<p>Some areas <a id="_idIndexMarker1104"/>of Puppet Enterprise are not currently<a id="_idIndexMarker1105"/> definable through native code such as RBAC, classification, and LDAP, but there are APIs and Puppet modules that take advantage of those APIs, which can allow for storing configuration. For classification, there is an API to view the classification and configure node groups; this can also be done via the <strong class="bold">node_manager </strong>module (<a href="https://forge.puppet.com/modules/WhatsARanjit/node_manager">https://forge.puppet.com/modules/WhatsARanjit/node_manager</a>), which is used by peadm. For RBAC and LDAP, the RBAC API (<a href="https://puppet.com/docs/pe/2021.7/rbac-api.htm">https://puppet.com/docs/pe/2021.7/rbac-api.htm</a>) has endpoints that can be used to manage groups, roles, and users. A Puppet module has been developed to use these APIs (<a href="https://forge.puppet.com/modules/pltraining/rbac">https://forge.puppet.com/modules/pltraining/rbac</a>) and it has an LDAP endpoint that has similarly had a module developed to use the <span class="No-Break">APIs (</span><a href="https://forge.puppet.com/modules/abuxton/puppet_ds).&#13;"><span class="No-Break">https://forge.puppet.com/modules/abuxton/puppet_ds).</span></a></p>
			<p>Having reviewed the architecture and deployment recommendations, we will discuss other supporting tools and products to work with Puppet in the <span class="No-Break">following section.</span></p>
			<h1 id="_idParaDest-283"><a id="_idTextAnchor354"/>Puppet Enterprise-related projects and tooling</h1>
			<p>Puppet Enterprise <a id="_idIndexMarker1106"/>has several modules and tools developed by Puppet to ease the management and support of Puppet infrastructure. The most direct is the built-in support script; this command gathers logs and system information and compresses it allowing users to send detailed status information to cases with Puppet’s support teams. The simple version of the command is shown here: <strong class="source-inline">/opt/puppetlabs/bin/puppet </strong><span class="No-Break"><strong class="source-inline">enterprise support</strong></span><span class="No-Break">.</span></p>
			<p>Various options can be found in the documentation at <a href="https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script">https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script</a> that allow for <a id="_idIndexMarker1107"/>selecting services to be collected, to directly <strong class="bold">Secure File Transfer Protocol</strong> (<strong class="bold">SFTP</strong>) upload the archive as part of the command, and to encrypt the archive, assuming <strong class="bold">GNU Privacy Guard</strong> (<strong class="bold">GPG</strong>) keys <span class="No-Break">are available.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">It is possible to <a id="_idIndexMarker1108"/>use <strong class="bold">SOScleaner </strong>to remove hostnames and IP addresses from the support script contents. Visit <a href="https://support.puppet.com/hc/en-us/articles/115003312887">https://support.puppet.com/hc/en-us/articles/115003312887</a> for details on how to install and <span class="No-Break">run it.</span></p>
			<p>Having seen how to deploy Puppet infrastructure, it is important for you to understand how to monitor and troubleshoot any issues found, so let’s look at <span class="No-Break">that next.</span></p>
			<h2 id="_idParaDest-284"><a id="_idTextAnchor355"/>Monitoring and troubleshooting Puppet Enterprise infrastructure</h2>
			<p>The <strong class="bold">Puppet Enterprise status_check module </strong>(<a href="https://forge.puppet.com/modules/puppetlabs/pe_status_check">https://forge.puppet.com/modules/puppetlabs/pe_status_check</a>) performs<a id="_idIndexMarker1109"/> checks on both<a id="_idIndexMarker1110"/> Puppet infrastructure servers and Puppet agents based on commonly found issues in support cases, such as confirming services are running, disk<a id="_idIndexMarker1111"/> space is free, and certificates are not expiring. These checks can be run as tasks, Puppet code that will notify issues into reports, or as facts—the Splunk plugin shown in <a href="B18492_13.xhtml#_idTextAnchor321"><span class="No-Break"><em class="italic">Chapter 13</em></span></a><em class="italic"> </em>has a dashboard for displaying the fact output. Using these checks means if you do experience any issues when you raise your support case with Puppet, you can reference the <span class="No-Break">check number.</span></p>
			<p>The <strong class="bold">support_tasks module </strong>(<a href="https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks">https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks</a>) provides tasks that perform <a id="_idIndexMarker1112"/>actions set out in knowledge base articles such as regenerating certificates, running the support script, and printing Puppet database <span class="No-Break">table sizes.</span></p>
			<p>Some extra console views can be configured to be visible and usable in the console; value reporting simply needs values entered in the <strong class="bold">Value report </strong>tab for how much time is to be reclaimed by using tasks, plans, corrective changes, and intentional changes, and it will also <span class="No-Break">generate statistics.</span></p>
			<p>Puppet Enterprise can<a id="_idIndexMarker1113"/> gather additional information about packages including unmanaged packages; this information is made visible in the <strong class="bold">Packages </strong>tab. This will show which packages are installed on each server, what type of package they are, their version, and if they are managed by Puppet. It is enabled by adding the <strong class="source-inline">puppet_enterprise::profile::agent </strong>class to a node group covering nodes you wish to collect from and by setting the <strong class="source-inline">package_inventory_enabled </strong>parameter <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">true</strong></span><span class="No-Break">.</span></p>
			<p>The final extra that can be enabled <a id="_idIndexMarker1114"/>allows the monitoring and management of patching. In the <strong class="bold">Patches </strong>tab, it will create a view of nodes managed, patches available, and an option to run a task to patch. This is enabled by creating a node group under the <strong class="bold">PE Patch Management </strong>group that contains the <span class="No-Break"><strong class="source-inline">pe_patch </strong></span><span class="No-Break">class.</span></p>
			<p>In addition to the core Puppet Enterprise infrastructure, there are additional Puppet products allowing management of pipelines for code deployment onto Puppet Enterprise and for compliance scans to be run on <span class="No-Break">Puppet nodes.</span></p>
			<h2 id="_idParaDest-285"><a id="_idTextAnchor356"/>Managing deployments and ensuring compliance</h2>
			<p>There are<a id="_idIndexMarker1115"/> two additional Puppet products to consider using with Puppet Enterprise, <strong class="bold">Continuous Delivery for Puppet Enterprise </strong>(<strong class="bold">CD4PE</strong>) is a<a id="_idIndexMarker1116"/> pipelining product for Puppet built on the acquired Distelli pipelining<a id="_idIndexMarker1117"/> product that looks to automate the process of managing deployment of Puppet code. It can watch for events such as <strong class="bold">pull requests </strong>(<strong class="bold">PRs</strong>) or <a id="_idIndexMarker1118"/>commits to control or module repositories and then runs through pipelines that can automatically perform checks such as <strong class="bold">Puppet Development Kit </strong>(<strong class="bold">PDK</strong>) or <strong class="bold">Onceover </strong>checks and bring its own check of impact analysis. If <a id="_idIndexMarker1119"/>checks whether the pipelines pass or are approved, and can then deploy and apply the code in various patterns. Impact analysis uses the <strong class="source-inline">v4 </strong>catalog API to compile a new catalog with the new code and compare it with the current code’s catalog, displaying the difference to ensure the impact is as the developer expected. These pipelines can be made in the web console for CD4PE or created as code in YAML files inserted into modules and control repos to <span class="No-Break">be deployed.</span></p>
			<p><strong class="bold">Puppet Comply </strong>is a<a id="_idIndexMarker1120"/> compliance tool based <a id="_idIndexMarker1121"/>on<a id="_idIndexMarker1122"/> the <strong class="bold">Centre for Internet Security </strong>(<strong class="bold">CIS</strong>) benchmarks. It builds automation around the Java scanner developed by CIS, CIS-CAT Pro accessor (<a href="https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro">https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro</a>). This allows hosts to be accessed against the CIS benchmarks, using orchestrator in Puppet Enterprise to automate and schedule runs of the scanner via tasks and producing dashboards of their compliance in a separate Puppet Comply console. An example of the home screen of Comply is shown in the <span class="No-Break">following screenshot:</span></p>
			<p class="IMG---Figure"> </p>
			<div>
				<div id="_idContainer069" class="IMG---Figure">
					<img src="image/B18492_14_07.jpg" alt="Figure 14.7 – Puppet Comply home dashboard"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.7 – Puppet Comply home dashboard</p>
			<p>It can be seen from the <a id="_idIndexMarker1123"/>dashboard how many of the nodes are achieving compliance, how many nodes have a compliance profile set, and a list of node results listing which profile is assigned and compliance scores in a <span class="No-Break">particular scan.</span></p>
			<p>It also comes with the <a id="_idIndexMarker1124"/>premium <strong class="bold">compliance enforcement modules </strong>(<strong class="bold">CEM</strong>) of <strong class="source-inline">cem_linux </strong>(<a href="https://forge.puppet.com/modules/puppetlabs/cem_linux">https://forge.puppet.com/modules/puppetlabs/cem_linux</a>) and <strong class="source-inline">cem_windows </strong>(<a href="https://forge.puppet.com/modules/puppetlabs/cem_windows">https://forge.puppet.com/modules/puppetlabs/cem_windows</a>) to speed up your adoption of Puppet, allowing base security configuration to be taken based on CIS benchmarks via pre-made Puppet modules. These modules are maintained and supported by Puppet, ensuring the enforcement code is up to date with the latest <span class="No-Break">CIS benchmarks.</span></p>
			<p>Both products run in the framework <a id="_idIndexMarker1125"/>known as <strong class="bold">Puppet Application Manager </strong>(<strong class="bold">PAM</strong>), a Kubernetes-based tool for managing <span class="No-Break">Puppet applications.</span></p>
			<h1 id="_idParaDest-286"><a id="_idTextAnchor357"/>Lab – Puppet Enterprise extensions and configuration</h1>
			<p>Executing <a id="_idIndexMarker1126"/>the bolt command in the <em class="italic">technical requirements </em>section deploys a large deployment of Puppet Enterprise 2021.5. With this infrstructure setup, we will try various extensions and configurations we have discussed, <span class="No-Break">as follows:</span></p>
			<ol>
				<li>Examine the code in peadm and the node groups that set up the A and B groups. Note <a href="https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md">https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md</a> provides an explanation of <span class="No-Break">the groups.</span></li>
				<li>Create a personal user with permission to view the console and create node groups and view the activity log of the administrator user (try to log in without the view <span class="No-Break">console permissions).</span></li>
				<li>Enable package management on the web console for all nodes, log in as your personal user, and view the activity log <span class="No-Break">of this.</span></li>
				<li>Enable patch management for the nodes by applying code using the <span class="No-Break"><strong class="source-inline">node_manager </strong></span><span class="No-Break">module.</span></li>
				<li>Customize the <span class="No-Break">login message.</span></li>
				<li>Perform an upgrade to 2021.6 using the peadm upgrade plan. <em class="italic">Note</em>: Since pecdm includes peadm, this can be performed from your <span class="No-Break">development environment.</span></li>
			</ol>
			<p>Sample solutions are provided <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14"><span class="No-Break">https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-287"><a id="_idTextAnchor358"/>Summary</h1>
			<p>This chapter has reviewed how Puppet Enterprise builds on top of the open source tooling, providing the services necessary to secure and automate the deployment of Puppet. It was discussed how Puppet Enterprise bundled the open source packages into consistent versions, with support offerings and services from Puppet architecture and <span class="No-Break">services teams.</span></p>
			<p>We also discussed the additional services of Puppet Enterprise that secure user and API access via RBAC, giving a web frontend and additional APIs in the console services the ability to deploy code from <span class="No-Break">Code Manager.</span></p>
			<p>Puppet orchestrator was then seen, to show how tasks and plans could be run in Puppet Enterprise with the orchestrator service running tasks and plans via PCP using PXP brokers to direct communication from PXP agents on nodes. The agentless clients could be added to the inventory service storing their transport details, and tasks or plans to run on them would ego via the Bolt server for nodes connected by WinRM or SSH, while other transports’ particular network devices such as switches or firewalls used the ACE server. We saw how orchestrator would store all the job details updating the activity service. RBAC access was discussed, showing how you could only limit which plans were available to a user but could set tasks to particular users and particular groups of nodes using target sets. Performance and capacity aspects of orchestrator were discussed, as well as how to run tasks or plans via the web console GUI or the <span class="No-Break">CLI interface.</span></p>
			<p>The supported architectures customers could take off the shelf to implement Puppet at scale and regional requirements for their estate were reviewed, showing the modules and scripts that wrap up to automatically deploy these architectures, the pecdm module deploying infrastructure in the public cloud, peadm automating the various steps of install and maintenance, and using the <span class="No-Break">installer script.</span></p>
			<p>Extras services that could be enabled in the web console to help report on the value Puppet delivers, patch management, and packaging reporting were reviewed, along with customizations and methods to automate configuration within the console covering customization of the console message, the certificate used on the web console, and the license key. Several modules were then discussed that could assist in reporting the status of the infrastructure and running standard tasks in the <strong class="source-inline">support_task</strong> and <span class="No-Break"><strong class="source-inline">status_check</strong></span><span class="No-Break"> modules.</span></p>
			<p>Two further Puppet products that integrate with Puppet Enterprise were then discussed: CD4PE, which provides a pipeline to assist in automating the deployment of code, and Puppet Comply, which gives pre-written modules and dashboards to allow for reporting on <span class="No-Break">CIS benchmarks.</span></p>
			<p>While all of the architecture, tooling, packaging, and general automation could be achieved with Open Source Puppet, it would require development and support work from your own teams. So, Puppet Enterprise should be seen as a decision about the skills and people available in your team, tooling already invested in the organization and money available for tooling, and where your organization wants to focus <span class="No-Break">its work.</span></p>
			<p>Now, having fully reviewed the language, the platform, and how Puppet Enterprise can provide preconfigured infrastructure to reduce the operational burden and design required, in the final chapter, we will discuss approaches to adopting and using Puppet, focusing on getting the best use in your organization, since understanding the technology is only part of the battle while understanding how to integrate with people and processes is often the <span class="No-Break">greater challenge.</span></p>
		</div>
	</body></html>