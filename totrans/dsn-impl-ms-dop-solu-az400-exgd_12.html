<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer181">
<h1 class="chapter-number" id="_idParaDest-300"><a id="_idTextAnchor978"/>12</h1>
<h1 id="_idParaDest-301"><a id="_idTextAnchor979"/>Application Monitoring</h1>
<p>In the previous chapters, you learned about applying DevOps principles to software delivery. You learned how to create a pipeline from source control all the way to production. You also learned how to ensure that your delivery is compliant and secure, without sacrificing speed or a focus on the delivery of business value. In this chapter, you will learn how to start transforming this pipeline into a DevOps loop, a continuous process of delivering new software, and then measure how your application performs. This is a continuous journey, as you evaluate how your application fares in production and learn how to proceed next.</p>
<p>To do this, this chapter starts by introducing a means for gathering application crashes. Almost every application will, at some point, throw an unhandled exception and crash. Ensuring that application crashes are gathered and reported will enable you to investigate the causes and address them. Then, attention will shift to instrumenting applications.</p>
<p>Instrumentation is the practice of gathering logs and metrics that help you understand how your application performs in production. You can use them to get alerts when things go wrong or, hopefully, before they go wrong. The chapter concludes by exploring several options for integrating with other tools.</p>
<p>The following topics are covered in this chapter:</p>
<ul>
<li>Investigating application crashes</li>
<li>Instrumenting web applications</li>
<li>Integrating with other tools</li>
</ul>
<h1 id="_idParaDest-302"><a id="_idTextAnchor980"/><a id="_idTextAnchor981"/>Technical requirements</h1>
<p>To experiment with the techniques described in this chapter, you will need one or more of the following:</p>
<ul>
<li>An App Center account for gathering mobile application crashes </li>
<li>A Raygun subscription for gathering desktop application crashes </li>
<li>An Azure subscription for instrumenting web applications</li>
</ul>
<p><a id="_idTextAnchor982"/>Free-trial options are available for all of these.</p>
<h1 id="_idParaDest-303"><a id="_idTextAnchor983"/>Investigating application crashes</h1>
<p>No matter how well an application is engineered, at some point, it will crash due to an unexpected <a id="_idIndexMarker1066"/>condition. To learn from these crashes and to try and prevent them in the future, it helps to add code to applications to gather crash reports and send them to a central location. Here, they can be analyzed and grouped to identify application improvements. How to do this differs, depending on the type of application.</p>
<p>The following sections discuss how this process for mobile and desktop applications works. Regarding web applications, gathering crash reports can be done using the same tool as for<a id="_idTextAnchor984"/> instrumentation; we will discuss this in the <em class="italic">Instrumenting web applications</em> section later on.<a id="_idTextAnchor985"/></p>
<h2 id="_idParaDest-304"><a id="_idTextAnchor986"/>Gathering crash reports for mobile applications</h2>
<p>One of the <a id="_idIndexMarker1067"/>many tools <a id="_idIndexMarker1068"/>available for gathering crash reports and errors from mobile applications is Visual Studio App Center. Besides distributing mobile applications, <strong class="bold">App Center</strong> also allows <a id="_idIndexMarker1069"/>applications to submit their crashes and errors for analys<a id="_idTextAnchor987"/>is.</p>
<p>To get started with crash reporting using App Center, the application first needs to be defined. This is called an app definition and how to work with it was discussed in<em class="italic"> </em><a href="B18655_06.xhtml#_idTextAnchor330"><em class="italic">Chapter 6</em></a>, <em class="italic">Implementing Continuous Deployment and Release Management</em>. With this app definition, an app secret is created, which is needed to configure an application to send out crash reports. Along with crash reports, it is possible to track other errors, and exceptions that are of interest to developers. To start sending crash reports, the following steps need to be performed:</p>
<ol>
<li>Install the <strong class="source-inline">Microsoft.AppCenter.Crashes</strong> NuGet package in the project.</li>
<li>Add the following code to the application initialization:</li>
</ol>
<pre class="source-code">
AppCenter.Start("ios={appSecret};android={appSecret
};uwp={appSecret}", typeof(Crashes));</pre>
<p>Besides crashes, it is also possible to track other errors that are of interest to developers. This can be done using the following code:</p>
<pre class="source-code">
Crashes.TrackError(ex);</pre>
<p>All the <a id="_idIndexMarker1070"/>unhandled exceptions are automatically <a id="_idIndexMarker1071"/>caught and sent back to App Center. Here, they become available for analysis, as shown in the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer168">
<img alt="Figure 12.1 – An App Center diagnostics overview " height="799" src="image/B18655_12_01.jpg" width="1367"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.1 – An App Center diagnostics over<a id="_idTextAnchor988"/>view</p>
<p>Click on any of the reported errors or crashes to open a detailed view, as shown here:</p>
<div>
<div class="IMG---Figure" id="_idContainer169">
<img alt="Figure 12.2 – An App Center diagnostics detailed view " height="755" src="image/B18655_12_02.jpg" width="1374"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.2 – An App Center diagnostics detailed view</p>
<p>A dashboard <a id="_idIndexMarker1072"/>with the most important information is <a id="_idIndexMarker1073"/>shown for each crash or error. This includes the number of reports and the number of affected users. Also, the impacted device types and operating systems are shown. At the top of the page, the stack traces are shown, which can be used by developers to investigate and, hopefully, fix the issue.</p>
<p>App Center has integration with Azure DevOps, Jira, and GitHub for bug tracking purposes. Refer to this <a id="_idIndexMarker1074"/>link for more information: <a href="https://docs.microsoft.com/en-us/appcenter/dashboard/bugtracker/">https://docs.microsoft.com/en-us/appcenter/dashboard/bugtracker/</a>.</p>
<p>For any critical events, App Center can directly create a bug and send email notifications.</p>
<p>That covers gathering crash reports and errors from mobile applications. The next section introduces the same concepts for desktop applica<a id="_idTextAnchor989"/><a id="_idTextAnchor990"/><a id="_idTextAnchor991"/>tions.</p>
<h2 id="_idParaDest-305"><a id="_idTextAnchor992"/>Gathering crash reports for desktop applications</h2>
<p>Crash <a id="_idIndexMarker1075"/>reporting <a id="_idIndexMarker1076"/>is also available for desktop <a id="_idIndexMarker1077"/>applications. There are, again, many solutions available for desktop applications and most of them <a id="_idIndexMarker1078"/>work in roughly the same way. One of these solutions is Raygun. Raygun is a commercial offering available for .NET applications but works for many other languages and platforms as well.</p>
<p>To gather crashes using Raygun, follow these three steps:</p>
<ol>
<li value="1">Sign up for a Raygun account.</li>
<li>Install the <strong class="source-inline">Mindscape.Raygun4Net</strong> NuGet package on the solution.</li>
<li>Catch unhandled exceptions and forward them to Raygun.</li>
</ol>
<p>The following example shows you how to catch and forward unhandled exceptions to Raygun:</p>
<pre class="source-code">
class Program
  {
    private static readonly RaygunClient _raygunClient = new RaygunClient("myKey");
    static void Main(string[] args)
    {
      AppDomain.CurrentDomain.UnhandledException += HandleEx; throw new Exception("Boom!");
    }
    private static void HandleEx(object sender, UnhandledExceptionEventArgs e)
    {
      _raygunClient.Send(e.ExceptionObject as Exception);
    }
  }</pre>
<p>All <a id="_idIndexMarker1079"/>the exceptions <a id="_idIndexMarker1080"/>can be explored in the Raygun web interface. Here, exceptions <a id="_idIndexMarker1081"/>are automatically grouped if stack traces are sufficiently similar. They can also be grouped and browsed individually, but in most cases, it makes sense to only focus on the larger groups o<a id="_idTextAnchor993"/>f exceptions.</p>
<p>The following screenshot shows how these groups can be browsed in Raygun:</p>
<div>
<div class="IMG---Figure" id="_idContainer170">
<img alt="Figure 12.3 – The Raygun view for desktop application exceptions  " height="529" src="image/B18655_12_03.jpg" width="1066"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.3 – The Raygun view for desktop application exceptions </p>
<p>Clicking on the exception message in this interface shows the complete stack trace and all the shared properties of any instance of the exception that has occurred.</p>
<p>This completes our look into gathering crash reports from mobile and desktop applications. Doing so allows you to find and investigate issues that customers face in production. In the following section, instrumentation for web applications will be introduced to fur<a id="_idTextAnchor994"/>ther enhance our insight into how applications behave in<a id="_idTextAnchor995"/> production.</p>
<h1 id="_idParaDest-306"><a id="_idTextAnchor996"/>Instrumenting web applications</h1>
<p>Web applications differ from mobile and desktop applications in many ways, including the fact that large portions of the application run on a server rather than a client. This enables developers to collect information on how web applications are run more easily than other types of applications. This is known as instrumenting an application.</p>
<p>Logs are text messages that are saved by a system to describe the execution path that the server follows. This <a id="_idIndexMarker1082"/>helps developers go back in time and explore what has happened by examining the logging output. Structured logging is quickly becoming the standard for trace logging. <strong class="bold">Structured logging</strong> is a technique where logs are no longer <a id="_idIndexMarker1083"/>only text messages. Instead, logs are parameterized text messages with a set of values for each parameter. This has two advantages – logs can be better compressed, and they can be searched more quickly.</p>
<p><strong class="bold">Metrics</strong> are values that <a id="_idIndexMarker1084"/>are recorded for an application. They take the form of a timestamp, metric name, and value. One example is recording the percentage of a CPU in use every second.</p>
<p>When instrumenting an application, it is easy to focus on many server-level types of logs and metrics. For example, many operators will, by default, start collecting metrics such as CPU usage, memory pressure, and I/O operations. While there is nothing wrong with these metrics, they are not always indicative of an application’s performance from a user’s point of view. Other metrics, such as response times or queue message processing delays, might yield better insights into the user experience. While there is nothing wrong with measuring system metrics (they are often great indicators of future issues), you should also try to gather user-centric metrics.</p>
<p>Azure offers the Application Insights service for instrumenting applications, with a focus on web applications. An Application Insights workspace can be created using the Azure portal, which opens up a workspace, as shown in the following screenshot. In Azure portal in overview section, <strong class="bold">instrumentation key</strong> field is plainly shown, it is recommended that you treat this as an application secret:</p>
<div>
<div class="IMG---Figure" id="_idContainer171">
<img alt="Figure 12.4 – Azure Application Insights Overview " height="577" src="image/B18655_12_04.jpg" width="1206"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.4 – Azure Application In<a id="_idTextAnchor997"/>sights Overview</p>
<p>The following <a id="_idIndexMarker1085"/>subsections will go into detail about logging, metrics, a<a id="_idTextAnchor998"/>nd investigating indi<a id="_idTextAnchor999"/>vidual requests.</p>
<h2 id="_idParaDest-307"><a id="_idTextAnchor1000"/>Logging</h2>
<p>One of the most <a id="_idIndexMarker1086"/>basic types of instrumentation is adding logging statements to <a id="_idIndexMarker1087"/>application code. In the past, these logs were saved to the disk of the server that ran the application. Retrieving and investigating these logs, therefore, took a lot of time and effort.</p>
<p>In modern hosting environments, logs are no longer saved on the local filesystem but instead stored remotely. With transient infrastructure and servers added or removed on the fly, it is no longer possible to store logs on a server and be sure that they can be retrieved later. For this reason, they are transmitted over HTTP to specialized l<a id="_idTextAnchor1001"/>og stores, such as App<a id="_idTextAnchor1002"/>lication Insights.</p>
<h2 id="_idParaDest-308"><a id="_idTextAnchor1003"/>Emitting logs</h2>
<p>To write log entries <a id="_idIndexMarker1088"/>to a log store, such as Application Insights, from <a id="_idIndexMarker1089"/>an ASP.NET application, two things must be done:</p>
<ol>
<li value="1">Log entries need to be emitted from the application code, where applicable, using the <strong class="source-inline">ILogger</strong> interface. This interface is available from the <strong class="source-inline">Microsoft.Extensions.Logging.Abstractions</strong> NuGet package.</li>
<li>The Application Insights NuGet package (<strong class="source-inline">Microsoft.ApplicationInsights.AspNetCore</strong>) needs to be installed and Application Insights needs to be registered as <strong class="source-inline">LoggingProvider</strong>. This way, all logs sent to the preceding interface are forwarded to the Application Insights code. In turn, this code forwards all the logs to the Application Insights service.</li>
</ol>
<p>The following <a id="_idIndexMarker1090"/>example code shows you how to use the <strong class="source-inline">ILogger</strong> interface <a id="_idIndexMarker1091"/>from a class to emit a structured log entry:</p>
<pre class="source-code">
public class Example
{
private readonly ILogger&lt;Example&gt; _logger;public Example(ILogger&lt;Example&gt; logger)
  {
    _logger = logger;
  }
  public void DoSomething(User user)
  {
    _logger.LogWarning(
      "Doing something for user with id '{userId}' and username '{username}'",
      user.Id, user.Username);<a id="_idTextAnchor1004"/>
    }
}</pre>
<p class="callout-heading">Important Note</p>
<p class="callout">There should be no dollar sign (<strong class="source-inline">$</strong>) at the start of the log entry. There is no string interpolation used here, but two placeholders are inserted into the text message. The structured logging entry will recognize these and, when showing the entry, insert the provided values.</p>
<p>With log entries emitted, a logging provider should be registered to capture these logs. This is done using the .NET Core built-in dependency injection.</p>
<p>After starting <a id="_idIndexMarker1092"/>the application, all log entries at the level of warning and <a id="_idIndexMarker1093"/>higher are automatically forwarded to Application Insights. To change which entries are forwarded and which aren’t, filters can be configured. A link to more details on configuring Application Insights in detail is provided at <a id="_idTextAnchor1005"/><a id="_idTextAnchor1006"/><a id="_idTextAnchor1007"/>the end of this chapter.</p>
<h3>Searching logs</h3>
<p>Within a few <a id="_idIndexMarker1094"/>minutes of emitting a log entry to Application Insights, it becomes <a id="_idIndexMarker1095"/>available on the interface for querying. To do this, open the Application Insights instance and navigate to <strong class="bold">Logs</strong> in the left-hand-side menu (<strong class="bold">1</strong>). This opens the view shown in the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer172">
<img alt="Figure 12.5 – The Application Insights Logs view " height="764" src="image/B18655_12_05.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.5 – The Application Insights Logs view</p>
<p>Here, it is possible to write queries (<strong class="bold">2</strong>) that search the recorded logs in <strong class="bold">Kusto Query Language</strong> (<strong class="bold">KQL</strong>). Application <a id="_idIndexMarker1096"/>Insights is optimized for handling large amounts of data and most queries <a id="_idIndexMarker1097"/>return results within a <a id="_idIndexMarker1098"/>second or less, even wh<a id="_idTextAnchor1008"/>en search<a id="_idTextAnchor1009"/>ing millions of log entries.</p>
<h3>Alerting on logs</h3>
<p>Gathering and <a id="_idIndexMarker1099"/>searching logs is useful when troubleshooting <a id="_idIndexMarker1100"/>specific situations or bugs in response to a user complaint. However, there <a id="_idIndexMarker1101"/>are situations where it is better to be notified automatically when a certain condition a<a id="_idTextAnchor1010"/>rises. This is called alerting.</p>
<p>Within Azure, it is possible to create alert rules that notify developers whenever a certain condition is met. Alerting functionality is provided by the Azure Monitor offering that is integrated with many Azure services, including Application Insights.</p>
<p>To create a new alert rule, follow these steps:</p>
<ol>
<li value="1">Navigate to Azure Monitor using the portal.</li>
<li>Now, choose <strong class="bold">Alerts</strong>. This opens the view shown in the following screenshot:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer173">
<img alt="Figure 12.6 – The Azure Monitor Alerts view " height="957" src="image/B18655_12_06.jpg" width="1499"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.6 – The Azur<a id="_idTextAnchor1011"/>e Monitor Alerts view</p>
<p>If there <a id="_idIndexMarker1102"/>are any a<a id="_idTextAnchor1012"/>lerts that need a<a id="_idTextAnchor1013"/>ttention, they <a id="_idIndexMarker1103"/>are shown here:</p>
<div>
<div class="IMG---Figure" id="_idContainer174">
<img alt="Figure 12.7 – The Azure Monitor alert creation view " height="965" src="image/B18655_12_07.jpg" width="1437"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.7 – The Azure Monitor alert creation view</p>
<p>Use the <strong class="bold">Create</strong> <a id="_idIndexMarker1104"/>button at the top-left-hand side of <a id="_idIndexMarker1105"/>the screen to add new alert rules. Doing so opens another view, as shown in the preceding screenshot. Here, the alerting conditions can be configured: </p>
<div>
<div class="IMG---Figure" id="_idContainer175">
<img alt="Figure 12.8 – The Azure Monitor alerts Review + create view " height="859" src="image/B18655_12_08.jpg" width="1525"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.8 – The Azure Monitor alerts Review + create view</p>
<p>In the preceding screenshot, the view that opens to configure alerts – <strong class="bold">Scope</strong> – is shown. Here, it is necessary to make resource selections to create an alert.</p>
<ol>
<li value="3">This (<strong class="bold">1</strong>) is the <a id="_idIndexMarker1106"/>resource that is the subject <a id="_idIndexMarker1107"/>of the alert. This can be any type of resource, and in this instance, the alert will be on an Application Insights workspace.</li>
<li>These (<strong class="bold">2</strong>) are the conditions to alert under. To select these, the popup on the right opens. Here, a choice can be made between different types of alerts. Pick the <strong class="bold">Log Search</strong> alert type to open the detailed view shown here. Here, the following selections must be made:<ul><li><strong class="bold">A query mentioned below on the logs</strong> (refer to <strong class="bold">2a</strong> in the previous screenshot): In this example, the requests log is queried for entries that failed with a <strong class="source-inline">404</strong> code result:<p class="source-code">requests</p><p class="source-code">| where succ<a id="_idTextAnchor1014"/>ess == False and resultCode == 404</p></li><li><strong class="bold">A condition and operator for triggering the alert</strong> (<strong class="bold">2b</strong>): In this case, the alert is triggered whenever requests are failed with a <strong class="source-inline">400</strong> code result.</li><li><strong class="bold">The interval to evaluate the alert condition over</strong> (<strong class="bold">2c</strong>): When specifying a query that matches a specific number, this determines the interval in which this amount must be met.</li><li><strong class="bold">How often to evaluate the alert condition</strong> (<strong class="bold">2d</strong>): Evaluating an alert condition too frequently can result in too many alerts opening and closing in a fast series. Evaluating an alert condition too infrequently can result in alerts coming in too late. Experimentation will help you understand how to configure this.</li></ul></li>
<li>This is the action to execute when the alert condition is met. Since there might be a lot of <a id="_idIndexMarker1108"/>alerts that have to invoke the <a id="_idIndexMarker1109"/>same group of actions, actions can be grouped, and these action groups can be referenced here. Some examples of actions are calling a Webhook or sending an SMS message or email.</li>
<li>The alert configuration is completed by putting in a name and description (<strong class="bold">3</strong>).</li>
<li>Finally, the alert can be saved.</li>
</ol>
<p>After the alert is reviewed and created as per the preceding screenshot, activation is done automatically, and within a few minutes, the alert is ready to inspect application logs and signal whenever the alert condition is met.</p>
<p>Logging is a great method of gaining deep knowledge about what happened with a request and how an error came to be. Another technique for <a id="_idTextAnchor1015"/>learning more about an applica<a id="_idTextAnchor1016"/>tion’s behavior is by using metrics.</p>
<h2 id="_idParaDest-309"><a id="_idTextAnchor1017"/>Metrics</h2>
<p>Besides logs, an application<a id="_idIndexMarker1110"/> can also emit one or more metrics. A metric is a series of <a id="_idIndexMarker1111"/>values over time that describes one or more aspects of a system. Some examples of <a id="_idIndexMarker1112"/>metrics are as follows:</p>
<ul>
<li>The number of users currently logged in </li>
<li>The number of products viewed by users </li>
<li>The number <a id="_idIndexMarker1113"/>of database transactions</li>
</ul>
<p>Gathering metrics <a id="_idIndexMarker1114"/>such as these can provide insight into how a system is used and <a id="_idIndexMarker1115"/>how it currently operates. Metrics are ofte<a id="_idTextAnchor1018"/><a id="_idTextAnchor1019"/><a id="_idTextAnchor1020"/>n used for creating dashboards and alerts.</p>
<h3>Emitting metrics</h3>
<p>To start working <a id="_idIndexMarker1116"/>with metrics, they first have to be emitted by an application and <a id="_idIndexMarker1117"/>stored in a centralized location. Besides logging, Application Insights can be used for metrics as well.</p>
<p>To use Application Insights for metrics, the following steps need to be taken:</p>
<ol>
<li value="1">Metrics need to be emitted from the application code where applicable, using the <strong class="source-inline">TelemetryClient</strong> class. This interface is available from the <strong class="source-inline">Microsoft.Extensions.Logging.Abstractions</strong> NuGet package.</li>
<li>Install the <strong class="source-inline">Microsoft.ApplicationInsights.AspNetCore</strong> Application Insights NuGet package.</li>
<li>Register <strong class="source-inline">TelemetryClient</strong> with the <strong class="source-inline">Dependency</strong> container. Do this by using the extension method on the container builder, as shown in the following code snippet:<p class="source-code"><strong class="bold">builder.RegisterType&lt;TelemetryClient&gt;().SingleInstance();</strong></p></li>
<li>Once this is done, the application is ready to start emitting metrics. This is done using the <strong class="source-inline">TelemetryClient</strong> class:<p class="source-code">public class Example</p><p class="source-code">{</p><p class="source-code">private readonly TelemetryClient _telemetryClient;</p><p class="source-code">public Example(TelemetryClient telemetryClient)</p><p class="source-code">{</p><p class="source-code">_telemetryClient = telemetryClient;</p><p class="source-code">}</p><p class="source-code">public void DoSomething()</p><p class="source-code">{</p><p class="source-code">_telemetryClient.GetMetric("doSo<a id="_idTextAnchor1021"/>methingCalledCounter").TrackValue(1.0);</p><p class="source-code"> }</p><p class="source-code">}</p></li>
</ol>
<p>Emitting a metric involves two steps. First, a reference to the metric is retrieved using the <strong class="source-inline">GetMetric()</strong> method. Next, a value is submitted using the <strong class="source-inline">TrackValue</strong> method. Submitted values should be doubles or allow an implicit conversion to a double.</p>
<p>Once the metrics are emitted, they can be used to create graphs and metrics. However, before moving <a id="_idIndexMarker1118"/>on to these topics, first, another type of metric needs to be <a id="_idIndexMarker1119"/>discussed – namely, Azure platform metrics.</p>
<p>Besides the metrics that an application emits, there are also numerous metrics that can be recorded from the Azure platform that the system is running on. Some examples are as follows:</p>
<ul>
<li>The percentage of CPU used</li>
<li>The number of messages on a service bus</li>
<li>The number of database transactions per second </li>
<li>The amount of free disk space</li>
</ul>
<p>These metrics are often closely related to how an application performs and may even be leading indicators. For example, when the amount of free disk space reaches 0, most web servers stop working.</p>
<p>In Azure, each service emits a series of metrics by default. These are called platform metrics. Which metrics are emitted differs from service to service and cannot be influenced by <a id="_idIndexMarker1120"/>the user. These metrics are also automatically gathered by Azure Monitor, and they can be used in the same ways for graphing and alerting as they are emitted by an application.</p>
<p>Platform metrics are integrated, cost-free, and for the majority of resources metrics are retained for 93 days.</p>
<h3>Graphing metrics</h3>
<p>All metrics that are gathered, either in Application Insights or in Azure Monitor, can be used to build graphs <a id="_idIndexMarker1121"/>and dashboards that visualize the <a id="_idIndexMarker1122"/>metric. Graphs can be created using the <strong class="bold">Metrics</strong> tab that is available on every Azure resource. Graphs can also be created using the Azure Monitor. This way, graphs for multiple resources can be combined on a single canvas. To do this, do the following:</p>
<ol>
<li value="1">Open Azure Monitor, which is available from the menu on the left.</li>
<li>Navigate to the <strong class="bold">Metrics</strong> menu. This opens the view shown in the following sc<a id="_idTextAnchor1022"/>reenshot:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer176">
<img alt="Figure 12.9 – Azure Monitor – Metrics " height="606" src="image/B18655_12_09.jpg" width="1274"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.9 – Azure Monitor – Metrics</p>
<ol>
<li value="3">Once the canvas opens, one or more graphs can be added to it. A graph is built using the graph builder at the top. Four selections have to be made here:<ul><li>The resource that a graph needs to be drawn for.</li><li><strong class="bold">The metrics namespace belonging to the resource that a graph needs to be drawn for</strong>: For every Azure resource type, there is only a single namespace. The only exception is Application Insights, for which there are two – one with default metrics and one with application metrics that are emitted using <strong class="source-inline">TelemetryClient</strong>.</li><li><strong class="bold">The metric to draw</strong>: For custom metrics, this refers back to the name chosen in the <strong class="source-inline">GetMetric()</strong> method from the previous section.</li><li><strong class="bold">The mathematical operation to combine multiple measurements into a single point on the graph</strong>: This can be the minimum, maximum, average, sum, or count.</li><li>To add <a id="_idIndexMarker1123"/>multiple graph lines to the same <a id="_idIndexMarker1124"/>graph, choose <strong class="bold">Add Metric</strong> at the top. Repeat the preceding four selections to configure the new graph.</li></ul></li>
<li>To make this graph part of a dashboard for easy reuse, click the <strong class="bold">Pin to dashboard</strong> button at the top.</li>
<li>Dashboards can then be accessed directly using the menu on the right:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer177">
<img alt="Figure 12.10 – The App Service Http400 metrics graph " height="789" src="image/B18655_12_10.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.10 – The App Service Http400 metrics graph</p>
<p>Having a graph <a id="_idIndexMarker1125"/>of a metric, or even multiple graphs in a <a id="_idIndexMarker1126"/>dashboard, is great for investigating issues. However, no o<a id="_idTextAnchor1023"/>ne likes to continuously watch dashboards to see how things are going. For that reason,<a id="_idTextAnchor1024"/> it is also possible to configure alerts on metrics.</p>
<h3>Alerting on metrics</h3>
<p>Just as with log <a id="_idIndexMarker1127"/>entries, it is possible to be alerted by Azure <a id="_idIndexMarker1128"/>Monitor when a metric goes above or below a certain threshold. Log entries that require a follow-up could be related to only a single user or customer that is having trouble. Metrics, on the other hand, are useful for detecting situations where all users are impacted by an issue, or situations where an inf<a id="_idTextAnchor1025"/>rastructure no longer works or will stop working soon.</p>
<p>Creating alerts for <a id="_idIndexMarker1129"/>metrics works in a way that is very similar to creating alerts from logs. To create a new alert rule, navigate to<a id="_idTextAnchor1026"/><a id="_idTextAnchor1027"/> <a id="_idTextAnchor1028"/>Azure Monitor using the portal and then choose <strong class="bold">Alerts</strong>. </p>
<h2 id="_idParaDest-310"><a id="_idTextAnchor1029"/>Investigating requests</h2>
<p>When using <a id="_idIndexMarker1130"/>Application Insights for logging and metrics, there are many more built-in capabilities of Application Insights that you can use. One of these capabilities is the possibility to execute search queries against all types of data collected by Application Insights from one view, called <strong class="bold">Search</strong>.</p>
<p>Here, it is possible to search all the information collected by Application Insights, including the following:</p>
<ul>
<li>Logs emitted by the application code, which includes NuGet packages and the .NET Framework.</li>
<li><strong class="bold">All dependency calls</strong>: These are calls to databases and other systems that are automatically detected by Application Insights. Application Insights records the target system and duration.</li>
<li><strong class="bold">All exceptions</strong>: All exceptions that occur in an application are recorded by Application Insights, even if properly handled by the application code.</li>
<li><strong class="bold">Requests</strong>: Every user request that comes in over HTTP is logged. Important properties, such as the URL, duration, and HTTP verb, are also included.</li>
</ul>
<p>To search for a specific transaction using the search view, open the correct Application Insights instance within the Azure portal and navigate to the <strong class="bold">Transaction search</strong> menu <a id="_idTextAnchor1030"/>(<strong class="bold">1</strong>) to get the view shown in the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer178">
<img alt="Figure 12.11 – Application Insights – Transaction search " height="479" src="image/B18655_12_11.jpg" width="1029"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.11 – Application Insights – Transaction search</p>
<p>In the <strong class="bold">Transaction search</strong> view, several search parameters can be configured (<strong class="bold">2</strong>):</p>
<ul>
<li><strong class="bold">An interval to search within</strong>: This defaults to the last 24 hours.</li>
<li><strong class="bold">The types of events to search in</strong>: These can be requests, log entries, page views, exceptions, dependency calls, and so on.</li>
<li>Any text to search for.</li>
</ul>
<p>Within seconds, all matching results are shown in a bar chart. Each bar stands for a time period and shows how many matches there are within that time frame. Below this chart, all the individual matches are shown. T<a id="_idTextAnchor1031"/>hese are a mix of all of the types of events available.</p>
<p>Clicking on any of the results opens a new view that shows the selected record in relation to all <a id="_idIndexMarker1131"/>the other types, grouped per request. This allows you to quickly navigate to all the logs, dependency calls, and exceptions that are gathered by Application Insights during the execution of a single user request. The results can be displayed as a list and as a timeline.</p>
<p>This allows you to see very quickly what the server was doing when performing the user request:</p>
<div>
<div class="IMG---Figure" id="_idContainer179">
<img alt="Figure 12.12 – Application Insights – End-to-end transaction details " height="567" src="image/B18655_12_12.jpg" width="1042"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.12 – Application Insights – End-to-end transaction details</p>
<p>With all of these means to investigate applications and be notified regarding events, it is important to decide which alerts to create and which not to, not only in order to create a healthy working <a id="_idIndexMarker1132"/>environment b<a id="_idTextAnchor1032"/>ut also to balance monitori<a id="_idTextAnchor1033"/>ng with new work. This is the topic of the next section.</p>
<h2 id="_idParaDest-311"><a id="_idTextAnchor1034"/>Optimizing alerting</h2>
<p>Once teams start instrumenting their applications and adding alerts to metrics that they find important, it will not be long before the first alerts start coming in. At this point, it is important to not only respond to the alerts but also to investigate them and then close them. Alerts should also<a id="_idTextAnchor1035"/><a id="_idTextAnchor1036"/><a id="_idTextAnchor1037"/> be evaluated and viewed as an opportunity for learning.</p>
<h3>Optimizing alerts</h3>
<p>An important thing to <a id="_idIndexMarker1133"/>do after creating a series of alerts is to re-evaluate them on <a id="_idIndexMarker1134"/>a regular basis. Two things that might come out of an evaluation such as this are as follows:</p>
<ul>
<li><strong class="bold">Changes in the alerting threshold</strong>: Evaluating alerts regularly involves taking a look at the metric over time and seeing where the alerting threshold is at now. This might lead to the conclusion that the threshold is too low or too high.</li>
<li><strong class="bold">Removing duplicates</strong>: Looking at alerts that have been raised over the month(s), it is very likely you’ll identify one or more groups of alerts that are always raised at the same time. For example, a set of alerts set on a specific web server can be so related that they are always raised at the same time. A common example is CPU usage and the average response time for an HTTP request; these two often rise at the same time. If this is the case, it is worth considering either removing one of them or downgrading one of them to be a warning only. Duplicate alerts increase the number of items that need an immediate reaction, leading to increased pressure on a team without a clear benefit.</li>
</ul>
<p>Constantly optimizing the set of <a id="_idTextAnchor1038"/>alerts not only helps <a id="_idTextAnchor1039"/>to reduce waste but also prevents so-called alert fatigue.</p>
<h3>Alert fatigue</h3>
<p>If alert rules are not constantly reviewed and updated, they could negatively influence a team, especially when <a id="_idIndexMarker1135"/>alert rules trigger too easily or too frequently, as people <a id="_idIndexMarker1136"/>will no longer respond to them properly. If there are too many alerts, it will wear people out and they will become numb to the effect of an alert. It does not even matter whether they are false alerts or real alerts; just the number of alerts can be enough to get people into a state where they do not care anymore.</p>
<p>If a situation such as this is observed within a team, it is time to drastically change the way alerts are generated and responded to. If this does not happen, team members might fall ill or leave a company altogether.</p>
<p>One of the ways to prevent t<a id="_idTextAnchor1040"/><a id="_idTextAnchor1041"/><a id="_idTextAnchor1042"/>his situation is by implementing a healthy on-call schedule.</p>
<h3>Which metrics to capture</h3>
<p>One question <a id="_idIndexMarker1137"/>that comes up frequently when talking about metrics is what metrics to emit and monitor. There are many possible metrics and even more opinions on this subject. As a good starting point, the following metrics are often gathered for web applications:</p>
<ul>
<li><strong class="bold">Requests per minute, transactions per minute, or something similar</strong>: This is a metric that is intended to capture the current load or throughput on a web application.</li>
<li><strong class="bold">The average response time</strong>: This metric captures the response time for all requests within a time window.</li>
<li><strong class="bold">The error rate</strong>: This metric captures the percentage of all requests that result in an error. As a guideline for an error, all HTTP response codes of <strong class="source-inline">400</strong> and upward are often taken.</li>
</ul>
<p>When these three metrics are captured and graphed together in a single graph, it provides the very first step in understanding an application’s behavior. Let’s explore a few examples:</p>
<ul>
<li>When the average response time goes up but the throughput (requests per minute) stays the same, this might be an indication that the infrastructure that hosts the application is having issues.</li>
<li>When both the throughput and the average response times go up, this might be an indication that traffic is increasing and that the current infrastructure is not capable of sustaining that throughput at the same response times.</li>
<li>When the error rate goes up but the other metrics stay the same, this might be an indication that a deployment has gone wrong or that a specific code path is starting to generate (more) errors.</li>
</ul>
<p>Of course, these are just examples, and there are many more possible scenarios. Other metrics can help to rule out a specific scenario or try to avoid them. For example, also starting to monitor the database load as a percentage can help detect a specific instance of all three scenarios. If the database load gets close to 100%, it might be time to scale the database up to a higher performance tier to help to sustain the higher throughput at the same response times as before.</p>
<p>To conclude this section, there is one final recommendation – when starting with monitoring, there is <a id="_idIndexMarker1138"/>often a tendency to focus on the systems that host the application. As an alternative, also consider monitoring metrics that have a direct business impact or metrics that are an indication of user satisfaction in terms of the usability of an application. This comes much closer<a id="_idTextAnchor1043"/> to measuring business value than when only you watch systems.</p>
<p>Some examples of this are as follows:</p>
<ul>
<li>In an online shop, the number of books sold per minute can be a very valuable business metric. Just imagine the impact it can have on a business if this metric is available in near real time using Azure Monitor and custom metrics from the application code.</li>
<li>For an online reading platform, the number of virtual page turns can be a valuable metric that signals whether users are happily working with the service. As soon as this number sees a sharp drop or rapidly increases, this might be an indication that something is going wrong.</li>
</ul>
<p>To find out which me<a id="_idTextAnchor1044"/>trics make sense in a given scenario<a id="_idTextAnchor1045"/>, it might help to talk to business or subject matter experts.</p>
<h2 id="_idParaDest-312"><a id="_idTextAnchor1046"/>Having an on-call schedule</h2>
<p>Once alerts are configured and start to be raised, it does not make sense to configure them to not trigger <a id="_idIndexMarker1139"/>before 8 AM and after 5 PM. In other words, it is <a id="_idIndexMarker1140"/>necessary to make sure that alerts of a certain severity are followed up even outside of business hours.</p>
<p>In many companies where having alerts is new, there is some form of implicit expectation that some people will be available outside of office hours (alongside their regular duties) to handle these alerts. Sometimes, when an alert is raised only once or twice a year, and there are no agreements about response times, this might not even be a problem at all.</p>
<p>However, in many organizations – especially over time – there is an expectation that these alerts are responded to within a certain period of time. Besides that, the number of alerts may increase as systems become larger and more complex, or the number of systems grows.</p>
<p>The way to cope with this is by creating an on-call schedule and formal agreements on what is expected of engineers and how the organization will reward them for their efforts. This allows the organization to set clear expectations and allows engineers to manage their free time based on these agreements. Having enough system downtime helps the engineers relax between periods of higher stress. This allows them to stay alert when<a id="_idTextAnchor1047"/> they are on call, ready to react when this is expected of them.</p>
<p>There is much material available on what constitutes a healthy on-call schedule and what doesn’t, and the keyword here is <em class="italic">healthy</em>. Some general pointers are as follows:</p>
<ul>
<li>Those who are on call during non-business hours should not be on call during business hours as well.</li>
<li>Provide engineers who are on call with reasonable compensation for being close to a phone, not under the influence, and so on. What is reasonable differs from situation to situation, but the more demanding being on call is, the higher the compensation should be.</li>
<li>Provide the proper tools for being on call. For example, when a response time of 30 minutes or less is expected, provide those on call with a backpack with a laptop, phone, and means to connect to the internet.</li>
<li>Ensure that every employee is not on call at least 75% of the time.</li>
<li>Allow <a id="_idIndexMarker1141"/>employees to take time off in lieu so that they can be <a id="_idIndexMarker1142"/>late for work if they had to respond to an alert overnight.</li>
</ul>
<p>After every disturbance of the normal operation of a system, whether this is during business hours or<a id="_idTextAnchor1048"/> after, a live site incident review can be performed to learn<a id="_idTextAnchor1049"/> what happened and how to reduce the chance of it happening again.</p>
<h2 id="_idParaDest-313"><a id="_idTextAnchor1050"/>Live site reviews</h2>
<p>After an alert is triggered and the team has responded and remediated the situation, it is time to evaluate <a id="_idIndexMarker1143"/>what happened. This is called a live site incident review. Here, the <a id="_idIndexMarker1144"/>whole team gathers to address the following:</p>
<ul>
<li>What happened – to start, a timeline should be constructed from the time the incident was discovered to the point that normal operations were restored. Next, the timeline is expanded with the events that led to the situation that triggered the incident.</li>
<li>Next, the series of events is evaluated to learn what worked well in the response. If one member of the team used a new tool to quickly diagnose a problem, this can benefit other members of the team as well.</li>
<li>Only then is it time to look at the possible points of improvement and translate these points into high-priority work for the team. Possible fail-safes are identified and scheduled for implementation or new alerts are identified that send an alert before a similar problem occurs again.</li>
<li>The alert or group of alerts that triggered the initial response is evaluated to<a id="_idTextAnchor1051"/> determine whether they are adequate or possibly contain duplicates.</li>
</ul>
<p>The best time for a live site incident review is as soon after the incident itself as possible. In <a id="_idIndexMarker1145"/>practice, this means giving everyone enough time <a id="_idIndexMarker1146"/>to rest and recuperate and plan a meeting for the next business day.</p>
<p>This completes our overview of Application Insights and the Azure Monitor capabilities for instrumenting web applications. The following section describes several approaches fo<a id="_idTextAnchor1052"/>r integrating Application Insights and Azure Monitor with other tools.</p>
<h1 id="_idParaDest-314"><a id="_idTextAnchor1053"/>Integrating with other tools</h1>
<p>Azure Monitor and Application Insights are excellent tools for gathering application logs and metrics, as well as storing them and making them searchable. However, there could be reasons why development teams or businesses prefer to work with other tools to visualize application performance or respond to alerts. One important driver for integration is often the primary tool used by a person or team. If a team operates mainly in ServiceNow or Grafana, it is often useful to integrate these with Azu<a id="_idTextAnchor1054"/>re Monitor instead of forcing these teams to work with multiple tools.</p>
<p>Many possible integr<a id="_idTextAnchor1055"/>ations exist; some examples are detailed in the following subsections.</p>
<h2 id="_idParaDest-315"><a id="_idTextAnchor1056"/>IT service management applications</h2>
<p>Action groups were introduced in the previous section where we looked at instrumenting web <a id="_idIndexMarker1147"/>applications. Action groups are groups of actions to be performed in response to an alert.</p>
<p>Next to the rich built-in capabilities, it is also possible to automatically raise an alert in an existing <strong class="bold">IT Service Management</strong> (<strong class="bold">ITSM</strong>) solution. If there is already an ITSM solution in place <a id="_idIndexMarker1148"/>within a company, it makes sense not to create a separate alerting channel using Azure Monitor. Instead, using an ITSM connector from Azure Monitor allows you to manage all the company-wide alerts from one solution.</p>
<p>Currently, there are integrations available with ServiceNow, Provance, System Center Service Mana<a id="_idTextAnchor1057"/><a id="_idTextAnchor1058"/><a id="_idTextAnchor1059"/>ger, and more. These connections are created through the ITSM connector.</p>
<h2 id="_idParaDest-316"><a id="_idTextAnchor1060"/>Azure Boards</h2>
<p>In many development teams, Azure DevOps is the tool that developers spend most of their time with. This is <a id="_idIndexMarker1149"/>also where they perform their backlog <a id="_idIndexMarker1150"/>management using Azure Boards.</p>
<p>Meanwhile, operators (and hopefully, developers, too) perform investigative work in Application Insights to determine the cause of user errors and to drill down into the reasons for failure. This investigative work could result in new work that needs to be backlogged in Azure DevOps.</p>
<p>To facilitate this, integration between Application Insights and Azure DevOps can be configured from Application Insights by taking the following steps:</p>
<ol>
<li value="1">Navigate to the <strong class="bold">Work Items</strong> option on the left-hand side menu (<strong class="bold">1</strong>). This opens the view shown on the left in the following screenshot. Here, a connection to Azure Boards can be configured:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer180">
<img alt="Figure 12.13 – Application Insights – Work Item integration " height="795" src="image/B18655_12_13.jpg" width="1516"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.13 – Application Insights – Work Item integration</p>
<ol>
<li value="2">To configure the connection, the following details need to be filled out:<ul><li>Enter the Azure DevOps link. Here, the name of the organization needs to be appended.</li><li>Select<a id="_idTextAnchor1061"/> the Azure DevOps project to use. This can be selected from the dropdown.</li><li>Select a product area where new items will be created. By default, this is the same as the name of the project, unless you change it.</li><li>Provide the name of a user as the default owner of new work items.</li></ul></li>
</ol>
<p>After configuring <a id="_idIndexMarker1151"/>this connection, a new <strong class="bold">+ Create work item</strong> button is visible on the relevant pages in Applicat<a id="_idTextAnchor1062"/>ion Insights. This button allows you <a id="_idTextAnchor1063"/>to create a bug with all the relevant information directly on the backlog.</p>
<h2 id="_idParaDest-317"><a id="_idTextAnchor1064"/>Grafana</h2>
<p>Azure Monitor allows you to build simple, easy-to-use dashboards. The advantage of using Azure <a id="_idIndexMarker1152"/>Monitor dashboards is that they integrate perfectly with all the other Azure practices, such as <strong class="bold">Role-Based Access Control</strong> (<strong class="bold">RBAC</strong>) and Azure Resource Manager templates.</p>
<p>However, teams may <a id="_idIndexMarker1153"/>have already adopted other tools for visualization, such as Grafana. Grafana is a well-known platform that works well with operational dashboards. Grafana can be configured to connect using Azure Monitor and can query metrics for graphing. Grafana also has alerting capabilities. </p>
<p>To connect <a id="_idIndexMarker1154"/>Grafana to Azure Monitor, the following <a id="_idIndexMarker1155"/>steps need to be taken:</p>
<ol>
<li value="1">Create a new app registration in the Azure Active Directory account that is used by your Azure subscription. Take note of the <strong class="bold">Tenant ID</strong>, <strong class="bold">Client ID</strong>, <strong class="bold">Subscription ID</strong>, and <strong class="bold">Client Secret</strong> properties of this app registration.</li>
<li>Create a new RBAC role assignment for the app registration, with at least the <strong class="bold">Reader</strong> permissions set on the resources to monitor.</li>
<li>Configure a new data source in Grafana of the <strong class="bold">Azure Monitor</strong> type. Insert the properties collected in <em class="italic">step 1</em> for authenticating to Azure.</li>
<li>Add a <a id="_idIndexMarker1156"/>new graph to the dashboard, selecting <strong class="bold">Azure Monitor</strong> <a id="_idIndexMarker1157"/>as a data source.</li>
</ol>
<p>By taking the preceding steps,<a id="_idTextAnchor1065"/> a Grafana-to-Azure Monitor connection can be set up within a matter of minutes.</p>
<h1 id="_idParaDest-318"><a id="_idTextAnchor1066"/>Summary</h1>
<p>In this chapter, you learned how to start completing the DevOps loop. You also learned how to work with crash reports and gather them from all types of applications, as well as how to instrument web applications. You now know how to use Application Insights to centralize logs and metrics and to get insight into requests and dependency calls. You also learned how you can integrate Azure Monitor with other tools to further streamline your development processes.</p>
<p>With this knowledge, you can now start learning about how your applications operate in production. By doing so, you can not only deliver your software faster but also learn from its usage and start improving from there.</p>
<p>In the next chapter, you will learn about gathering user feedback to complement what you have learned from your system logs and metrics. You will also le<a id="_idTextAnchor1067"/>arn how to measure end user satisfaction with your application and new features.</p>
<h1 id="_idParaDest-319"><a id="_idTextAnchor1068"/>Questions</h1>
<p>As we conclude, here is a list of questions for you to test your knowledge regarding this chapter’s material. You will find the answers in the <em class="italic">Assessments</em> section of the <em class="italic">Appendix</em>:</p>
<ol>
<li value="1">It is possible to capture custom metrics from the Azure platform offerings using Application Insights – true or false?</li>
<li>How long are platform metrics retained for in Azure Monitor?</li>
<li>It is possible to capture custom metrics from your own application code using Application Insights – true or false?</li>
<li>What do you call a situation where engineers start ignoring alerts as they are worn down by too many of them?</li>
<li>It is possible to call a Webhook when an alert fires in Azure – true or false?</li>
</ol>
<h1 id="_idParaDest-320"><a id="_idTextAnchor1069"/>Further reading</h1>
<ul>
<li>More information about the App Center SDK can be found at <a href="https://docs.microsoft.com/en-us/appcenter/sdk/">https://docs.microsoft.com/en-us/appcenter/sdk/</a>.</li>
<li>Azure Monitor-supported metrics by resource type: <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/metrics-supported">https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/metrics-supported</a>.</li>
<li>More information on Raygun can be found at <a href="https://raygun.com">https://raygun.com</a>.</li>
<li>More detailed information on configuring Application Insights is available at <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview">https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview</a>.</li>
<li>The KQL reference page can be found at <a href="https://docs.microsoft.com/en-us/sharepoint/dev/general-development/keyword-query-language-kql-syntax-reference">https://docs.microsoft.com/en-us<span id="_idTextAnchor1070"/>/sharepoint/dev/general-development/keyword-query-language-kql-syntax-reference</a>.</li>
</ul>
</div>
</div></body></html>