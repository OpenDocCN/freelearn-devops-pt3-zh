<html><head></head><body>
		<div id="_idContainer089">
			<h1 id="_idParaDest-93" class="hapter-number"><a id="_idTextAnchor129"/>6</h1>
			<h1 id="_idParaDest-94"><a id="_idTextAnchor130"/>Security and DevSecOps with Python</h1>
			<p class="author-quote">It’s a jungle out there. Disorder and confusion everywhere…</p>
			<p class="author-quote">– Randy Newman</p>
			<p class="author-quote">(If you know the rest of the song, good for you.)</p>
			<p>What is the password that you use most frequently? Do you never re-use a password? Don’t lie to me and don’t lie to yourself in this situation, lest you get locked out of your accounts. I’m using passwords here because that is the easiest way to break the ice on this conversation about security, and passwords are the easiest way to think about security. They provide a secure way to distinguish accounts and users and allow each their own access <a id="_idTextAnchor131"/>parameters. What we are going to talk about in this chapter will be a little more complex (just a little) but the underlying principles are the same: it is about securing access and making sure only the right people <span class="No-Break">have access.</span></p>
			<p>In <strong class="bold">DevSecOps</strong> (a branch of <strong class="bold">DevOps</strong> dedicated to security), the <a id="_idIndexMarker207"/>goal is to have security measures present and used before, during, and after any breach in security. This requires the use of best practices in securing access keys and other credentials, the use of best practices in securing infrastructure (such as containers), and the same for after a security incident <span class="No-Break">has occurred.</span></p>
			<p>Security is the responsibility of every single person on an application’s team and this responsibility obligates the team members to use tools and techniques that do not compromise on security and that can facilitate the automation of security processes to remove <span class="No-Break">human error.</span></p>
			<p>It just so happens we know a very good facilitator for that, don’t we? That’s right, <strong class="bold">Python</strong> is incredible at facilitating and supporting security and encryption and it is flexible and easy enough to use for security engineers even if they don’t have a lot of coding experience. Python’s Swiss Army knife property gives it the ability to integrate anywhere within <span class="No-Break">this chapter.</span></p>
			<p>So, let’s view the content that we are going to explore in <span class="No-Break">this chapter:</span></p>
			<ul>
				<li>We will find out how to secure and obfuscate sensitive codes, API keys, and passwords <span class="No-Break">using Python</span></li>
				<li>We will learn what validation of containers is and how Python can help double-check this process <span class="No-Break">if needed</span></li>
				<li>We will learn about the tools that Python has that can be used to facilitate incident monitoring <span class="No-Break">and response</span></li>
			</ul>
			<h1 id="_idParaDest-95"><a id="_idTextAnchor132"/>Technical requirements</h1>
			<p>Here are some requirements that will help you follow along with this <span class="No-Break">chapter’s activities:</span></p>
			<ul>
				<li>A GitHub account to clone the repository containing <span class="No-Break">sample code</span></li>
				<li>An <span class="No-Break">AWS account</span></li>
				<li>A Google <span class="No-Break">Cloud account</span></li>
				<li><span class="No-Break">Google Colab</span></li>
				<li>Any environment with <span class="No-Break">Python installed</span></li>
				<li>Tolerance for my <span class="No-Break">sarcastic prose</span></li>
			</ul>
			<p>You can access this book's repository <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Hands-On-Python-for-DevOps"><span class="No-Break">https://github.com/PacktPublishing/Hands-On-Python-for-DevOps</span></a></p>
			<h1 id="_idParaDest-96"><a id="_idTextAnchor133"/>Securing API keys and passwords</h1>
			<p>API keys <a id="_idIndexMarker208"/>and passwords are valuable for the reason most things are valuable: they cost money and the data protected by them are valuable. If you’ve ever watched any heist movie (and if you haven’t, I’d recommend <em class="itali">Heat</em>, which is a great movie) you know that there is always some sort of access code, signature, or safe combination that the heist team must acquire. This is because the idea of a secret code, passphrase, or encryption is perpetual throughout human civilization as a barrier to accessing sensitive information. Passwords existed for tens of thousands of years before computers <a id="_idIndexMarker209"/>even <span class="No-Break">came around.</span></p>
			<p>A heist team in the cyber domain will also try a similar strategy. They will attempt to extract passcodes and credentials from people who potentially have them so that they can acquire sensitive information. Sometimes, the information inside doesn’t even have to be sensitive, sometimes people just hack things because they are bored or like to social engineer people (I’m told there are people addicted to manipulating people, so that is quite scary). Either way, your information security is under constant attack, whether it is on the <a id="_idIndexMarker210"/>server side or the user side. So, precautionary measures and mechanisms for these kinds of attacks <span class="No-Break">are necessary.</span></p>
			<p>Now, we get to<a id="_idIndexMarker211"/> the Python part. We can try a couple of things with Python to implement this concept here. We can create environment variables and secrets that store<a id="_idIndexMarker212"/> variables that are sensitive in a separate folder or within the <strong class="bold">operating system</strong> (<strong class="bold">OS</strong>) configuration itself. We can also use Python (by itself or with some other tool or API) to extract and <a id="_idIndexMarker213"/>obfuscate <strong class="bold">personally identifiable </strong><span class="No-Break"><strong class="bold">information</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">PII</strong></span><span class="No-Break">).</span></p>
			<h2 id="_idParaDest-97"><a id="_idTextAnchor134"/>Store environment variables</h2>
			<p>Environment variables<a id="_idIndexMarker214"/> are stored as both a means of separating credentials from application code to prevent hardcoding and to make sure that an application can run with different credentials on different systems just by configuring those credentials into the OS or <span class="No-Break">a file.</span></p>
			<p>That brings us to the two ways in which we can store and retrieve environment variables: we can store them as files or as variables defined in the OS. You can, of course, also do this in a Cloud Secret Manager or using a hardware device, but those are similar concepts to the ones we <span class="No-Break">are discussing.</span></p>
			<p>For the first way (files), you can create and read from <strong class="sour e-inline">.env</strong> files in the <span class="No-Break">following way:</span></p>
			<ol>
				<li>These files are the standard for storing these environment variables and are usually ignored in practically every <strong class="sour e-inline">.gitignore</strong> file. To read these files, we must first install Python’s <span class="No-Break"><strong class="sour e-inline">python-dotenv</strong></span><span class="No-Break"> library:</span><pre class="sour e- ode"><strong class="bold">pip install python-dotenv</strong></pre></li>
				<li>After this, we can create a <strong class="sour e-inline">.env</strong> file and store variables and secrets within it. We separate these secrets based on the line that they are on. Here is a sample of a couple of lines of a <strong class="sour e-inline">.</strong><span class="No-Break"><strong class="sour e-inline">env</strong></span><span class="No-Break"> file:</span><pre class="sour e- ode">API_KEY = &lt;insert_key_here&gt;
API_SECRET_KEY = &lt;insert_secret_key_here&gt;</pre><p class="list-inset">Remember, <em class="itali">all caps</em> are for constants. This approach helps consolidate these constants in one place so that you don’t have to worry about changing them in all the locations you need them in your code, and you don’t have to worry about missing one <span class="No-Break">change somewhere.</span></p></li>
				<li>Now, let’s write<a id="_idIndexMarker215"/> the code by which our program can access the <span class="No-Break">environment variables:</span><pre class="sour e- ode">from dotenv import load_dotenv
import os
#load .env file
load_dotenv()
#load API keys into variables
api_key = os.getenv("API_KEY")
api_secret_key = os.getenv("API_SECRET_KEY")</pre><p class="list-inset">Running this code will give you the API key and the secret key in their <span class="No-Break">respective variables.</span></p></li>
			</ol>
			<p>Next, let’s try the same thing, but with environment variables exported and used directly from our <span class="No-Break">own OS:</span></p>
			<ol>
				<li>In Linux – where most servers of this kind are prevalent – we can set up environment variables as we did in the previous example with the <span class="No-Break">following commands:</span><pre class="sour e- ode"><strong class="bold">export API_KEY = &lt;insert_key_here&gt;</strong>
<strong class="bold">export API_SECRET_KEY = &lt;insert_secret_key_here&gt;</strong></pre><p class="list-inset">These will set the environment variables having the names <strong class="sour e-inline">API_KEY</strong> and <strong class="sour e-inline">API_SECRET_KEY</strong> in <span class="No-Break">your OS.</span></p></li>
				<li>Now comes the matter of accessing <span class="No-Break">these values:</span><pre class="sour e- ode">import os
# Get the API key and secret access key from the environment
api_key = os.environ.get("API_KEY")
api_secret_key = os.environ.get("API_SECRET_KEY")</pre><p class="list-inset">You’ll see that we are still using the <strong class="sour e-inline">os</strong> library from the previous code. This method is a little bit simpler and perhaps a little more secure than the <strong class="sour e-inline">.env</strong> file for a fewer number of environment variables. But when using a large number of environment variables, a <strong class="sour e-inline">.env</strong> file is better at aggregation and easier to use <span class="No-Break">and handle.</span></p></li>
			</ol>
			<p>These methods<a id="_idIndexMarker216"/> have taught you how to deal with sensitive information that you are responsible for and you yourself add to the code base. However, there comes a time when you will have to deal with the sensitive data of others. This data needs to be protected and you need to ensure that it doesn’t get into the wrong hands. The key to this? Making it useless for anything other than your purposes. We will talk about the obfuscation of <span class="No-Break">PII next.</span></p>
			<h2 id="_idParaDest-98"><a id="_idTextAnchor135"/>Extract and obfuscate PII</h2>
			<p>A person’s <a id="_idIndexMarker217"/>sensitive personal information is one of the most valuable things they have: financially, socially, and intimately. Compromising the security of this information can result in great harm to the person in all three of these areas. The privacy of people is of utmost importance, and we must take all possible measures in order to preserve it, especially when they entrust some bit of that information to the services that we provide <span class="No-Break">for them.</span></p>
			<p>So, what would be the best approach to start with this? Well, there are a lot of pre-built services such as Amazon Macie or Google Cloud’s <strong class="bold">DLP</strong> (short for <strong class="bold">Data Loss Prevention</strong>), and<a id="_idIndexMarker218"/> these services are handy, but you may not understand the inner workings of them since they are trained on certain machine learning algorithms that require very little input (if at all) from their users to redact and obfuscate a wide range of <span class="No-Break">personal information.</span></p>
			<p>But let’s say there <a id="_idIndexMarker219"/>is a piece of information that isn’t covered by these services, or you cannot use them because of compliance reasons. Then, you would have to begin creating your solution from scratch. Here again, Python is your friend. You can use Python to read files and find locations that contain sensitive information (based on certain criteria) and change that information in a way that hides or obfuscates it. This technique is the same as that for mining data by finding important patterns within the data, only in this case, instead of extracting the data, we are making sure that if some malicious actors tried to extract it, they would not be able to recover any <span class="No-Break">vital information.</span></p>
			<p>To demonstrate this, we are going to use a very simple <strong class="bold">regex</strong> or <strong class="bold">regular expression</strong> pattern for <a id="_idIndexMarker220"/>phone numbers to find them within a text and replace them with some form of redaction. We could try something a bit more complex, but it would still be the same concept, and if you are new to regex, I would suggest that you start somewhat slowly and discover the magic of regex. Truly, you will feel like <span class="No-Break">a wizard.</span></p>
			<p>Enough posturing for now; let’s get down to business. First, we need a regex that can be used to capture the pattern of a phone number. Don’t try and make a regex yourself unless you’re really trying to dive deep into it. For most use cases, you can find a suitable regex pre-made for you on the internet. In most cases, you can use it as it is, and in some very specific cases, you might have to make a couple of adjustments. So, the regex that covers phone number patterns (both using country codes and not) can be written like <span class="No-Break">this: </span><span class="No-Break"><strong class="sour e-inline">\d{3}-\d{3}-\d{4}'</strong></span><span class="No-Break">.</span></p>
			<p>That probably looks like a bunch of gibberish to you, but it works, and you should trust that (someone probably lost their mind trying to get it just right). This works with dashes and without country codes (though, you can make a regex that works with both). Now, let’s implement the regex on a small passage that contains <span class="No-Break">phone numbers:</span></p>
			<pre class="sour e- ode">#initial textimport retext = "The first number is 901-895-7906. The second number is: 081-548-3262"#pattern for searchsearch_pattern = r'\d{3}-\d{3}-\d{4}'#replacement for patternreplacement_text = "&lt;phone_number&gt;"#text replacementnew_text = re.sub(search_pattern, replacement_text, text)#output given: "The first number is &lt;phone_number&gt;. The second number is: &lt;phone_number&gt;"print(new_text)</pre>
			<p>Well, there you <a id="_idIndexMarker221"/>have it; this code finds phone numbers using a regex pattern and subsequently obfuscates it by replacing the <span class="No-Break">phone numbers.</span></p>
			<p>This is by far one of the simplest and most accessible ways to get regex but you can get even more complex with it. You can use it to obfuscate social security numbers, passport numbers, and pretty much anything that matches a <span class="No-Break">pre-defined pattern.</span></p>
			<p>So far, we have had security on the simplest, textual level. Now, we need to look towards security for our infrastructure. For this, we can look at container images since they are so prevalent, and validating them is so important. Let’s see how we can validate <span class="No-Break">these images.</span></p>
			<h1 id="_idParaDest-99"><a id="_idTextAnchor136"/>Validating and verifying container images with Binary Authorization</h1>
			<p>The amount <a id="_idIndexMarker222"/>of time I have now spent harping on about containers has probably clued you into the fact that containers may be somewhat important. Containers are, of course, an encapsulation of all the resource <a id="_idIndexMarker223"/>requirements and libraries that are specifically needed to run one service in an application. Containers being isolated from each other results in the elimination of conflict between the libraries required to run the services in each container, effectively creating an isolated system for each service in an overall large system <span class="No-Break">or application.</span></p>
			<p>However, this also <a id="_idIndexMarker224"/>presents a two-fold vulnerability: complexity and a larger threat vector in some circumstances. Handling all of these containers and the complex underlying libraries that lie within them (thus the need for Kubernetes) can be a difficult task. Managing these complex systems improperly can lead to the creation of structural and informational vulnerabilities in the system. At the same time, if multiple clusters are exposed to a public-facing setting or can be accessed in some way that gives an unauthorized user privileged access to your system, the threat to one container could threaten all the containers present in your system, as well as all <span class="No-Break">your information.</span></p>
			<p>Python’s Docker libraries make sure that you can do this for every layer of your image in an automated manner. Python can also use a number of third-party image verification tools. We will explore one of those tools with Google’s Binary Authorization API and Workflow for Kubernetes. So, let’s see how to verify compliant images with <span class="No-Break">Binary Authorization!</span></p>
			<p><strong class="bold">Compliance</strong> is an<a id="_idIndexMarker225"/> interesting subject, much of it is in the eye of the beholder. The definition of compliance depends on how strict you want to be. In Kubernetes – specifically in <strong class="bold">Google Kubernetes Engine</strong> – there<a id="_idIndexMarker226"/> must be some sort of assurance or regulation that defines that the correct <a id="_idIndexMarker227"/>image has been used. The mechanic is known as <span class="No-Break"><strong class="bold">Binary Authorization</strong></span><span class="No-Break">.</span></p>
			<p>Binary Authorization allows the Docker containers that are deployed in a Kubernetes cluster to be checked according to certain criteria. Authorization can be done either by using a compliance policy or an attestor. A compliance policy creates rules that allow only images that meet a certain criterion. Adding an attestor means adding an individual user in your project who can testify that the image that is going to be used is correct. In Binary Authorization, you can use one or both of these in order to authorize your images for your <a id="_idIndexMarker228"/>Kubernetes <a id="_idIndexMarker229"/>cluster. Let’s see how to <span class="No-Break">do that:</span></p>
			<ol>
				<li>We are <a id="_idIndexMarker230"/>now going to write a script to create an attestor and assign that attestor to the Kubernetes engine. First, we must install the client libraries for containers and <span class="No-Break">Binary Authorization:</span><pre class="sour e- ode"><strong class="bold">pip install google-cloud-binary-authorization google-cloud-container</strong></pre></li>
				<li>Now, let’s write the script for the Binary Authorization of <span class="No-Break">the cluster:</span><pre class="sour e- ode">from google.cloud import binaryauthorization_v1
def sample_create_attestor():
    client = binaryauthorization_v1.BinauthzManagementServiceV1Client()
    attestor = binaryauthorization_v1.Attestor()
    attestor.name = &lt;Enter_attestor_name&gt;
    request = binaryauthorization_v1.CreateAttestorRequest(
        parent=&lt;Enter_parent_value_of_attestor&gt;,
        attestor_id=&lt;Enter_attestor_id&gt;,
        attestor=attestor,
    )
    client.create_attestor(request=request)</pre><p class="list-inset">This will create an attestor that can attest your <span class="No-Break">cluster requests.</span></p></li>
				<li>Now, we <a id="_idIndexMarker231"/>need to add the<a id="_idIndexMarker232"/> Binary Authorization <a id="_idIndexMarker233"/>to a cluster that has already been created or is about to <span class="No-Break">be created:</span><pre class="sour e- ode">from google.cloud import container_v1
def sample_update_cluster():
    client = container_v1.ClusterManagerClient()
    request = container_v1.UpdateClusterRequest(
"desired_node_pool_id": &lt;Node_pool_to_update&gt;,
"update": {
"desired_binary_authorization": {
"enabled": True,
"evaluation_mode": 2
}
}
    )
    client.update_cluster(request=request)</pre><p class="list-inset">This script will update the Kubernetes cluster to start using our Binary Authorization <a id="_idIndexMarker234"/>method. That <a id="_idIndexMarker235"/>takes care <a id="_idIndexMarker236"/>of incidents within <span class="No-Break">your infrastructure.</span></p></li>
			</ol>
			<p>Now, we will explore a couple of things that could help you with incidents outside of <span class="No-Break">your infrastructure.</span></p>
			<h1 id="_idParaDest-100"><a id="_idTextAnchor137"/>Incident monitoring and response</h1>
			<p>How would one define an incident? Well, let me posit this to you: what would you do if a bear attacked you? Does this sound stupid? Are these way too many questions? Well, this question is a fairly direct way to understand an incident and how it is <span class="No-Break">reacted to.</span></p>
			<p>The bear is <a id="_idIndexMarker237"/>attacking you; it is much larger than you and, well, you don’t want it to get you. In this case, the bear attack is the incident and the bear itself is just a vector for the incident. The result of the incident depends on the response, and to have a good response, you need a good head on your shoulders (you need to <em class="itali">monitor</em> the situation, get it?). The report of the response to the incident will happen one way or another. However, if you want to be the one writing the report, you need to have handled the <span class="No-Break">incident correctly.</span></p>
			<p>Actual security incidents are not as brutal as that (not physically, anyway). Don’t worry. But they do work similarly. There is an incident, in which security is compromised in some way, there is a tool used to exploit a vulnerability, and when that vulnerability is exploited, it must be handled calmly and mitigated where possible. Once that is done and you have restored order, the incident response needs to be documented and distributed to the <span class="No-Break">correct parties.</span></p>
			<p>Now, here is where Python comes in. In order to respond to a security threat that potentially targets a fleet of virtual machines, Python can help run what is called a <strong class="bold">runbook</strong>, which<a id="_idIndexMarker238"/> is a series of commands that can be deployed to reset a system or to have it respond to some sort of threat. Another way to use Python in this capacity would be to look at monitoring data from the time of an incident and compare it to regular data in order to find some patterns that can be used to predict and get ahead of <span class="No-Break">future incidents.</span></p>
			<h2 id="_idParaDest-101"><a id="_idTextAnchor138"/>Running runbooks</h2>
			<p>When we talk <a id="_idIndexMarker239"/>about incident response, one of the most common responses to an incident that affects your resources is to turn it on and off again. This is <a id="_idIndexMarker240"/>effective maybe 97% of the time. Seriously. But sometimes people resent doing that, too. For me, when the Bluetooth malfunctions on my laptop, I have to restart it for some reason. It’s irrational and it irritates me irrationally, but it provides the solution (unlike the 500 other ways to restart Bluetooth that I find on the internet before I actually go through <span class="No-Break">with it).</span></p>
			<p>We’re going to play it smart; we are going to focus on that 97%, but at the same time, we are going to give you the blueprint to run more complex code and procedures that you may like to write. This one is particularly closely adapted to AWS, but similar fleet management and operations can be found on every major cloud as well as for most on-premises operations <span class="No-Break">as well.</span></p>
			<p>For this exercise, we are <a id="_idIndexMarker241"/>using the <strong class="bold">AWS EventBridge</strong> to trigger a step function that will subsequently run a command on the desired EC2 instance that has triggered the event, restarting the instance from within. Again, we’re keeping the commands simple here, but if you want you can get more advanced with it. So, let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Let’s start with a running instance. I have named mine <strong class="sour e-inline">test1</strong>. Very creative, <span class="No-Break">I know.</span></li>
			</ol>
			<p class="IMG---Figure"><img src="image/B21320_06_1.png" alt="Figure 6.1 – A running instance"/></p>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.1 – A running instance</p>
			<p class="list-inset">Let’s live in a scenario where this is an instance that has a high amount of network traffic flowing through it. So high that, if it dropped below a certain level, it would indicate some sort of malfunction in the instance. In this case, that malfunction can be sorted through a simple restart using a <span class="No-Break">runbook document.</span></p>
			<ol>
				<li value="2">Let’s make<a id="_idIndexMarker242"/> the structure for that command<a id="_idIndexMarker243"/> now in <strong class="bold">AWS Lambda</strong>. But first, we need the command that is to be sent, which is found in <strong class="bold">Systems Manager</strong>. Open <strong class="bold">Systems Manager</strong> and go to the <strong class="bold">Documents</strong> tab at the bottom of <span class="No-Break">the sidebar:</span></li>
			</ol>
			<div>
				<div id="_idContainer073" class="IMG---Figure">
					<img src="image/B21320_06_2.jpg" alt="Figure 6.2 – AWS Systems Manager"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.2 – AWS Systems Manager</p>
			<ol>
				<li value="3">Within the<a id="_idIndexMarker244"/> documents, search for the <strong class="sour e-inline">AWS-RestartEC2Instance</strong> document. This is the default document, and you can base a lot of other VM manipulation documents <span class="No-Break">on it:</span></li>
			</ol>
			<div>
				<div id="_idContainer074" class="IMG---Figure">
					<img src="image/B21320_06_3.jpg" alt="Figure 6.3 – Document to perform EC2 restarts"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.3 – Document to perform EC2 restarts</p>
			<p class="list-inset">This is a simple baseline document and it can serve as a baseline for any sort of scripting <a id="_idIndexMarker245"/>action that you perform. Most other cloud providers also have something equivalent <span class="No-Break">to this.</span></p>
			<div>
				<div id="_idContainer075" class="IMG---Figure">
					<img src="image/B21320_06_4.jpg" alt="Figure 6.4 – Detailed AWS-RestartEC2Instance document"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.4 – Detailed AWS-RestartEC2Instance document</p>
			<p class="list-inset">If we<a id="_idIndexMarker246"/> look at it a bit closer, we can see that this document stops and then starts a particular instance based on instance ID, which is what we are going <span class="No-Break">to provide.</span></p>
			<ol>
				<li value="4">Now, let’s write an EventBridge event that will trigger a Lambda function in the event of a decrease in network traffic over the course of five minutes. For that, let’s first go to Amazon CloudWatch and create an alarm that triggers under our condition. Go to <strong class="bold">CloudWatch</strong> | <strong class="bold">Alarms</strong> | <span class="No-Break"><strong class="bold">Create alarm</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer076" class="IMG---Figure">
					<img src="image/B21320_06_5.jpg" alt="Figure 6.5 – Cloudwatch Alarms console"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.5 – Cloudwatch Alarms console</p>
			<p class="list-inset">We can now create a separate alarm for our <strong class="sour e-inline">test 1</strong> instance and it will be shown<a id="_idIndexMarker247"/> graphically to give you an idea of what is happening with the <span class="No-Break">metric currently:</span></p>
			<div>
				<div id="_idContainer077" class="IMG---Figure">
					<img src="image/B21320_06_6.jpg" alt="Figure 6.6 – Creating an alarm metric"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.6 – Creating an alarm metric</p>
			<ol>
				<li value="5">Next, let’s <a id="_idIndexMarker248"/>set the condition for the trigger for the alarm to be under <strong class="bold">20,000</strong> bytes of network input over a period of <span class="No-Break">five minutes:</span></li>
			</ol>
			<div>
				<div id="_idContainer078" class="IMG---Figure">
					<img src="image/B21320_06_7.jpg" alt="Figure 6.7 – Setting a threshold for the alarm"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.7 – Setting a threshold for the alarm</p>
			<ol>
				<li value="6">Name the alarm <strong class="sour e-inline">test1-alarm</strong> in the field asking you for the alarm name and we’re good <span class="No-Break">to go.</span><p class="list-inset">Now, we can look at the alarm on the <strong class="bold">Details</strong> tab and find the EventBridge rules, which we will need to set up the <span class="No-Break">EventBridge trigger:</span></p></li>
			</ol>
			<div>
				<div id="_idContainer079" class="IMG---Figure">
					<img src="image/B21320_06_8.jpg" alt="Figure 6.8 – Alarm configuration details"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.8 – Alarm configuration details</p>
			<ol>
				<li value="7">Then, go to <strong class="bold">Amazon EventBridge</strong> in the AWS section, and then to the <strong class="bold">Rules</strong> tab, where<a id="_idIndexMarker249"/> you will create a new event. On the first page, select <strong class="bold">Rule with an Event pattern</strong> and then move on to the next page. Here, you <a id="_idIndexMarker250"/>will paste the EventBridge rule that you acquired from <span class="No-Break">the alarm:</span></li>
			</ol>
			<div>
				<div id="_idContainer080" class="IMG---Figure">
					<img src="image/B21320_06_9.jpg" alt="Figure 6.9 – Pattern creation for event bridge"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.9 – Pattern creation for event bridge</p>
			<ol>
				<li value="8">Now that you have the pattern, press <strong class="bold">Next</strong>, then in another tab, open AWS Lambda. Here, we will write our Python code to execute the restart of the <span class="No-Break">EC2 instance.</span><p class="list-inset">In AWS Lambda, choose the Python execution time and maintain all of the default settings otherwise. Then, add the <span class="No-Break">following code:</span></p><pre class="sour e- ode">import json
import boto3
client = boto3.client('ssm')
def lambda_handler(event, context):
    instance_id = event["instanceids"]
    client.send_command(InstanceIds = [instance_id], DocumentName = "AWS-RestartEC2Instance")
    return "Command to restart has been sent."</pre><p class="list-inset">This code will<a id="_idIndexMarker251"/> send the command of the playbook document<a id="_idIndexMarker252"/> to restart the <span class="No-Break">EC2 instance.</span></p><p class="list-inset">Now, let’s select <strong class="bold">Lambda function</strong> as the target for <span class="No-Break">the EventBridge:</span></p></li>
			</ol>
			<div>
				<div id="_idContainer081" class="IMG---Figure">
					<img src="image/B21320_06_10.jpg" alt="Figure 6.10 – Target Lambda function"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.10 – Target Lambda function</p>
			<ol>
				<li value="9">Keep hitting <strong class="bold">Next</strong> until you create the EventBridge rule. When the alarm is triggered, that rule <a id="_idIndexMarker253"/>will trigger and run the Lambda function. This will restart the instance and keep doing so until the network input has been restored<a id="_idIndexMarker254"/> to <span class="No-Break">acceptable levels.</span></li>
			</ol>
			<p>Now, in this example, we saw an application that is based on an immediate reaction and implementation. This is good if your system is under some sort of attack meant to overwhelm it or to exploit something that you can’t patch. However, attacks don’t usually come in ones. They are targeted and frequent, constantly trying to find some sort of vulnerability from which to attack your workload. To help understand potential attack patterns and learn more about how your workload handles changes in general, you can use pattern analysis of <span class="No-Break">monitored logs.</span></p>
			<h2 id="_idParaDest-102"><a id="_idTextAnchor139"/>Pattern analysis of monitored logs</h2>
			<p>Monitored logs<a id="_idIndexMarker255"/> can give <a id="_idIndexMarker256"/>you insights into how an application has performed and if there are some unusual patterns detected within the timeline. For example, <strong class="bold">distributed denial-of-service</strong> (<strong class="bold">DDoS</strong>) attacks <a id="_idIndexMarker257"/>usually create a pattern of inexplicable high CPU usage in an application. It essentially<a id="_idIndexMarker258"/> causes the application to suffer from fake loads, which affect the actual loads in <span class="No-Break">the application.</span></p>
			<p>So, in order to detect these attacks, we must have an algorithm that can historically analyze your workload and potentially find such attacks. To find these patterns, Python has some great data <span class="No-Break">science libraries.</span></p>
			<p>Public datasets of server logs are difficult to find, but they can be recreated fairly easily. For this example, I will use the public dataset <a id="_idIndexMarker259"/>mocking service <strong class="bold">Mockaroo</strong>. It lets you create a dataset of 1,000 rows for free. I will only create a dataset with the CPU utilization and <span class="No-Break">the timestamp.</span></p>
			<div>
				<div id="_idContainer082" class="IMG---Figure">
					<img src="image/B21320_06_11.jpg" alt="Figure 6.11 – Generating a mock dataset"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.11 – Generating a mock dataset</p>
			<p>Once the <a id="_idIndexMarker260"/>data has been<a id="_idIndexMarker261"/> generated, we will see that it hasn’t been sorted on the basis of time, so that is an extra step that we will add to our script. We will write our <a id="_idIndexMarker262"/>script using Google Colab. So, let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>First, install the <strong class="sour e-inline">pandas</strong> and <strong class="sour e-inline">matplotlib</strong> libraries. They are usually there already, but this step helps in other <span class="No-Break">notebook applications:</span></li>
			</ol>
			<div>
				<div id="_idContainer083" class="IMG---Figure">
					<img src="image/B21320_06_12.jpg" alt="Figure 6.12 – Installation command"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.12 – Installation command</p>
			<ol>
				<li value="2">Next, upload the CSV that Mockaroo created to Colab. To do this, click the folder icon in the side panel and then click the first icon within it to upload <span class="No-Break">the data:</span></li>
			</ol>
			<div>
				<div id="_idContainer084" class="IMG---Figure">
					<img src="image/B21320_06_13.jpg" alt="Figure 6.13 – Uploading mock data"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.13 – Uploading mock data</p>
			<p class="list-inset">You will see <a id="_idIndexMarker263"/>here that I have already uploaded <span class="No-Break">my data.</span></p>
			<ol>
				<li value="3">Now, the <a id="_idIndexMarker264"/>next step is to read the data using pandas to create a dataframe and order it by time, because the mock data in the CSV was not pre-arranged in <span class="No-Break">a sequence.</span></li>
			</ol>
			<div>
				<div id="_idContainer085" class="IMG---Figure">
					<img src="image/B21320_06_14.jpg" alt="Figure 6.14 – Table for CPU utilization"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.14 – Table for CPU utilization</p>
			<ol>
				<li value="4">Now, to find<a id="_idIndexMarker265"/> the pattern<a id="_idIndexMarker266"/> in the data, we can begin by visualizing the data. Let’s visualize this data as a linear plot with the timestamp as the x-axis and CPU utilization as <span class="No-Break">the y-axis:</span></li>
			</ol>
			<div>
				<div id="_idContainer086" class="IMG---Figure">
					<img src="image/B21320_06_15.jpg" alt="Figure 6.15 – Code to plot CPU utilization"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.15 – Code to plot CPU utilization</p>
			<p class="list-inset">Now, the plot is sort of random, being randomly generated and all, so the diagram is <a id="_idIndexMarker267"/>not <a id="_idIndexMarker268"/>necessarily representative of what the actual diagram would <span class="No-Break">look like.</span></p>
			<div>
				<div id="_idContainer087" class="IMG---Figure">
					<img src="image/B21320_06_16.jpg" alt="Figure 6.16 – Diagram plotting CPU utilization over time"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.16 – Diagram plotting CPU utilization over time</p>
			<p class="list-inset">So, this looks random, but that’s fine as it’s simply meant to be a representative of a bar graph over time. Let’s refine the dataset a little to <span class="No-Break">create anomalies.</span></p>
			<ol>
				<li value="5">So, we are going to modify the dataset to have a constant utilization rate somewhere in <span class="No-Break">the middle:</span></li>
			</ol>
			<div>
				<div id="_idContainer088" class="IMG---Figure">
					<img src="image/B21320_06_17.jpg" alt="Figure 6.17 – Chart for modified dataset"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.17 – Chart for modified dataset</p>
			<p>This is a little ridiculous, but<a id="_idIndexMarker269"/> I believe it illustrates the point of constant uptime. Most systems, when they are stable, do <a id="_idIndexMarker270"/>not have this kind of utilization. If your service is getting this kind of data, it either indicat<a id="_idTextAnchor140"/>es a sudden spike of success or a DDoS attack. More often than not, it is the latter. So, if you find this kind of spike in your monitoring data, it is <span class="No-Break">worth investigating.</span></p>
			<h1 id="_idParaDest-103"><a id="_idTextAnchor141"/>Summary</h1>
			<p>In this chapter, you have hopefully learned a thing or two about security. I also hope that you have figured out how to build your infrastructure in such a way that all of the access keys you use <span class="No-Break">are secured.</span></p>
			<p>In addition to this, you have also learned some methods (among hundreds of thousands) that can be used to help secure your infrastructure. You may have also gotten some insights into how you can use data to drive the response to incidents and also find better insight into certain incidents and <span class="No-Break">their properties.</span></p>
			<p>So, friends, I hope you enjoyed this chapter, which is all about security. I tried my best to explain a couple of concepts to you and I hope you found it interesting, at least. But now, it is time to flip the page and move on to the next chapter, where we will talk about one of my favorite <span class="No-Break">topics: </span><span class="No-Break"><strong class="bold">automation</strong></span><span class="No-Break">.</span></p>
		</div>
	</body></html>