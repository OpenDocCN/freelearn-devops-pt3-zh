- en: '14'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '14'
- en: A Brief Overview of Puppet Enterprise
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Puppet Enterprise 简要概述
- en: This chapter will give an overview of **Puppet Enterprise**, what it is, and
    what it provides compared to **Open Source Puppet**. Although the author of this
    book is a Puppet employee, this is not intended as a hard sell but to present
    where and how to use Puppet Enterprise well. It will cover the extra Enterprise
    console services in the Puppet platform, showing how code deployment, orchestrator
    service, RBAC, web console, and various other services are automatically configured
    and work with each other. This will assist in understanding how Puppet Enterprise
    differs from Open Source Puppet and the preconfigured and built-in features that
    would need to be manually created in Open Source Puppet. Supported architectural
    patterns will be highlighted that help to understand how to deploy and scale Puppet
    infrastructure using Puppet Enterprise packaging and modules to automatically
    deploy these patterns. Some related projects and integrations will be discussed,
    along with how they fit into the Puppet Enterprise environment.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将概述**Puppet Enterprise**，它是什么以及与**开源 Puppet**相比提供了哪些功能。尽管本书的作者是 Puppet 员工，但本章并非强行推销，而是介绍如何有效地使用
    Puppet Enterprise。它将介绍 Puppet 平台中的额外企业控制台服务，展示代码部署、编排服务、RBAC、Web 控制台以及其他各种服务如何自动配置并协同工作。这将有助于理解
    Puppet Enterprise 与开源 Puppet 的区别，以及在开源 Puppet 中需要手动创建的预配置和内建功能。将重点介绍支持的架构模式，帮助理解如何使用
    Puppet Enterprise 包装和模块自动部署这些模式，从而部署和扩展 Puppet 基础设施。还将讨论一些相关项目和集成，以及它们如何融入 Puppet
    Enterprise 环境。
- en: 'In this chapter, we’re going to cover the following main topics:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下主要内容：
- en: What is Puppet Enterprise?
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 什么是 Puppet Enterprise？
- en: Exploring the Puppet Enterprise console and services
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 探索 Puppet Enterprise 控制台和服务
- en: Using Bolt with Puppet Enterprise
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 Puppet Enterprise 中使用 Bolt
- en: Automating deployment and reference architectures
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自动化部署和参考架构
- en: Puppet Enterprise-related projects and tooling
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Puppet Enterprise 相关项目和工具
- en: Lab—Puppet Enterprise extensions and configuration
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实验—Puppet Enterprise 扩展与配置
- en: Technical requirements
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'Clone the control repo from [https://github.com/puppetlabs/control-repo](https://github.com/puppetlabs/control-repo)
    to your `controlrepo-chapter14` GitHub account and update the `Puppetfile` file
    in this repo: [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile).'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 从 [https://github.com/puppetlabs/control-repo](https://github.com/puppetlabs/control-repo)
    克隆控制仓库到你的 `controlrepo-chapter14` GitHub 账户，并更新此仓库中的 `Puppetfile` 文件：[https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/Puppetfile)。
- en: 'Build a large cluster with a replica with three compilers and three clients
    by downloading the `params.json` file from [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json)and
    updating it with the location of your control repo and your SSH key for the control
    repo. Then, run the following command from your `pecdm` directory:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 通过下载来自 [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/blob/main/ch14/params.json)
    的 `params.json` 文件，并根据控制仓库的位置以及控制仓库的 SSH 密钥进行更新，构建一个带有副本的集群，包含三个编译器和三个客户端。然后，从
    `pecdm` 目录运行以下命令：
- en: '[PRE0]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: What is Puppet Enterprise?
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 什么是 Puppet Enterprise？
- en: A common misconception when discussing Puppet Enterprise is that features of
    the product are held back and not available for open source users. The aim of
    Puppet Enterprise isn’t to limit what is available to open source users but to
    instead provide value to customers who want to consume Puppet easily and focus
    on gaining the value of configuration management by putting less of their own
    development and automation work into the platform itself.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在讨论 Puppet Enterprise 时，常见的误解是该产品的某些功能被限制，无法为开源用户提供。Puppet Enterprise 的目标并非限制开源用户可用的功能，而是为那些希望轻松使用
    Puppet 的客户提供价值，使他们能够通过减少自身在平台上的开发和自动化工作，专注于获得配置管理的价值。
- en: Puppet achieves this by ensuring that in Enterprise, the packing of components
    is versioned and tested together with an automated installation script and module,
    reducing the effort required by users managing the infrastructure. Puppet Enterprise
    works on two different types of releases. Puppet Enterprise, which works on an
    *xxxx.y* pattern, is normally updated every 3 months, which at the time of writing
    would be `2023.0`. This version is planned to upgrade to Puppet 8.x versions in
    2023.3 and will receive new features throughout its lifetime. This release is
    recommended for users who want to access the latest features and fixes and will
    require a regular update pattern. The other type of release is the **long-term
    support** (**LTS**) version; this follows an *xxxx.y.z* pattern. This branch is
    normally updated every 3 months, but the updates would only include fixes and
    not new features. The LTS versions last 2 years and have an overlap of 6 months
    with the next major *xxxx* release, so the current 2021.7.z LTS will end mainstream
    support on August 31, 2024, at which point overlap support will continue until
    February 28, 2025, after which users should migrate to whichever version of Puppet
    they require. 2023.y becomes the new LTS release to continue to have support from
    Puppet. The two running Puppet Enterprise versions generally mirror two Open Source
    Puppet versions in active development. The release of 2023.0 retired Puppet 6
    and 2023 should move to Puppet 8 in version 2023.3 or shortly after.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet 通过确保在 Enterprise 中，组件的打包与自动化安装脚本和模块一同进行版本控制和测试，从而减少用户管理基础设施所需的工作量。Puppet
    Enterprise 使用两种不同类型的版本发布。Puppet Enterprise 采用 *xxxx.y* 模式，通常每 3 个月更新一次，截至目前为 `2023.0`。该版本计划在
    2023.3 升级到 Puppet 8.x 版本，并将在其生命周期内不断推出新功能。此版本推荐给那些希望访问最新功能和修复的用户，并且需要定期更新。另一种发布类型是**长期支持**（**LTS**）版本；此版本遵循
    *xxxx.y.z* 模式。该分支通常每 3 个月更新一次，但更新只包含修复而不包括新功能。LTS 版本的生命周期为 2 年，并与下一个主要的 *xxxx*
    版本重叠 6 个月，因此当前的 2021.7.z LTS 将于 2024 年 8 月 31 日结束主流支持，届时将继续提供重叠支持，直到 2025 年 2
    月 28 日，此后用户应迁移到所需版本的 Puppet。2023.y 将成为新的 LTS 发布版本，继续获得 Puppet 的支持。这两种运行中的 Puppet
    Enterprise 版本通常与两个处于积极开发中的开源 Puppet 版本相对应。2023.0 的发布终止了 Puppet 6，预计 2023 将在 2023.3
    版本或稍后转向 Puppet 8。
- en: The most obvious feature of an Enterprise license is support, with access to
    raise support cases with teams who can review infrastructure problems and assist
    with any issues or features required for supported modules.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 企业许可证最显著的特点是支持，用户可以向团队提出支持案例，这些团队可以审查基础设施问题并协助解决任何问题或提供支持的模块所需的功能。
- en: Puppet also provides various professional services, such as on-site engagements
    to provide hands-on training and advice. This can lead to architecture reviews
    to understand how best to implement in your environment and to feed into processes
    that develop products and solutions such as the **Puppet Data Service** (**PDS**)
    and **Puppet Enterprise Administration Module** (**peadm**). Further, **technical
    account managers** (**TAMs**) are assigned to give you a regular point of contact
    and champion you in Puppet, supporting you in creating a success plan for your
    organization and focusing your deployment to achieve its goals.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet 还提供各种专业服务，如现场服务，提供实操培训和建议。这可能会引导进行架构审查，以了解如何在你的环境中最佳实施，并为产品和解决方案的开发流程提供反馈，如**Puppet
    数据服务**（**PDS**）和**Puppet Enterprise 管理模块**（**peadm**）。此外，**技术账户经理**（**TAMs**）将被分配为你提供定期的联系人，帮助你在
    Puppet 中取得成功，支持你为你的组织制定成功计划，并专注于确保部署能够实现其目标。
- en: Puppet provides reference architectures and patterns of Puppet products to show
    how to work at different scales and implementation types. Additional applications
    built on top of the Puppet Server service allow for access control, server classification,
    code deployment, visualization, and searching of data to be completed in a standard
    way from the console. We will look at these in greater detail in the following
    section.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet 提供了 Puppet 产品的参考架构和模式，展示如何在不同的规模和实现类型下工作。构建在 Puppet Server 服务之上的附加应用程序允许进行访问控制、服务器分类、代码部署、可视化和数据搜索，所有操作都可以通过控制台以标准方式完成。我们将在接下来的部分中更详细地探讨这些内容。
- en: Exploring the Puppet Enterprise console and services
  id: totrans-20
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 探索 Puppet Enterprise 控制台和服务
- en: 'There are several additional services built into a **Puppet Enterprise primary
    server**, as shown in the following diagram:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 在**Puppet Enterprise 主服务器**中内置了若干附加服务，如下图所示：
- en: '![Figure 14.1 – Puppet Enterprise components](img/B18492_14_01.jpg)'
  id: totrans-22
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.1 – Puppet Enterprise 组件](img/B18492_14_01.jpg)'
- en: Figure 14.1 – Puppet Enterprise components
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.1 – Puppet Enterprise 组件
- en: Puppet Server
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Puppet 服务器
- en: The **Puppet** service is the same as discussed in [*Chapter 10*](B18492_10.xhtml#_idTextAnchor252),
    with the **certificate authority** (**CA**) providing a certificate signing process
    to secure communication and the Puppet agent contacting a compiler’s Puppet Server
    service to request a catalog compilation. **Facter** is used to provide a server
    profile. In *Figure 14**.1*, we opt not to show that the primary server itself
    has a Puppet Server service, and both the compiler and primary server have Puppet
    agents, which both request catalog compilations from the primary server’s Puppet
    server.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: '**Puppet** 服务与[*第 10 章*](B18492_10.xhtml#_idTextAnchor252)中讨论的相同，**证书颁发机构**
    (**CA**) 提供证书签名过程以保证通信安全，Puppet 代理联系编译器的 Puppet 服务器服务请求目录编译。 **Facter** 用于提供服务器配置文件。在
    *图 14**.1* 中，我们选择不显示主服务器本身有一个 Puppet 服务器服务，并且编译器和主服务器都有 Puppet 代理，它们都从主服务器的 Puppet
    服务器请求目录编译。'
- en: Introducing Puppet web console components
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 引入 Puppet Web 控制台组件
- en: The most obvious immediate difference of the Puppet Enterprise server is the
    **web console**, which provides the login view we have been using in our lab throughout
    this book. Several services combine to make up the console services
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise 服务器最明显的直接差异是提供我们在本书实验室中使用的登录视图的 **Web 控制台**。几个服务结合在一起形成控制台服务
- en: The console is a web frontend Jetty-based Clojure service with an NGINX server
    that acts as a reverse proxy. The NGINX server listens on port HTTPS `443` and
    redirects HTTP 80 to HTTPS. The console UI provides an aggregation and translation
    Jetty-based Clojure service to generate the correct pages and access other console
    services.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 控制台是一个基于 Jetty 的 Clojure Web 前端服务，具有充当反向代理的 NGINX 服务器。 NGINX 服务器在 HTTPS 端口 `443`
    上监听并将 HTTP 80 重定向到 HTTPS。控制台 UI 提供聚合和翻译 Jetty-based Clojure 服务以生成正确的页面并访问其他控制台服务。
- en: 'The authentication UI generates login and resets password content pages. The
    simplest way to show this is to use an example of the communication required when
    logging in, as shown in the following diagram:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 认证 UI 生成登录和重置密码内容页面。展示这一点的最简单方式是使用登录时所需的通信示例，如下图所示：
- en: '![Figure 14.2 – Steps to generate the login page](img/B18492_14_02.jpg)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.2 – 生成登录页面的步骤](img/B18492_14_02.jpg)'
- en: Figure 14.2 – Steps to generate the login page
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.2 – 生成登录页面的步骤
- en: It can be seen from the diagram that as a first step, the NGINX server receives
    a `GET` request and, after performing TLS negotiation, redirects to the console
    Jetty page. This page evaluates cookies, establishes the user is not logged in,
    and redirects to the auth/login page, which is requested from NGINX and redirected
    to the authentication UI. The authentication UI generates a login page and gets
    **Security Assertion Markup Language** (**SAML**) configuration from the RBAC
    Jetty page, and this login page is then passed back to the user.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 可以从图表中看出，作为第一步，NGINX 服务器接收 `GET` 请求，并在执行 TLS 协商后重定向到控制台 Jetty 页面。该页面评估 cookie，确认用户未登录，并重定向到
    auth/login 页面，该页面从 NGINX 请求并重定向到认证 UI。认证 UI 生成登录页面，并从 RBAC Jetty 页面获取 **安全断言标记语言**
    (**SAML**) 配置，然后将此登录页面传回用户。
- en: The **RBAC service** has users and roles to construct access policies. It allows
    for both local and remote users in Puppet Enterprise, with integration possible
    to **Lightweight Directory Access Protocol (LDAP**) and SAML services. All users
    by default are denied permission to create, edit, or view any part of Puppet Enterprise,
    and permissions are then granted via roles.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: '**RBAC 服务** 具有用户和角色来构建访问策略。它允许在 Puppet Enterprise 中使用本地和远程用户，并可以集成到 **轻量目录访问协议
    (LDAP)** 和 SAML 服务中。所有用户默认被拒绝创建、编辑或查看 Puppet Enterprise 的任何部分的权限，然后通过角色授予权限。'
- en: By default, there will be a local administrative user who acts as a superuser
    for the Puppet service and an API user for authentication for Puppet services
    to communicate within Puppet Enterprise. It cannot be used for login and only
    authenticates with certificate authentication. There is an allow list that has
    the `certname` values of certificates that can be used with the API user.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，将有一个本地管理员用户作为 Puppet 服务的超级用户以及用于 Puppet 服务内部通信的 API 用户进行身份验证。它不能用于登录，只能通过证书身份验证进行身份验证。有一个允许列表，其中包含可以与
    API 用户一起使用的证书的 `certname` 值。
- en: Roles allow the grouping of permissions to give users permission to perform
    actions. A permission is made up of a **type**, a **permission**, and an **object**.
    The type is what the permission will allow actions on, such as users or node groups.
    A permission is a level of access from create, edit, or view, and an object is
    a specific instance of the type such as the Puppet Enterprise infrastructure node
    group for a node group type.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 角色允许将权限分组，以便授予用户执行操作的权限。权限由**类型**、**权限**和**对象**组成。类型是权限将允许在其上执行操作的对象，例如用户或节点组。权限是创建、编辑或查看的访问级别，而对象是类型的特定实例，例如节点组类型中的Puppet
    Enterprise基础设施节点组。
- en: 'There are five roles provided by default:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 默认提供五个角色：
- en: '**Administrators**: All permissions'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**管理员**：所有权限'
- en: '**Operators**: Permission to create and modify node groups, deploy code, run
    Puppet, run sign certificates, and view the console'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**操作员**：创建和修改节点组、部署代码、运行Puppet、签署证书并查看控制台的权限'
- en: '**Viewers**: Permission to view the console, node groups, and jobs'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**查看者**：查看控制台、节点组和作业的权限'
- en: '**Code deployers**: Permission to deploy code with Code Manager'
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**代码部署者**：使用代码管理器部署代码的权限'
- en: '**Project deployers**: Permission to deploy projects, run tasks and plans from
    projects, and start, stop, and view jobs in orchestrator'
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**项目部署者**：部署项目、从项目中运行任务和计划，并在调度器中启动、停止和查看作业的权限'
- en: Custom roles can be created with the consultation of [https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions](https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions
    ) to find the right granularity of user permissions.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 可以通过参考[https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions](https://puppet.com/docs/pe/2021.7/rbac_permissions_intro.html#user_permissions)来创建自定义角色，以找到正确的用户权限粒度。
- en: '**LDAP solutions** such as **Active Directory** (**AD**) can map user groups
    to roles, while **SAML solutions** such as **Okta** can do similar user group
    mapping with attributes to match to roles. Both LDAP and SAML are configured in
    the web console on the **Access control** tab by selecting the corresponding option.'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '**LDAP解决方案**，如**Active Directory**（**AD**）可以将用户组映射到角色，而**SAML解决方案**，如**Okta**，可以通过属性对用户组进行类似的映射，以匹配角色。LDAP和SAML都可以在Web控制台的**访问控制**选项卡中配置，通过选择相应的选项来进行映射。'
- en: Tokens are used for all web sessions, and instead of logging in with a password
    whenever running commands, tokens can be generated for multiple uses. The tokens
    are alphanumeric values between `0` and `2^256 – 1` and stored in the database
    and, depending on the argument, a local file location. Tokens are generated by
    either the token API endpoint, the web console in the `puppet access login` command
    on the CLI. The token is against the user credentials provided, so will have the
    permissions set to that user. By default, the `puppet access login` command will
    write the token to `~/.puppetlabs/token` with a lifetime of 30 minutes unless
    the `--lifetime` is used to set a lifetime such as `5h` for 5 hours.. The `--print`
    flag will cause the token to only be printed and not stored, which is appropriate
    for service-based API access.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 令牌用于所有Web会话，且在运行命令时不需要每次都用密码登录，而是可以生成多个用途的令牌。这些令牌是介于`0`和`2^256 – 1`之间的字母数字值，存储在数据库中，并根据参数存储在本地文件位置。令牌通过令牌API端点、`puppet
    access login`命令的Web控制台或CLI生成。令牌是基于提供的用户凭据生成的，因此将具有该用户设置的权限。默认情况下，`puppet access
    login`命令会将令牌写入`~/.puppetlabs/token`，其生命周期为30分钟，除非使用`--lifetime`选项设置例如`5h`（5小时）的生命周期。`--print`标志会使令牌仅被打印而不存储，这适用于基于服务的API访问。
- en: The classifier service was discussed in [*Chapter 11*](B18492_11.xhtml#_idTextAnchor272),
    where we looked at how it used **node groups** to classify servers in Puppet,
    but to reiterate the key points, node groups are used to classify classes to servers
    either by using facts or directly pinning named servers. Node groups are inheritance
    based, so each child of a node group will inherit everything above it.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 在[*第11章*](B18492_11.xhtml#_idTextAnchor272)中讨论了分类服务，我们探讨了它如何使用**节点组**在Puppet中对服务器进行分类，但为了重申关键点，节点组用于通过使用事实或直接固定命名的服务器来将类分类到服务器。节点组是基于继承的，因此节点组的每个子节点都会继承其上方的所有内容。
- en: Code Manager was discussed in [*Chapter 11*](B18492_11.xhtml#_idTextAnchor272),
    showing how the `r10k` to download modules based on a Puppet file in a control
    repo from a named Git repository, and the `filesync` server and `filesync` clients
    then kept this copy of code in sync across the services.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 代码管理器在[**第11章**](B18492_11.xhtml#_idTextAnchor272)中进行了讨论，展示了如何使用`r10k`从命名的Git存储库中的控制仓库下载基于Puppet文件的模块，然后通过`filesync`服务器和`filesync`客户端保持该代码副本在各个服务之间同步。
- en: The **activity service** is used to log all activities that have taken place
    through the console service and can be viewed by the API endpoint and on the web
    console in various places, such as the **activity** tab on any user and role.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: '**活动服务**用于记录通过控制台服务发生的所有活动，可以通过API端点以及在Web控制台的多个位置查看，例如任何用户和角色的**活动**标签。'
- en: 'The database components of Puppet Enterprise, **PuppetDB** with **PostgreSQL**,
    are the same as was discussed in [*Chapter 10*](B18492_10.xhtml#_idTextAnchor252),
    but several of the services need additional databases to store their state and
    records. So, the following databases are created:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise的数据库组件，**PuppetDB**与**PostgreSQL**，与[**第10章**](B18492_10.xhtml#_idTextAnchor252)中讨论的一样，但几个服务需要额外的数据库来存储它们的状态和记录。因此，创建了以下数据库：
- en: '`pe-activity`: All auditable activities of console services'
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-activity`：控制台服务的所有可审计活动'
- en: '`pe-classifier`: All node group information'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-classifier`：所有节点组信息'
- en: '`pe-inventory`: Agentless client details and their access method for orchestrator'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-inventory`：无代理客户端详细信息及其访问方式，用于编排器'
- en: '`pe-orchestrator`: Job runs, job results, users, and node'
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-orchestrator`：作业运行、作业结果、用户和节点'
- en: '`pe-postgres`: Postgres databases for templating and general access. See [https://www.postgresql.org/docs/current/manage-ag-templatedbs.html](https://www.postgresql.org/docs/current/manage-ag-templatedbs.html)
    to understand template databases further.'
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-postgres`：用于模板和一般访问的Postgres数据库。请参阅[https://www.postgresql.org/docs/current/manage-ag-templatedbs.html](https://www.postgresql.org/docs/current/manage-ag-templatedbs.html)以进一步了解模板数据库。'
- en: '`pe-puppetdb`: Reports, node information, and last run catalog'
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-puppetdb`：报告、节点信息和上次运行的清单'
- en: '`pe-rbac`: Users, roles, groups, and AD/LDAP information'
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-rbac`：用户、角色、组以及AD/LDAP信息'
- en: Note
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: All PostgreSQL communication is done using certificates, including communications
    to replicas.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 所有PostgreSQL通信均使用证书进行，包括与副本的通信。
- en: The one component which was not covered in *Figure 14**.1* was the orchestrator
    services. We will now cover how orchestrator provides the capability of using
    Bolt plans and tasks within Puppet Enterprise.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在*图 14**.1*中未涉及的一个组件是编排器服务。现在我们将介绍编排器如何提供在Puppet Enterprise中使用Bolt计划和任务的能力。
- en: Using Bolt with Puppet Enterprise
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Bolt与Puppet Enterprise
- en: In [*Chapter 12*](B18492_12.xhtml#_idTextAnchor293), it was seen how Bolt was
    run using the `bolt` binary within a Bolt project, but it can be used integrated
    with Puppet Enterprise via the **orchestrator service**, allowing plans and tasks
    to be run as part of Puppet Enterprise.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 在[**第12章**](B18492_12.xhtml#_idTextAnchor293)中，介绍了如何在Bolt项目中使用`bolt`二进制文件运行Bolt，但它可以通过**编排器服务**与Puppet
    Enterprise集成，允许将计划和任务作为Puppet Enterprise的一部分运行。
- en: The key difference is that currently, only Puppet modules containing tasks and
    plans can be deployed (including adding them to a control repo); there is no current
    method of deploying bolt projects to Puppet Enterprise directly.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 主要区别在于，目前只能部署包含任务和计划的Puppet模块（包括将它们添加到控制仓库）；目前没有直接将bolt项目部署到Puppet Enterprise的方法。
- en: Note
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: With plans and tasks deployed through modules, this means the same plan or task
    can have multiple versions, depending on the environment it is run from.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 通过模块部署的计划和任务意味着相同的计划或任务可以有多个版本，具体取决于运行环境。
- en: It is also important to realize not all of the features available to Bolt natively
    will be available within Puppet Enterprise.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 还需要注意，并非Bolt原生提供的所有功能都能在Puppet Enterprise中使用。
- en: 'The following list highlights the key differences when running plans and tasks
    in Puppet Enterprise in orchestrator instead of in native Bolt:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 以下列表突出显示了在编排器中运行Puppet Enterprise的计划和任务与在原生Bolt中运行时的主要区别：
- en: Various Bolt functions for plans, such as `prompt`, `parallelize`, and `file.upload`,
    have not been implemented
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于计划的各种Bolt功能，如`prompt`、`parallelize`和`file.upload`，尚未实现
- en: '`puppet apply` blocks can only be applied to nodes with a Puppet agent'
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`puppet apply`模块只能应用于具有Puppet代理的节点'
- en: Targets and the localhost target are unavailable
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 目标和本地主机目标不可用
- en: File sources must be module based and cannot be absolute paths
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文件源必须基于模块，不能是绝对路径
- en: Most of these limitations reflect not running Bolt from a local machine and
    a lack of a prompt to run them. Full details can be viewed in Puppet’s documentation
    at [https://puppet.com/docs/pe/2021.7/plans_limitations.html](https://puppet.com/docs/pe/2021.7/plans_limitations.html).
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 这些大部分限制反映了没有从本地机器运行 Bolt，以及缺少运行它们的提示。完整的详情可以在 Puppet 的文档中查看：[https://puppet.com/docs/pe/2021.7/plans_limitations.html](https://puppet.com/docs/pe/2021.7/plans_limitations.html)。
- en: 'Puppet Enterprise handles three types of nodes with plans and tasks:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise 处理三种类型的节点，包含计划和任务：
- en: Nodes with a Puppet agent installed, using the **Puppet Communications Protocol**
    (**PCP**) and the **PCP Execution** **Protocol** (**PXP**)
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装了 Puppet 代理的节点，使用**Puppet 通信协议**（**PCP**）和**PCP 执行协议**（**PXP**）
- en: Agentless nodes via the **Windows Remote Management** (**WinRM**) and **Secure
    Shell** (**SSH**) transports
  id: totrans-73
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过**Windows 远程管理**（**WinRM**）和**安全外壳**（**SSH**）传输的无代理节点
- en: Agentless devices such as switches or firewalls via transports such as F5 and
    **Palo Alto Netorks Operating system** (**PAN-OS**) or transports provided via
    the resource API
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过如 F5 和**Palo Alto Networks 操作系统**（**PAN-OS**）等传输或通过资源 API 提供的传输连接的无代理设备，如交换机或防火墙
- en: Having highlighted what orchestrator is capable of running for plans and tasks,
    we will now look at the components that make up orchestrator, highlighting the
    purpose of these services and key details such as log locations and configuration
    files.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 在介绍了编排器可以运行的计划和任务之后，我们现在来看一下构成编排器的组件，重点介绍这些服务的目的和关键细节，如日志位置和配置文件。
- en: Orchestrator services
  id: totrans-76
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 编排器服务
- en: 'The orchestrator application is a **Clojure** application made up of the services
    shown in the following diagram:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 编排器应用是一个由下图所示服务组成的**Clojure**应用：
- en: '![Figure 14.3 – Components of the Puppet orchestrator service](img/B18492_14_03.jpg)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.3 – Puppet 编排器服务的组成部分](img/B18492_14_03.jpg)'
- en: Figure 14.3 – Components of the Puppet orchestrator service
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.3 – Puppet 编排器服务的组成部分
- en: 'Let’s have an overview of these components and their relevant services and
    log files:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们概览一下这些组件及其相关的服务和日志文件：
- en: '`pe-orchestration-services.service` and logs to `/var/log/puppetlabs/orchestration-services/orchestration-services.log`.'
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-orchestration-services.service`并记录到`/var/log/puppetlabs/orchestration-services/orchestration-services.log`。'
- en: '`POST /command/create-connection` inventory API call ([https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints](https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints)).
    These entries are encrypted by a secret key, by default placed at `/etc/puppetlabs/orchestration-services/conf.d/secrets/keys.json`,
    and although listed separately, the inventory service runs within `pe-orchestration-services`.
    It stores its data in the PostgreSQL inventory database.'
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`POST /command/create-connection` 清单 API 调用（[https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints](https://puppet.com/docs/pe/2021.7/node-inventory-v1-command-endpoints.html#node-inventory-v1-command-endpoints)）。这些条目通过一个密钥加密，默认情况下存放在`/etc/puppetlabs/orchestration-services/conf.d/secrets/keys.json`，尽管这些条目是单独列出的，但清单服务运行在`pe-orchestration-services`内。它将数据存储在
    PostgreSQL 清单数据库中。'
- en: Note
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Agentless nodes added to the inventory are counted within the overall licensed
    number of nodes for Puppet Enterprise.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 添加到清单中的无代理节点会计入 Puppet Enterprise 的整体授权节点数。
- en: '`pe-bolt-server.service` and logs to `/var/log/puppetlabs/bolt-server/bolt-server.log`.'
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-bolt-server.service`并记录到`/var/log/puppetlabs/bolt-server/bolt-server.log`。'
- en: '`pe-ace-server.service` and logs to `/var/log/puppetlabs/ace-server/ace-server.log`.'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pe-ace-server.service`并记录到`/var/log/puppetlabs/ace-server/ace-server.log`。'
- en: '`/var/log/puppetlabs/orchestration-services/pcp-broker-access.log` and general
    service logs are logged to `/var/log/puppetlabs/orchestration-services/pcp-broker.log`.'
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`/var/log/puppetlabs/orchestration-services/pcp-broker-access.log`和一般服务日志记录到`/var/log/puppetlabs/orchestration-services/pcp-broker.log`。'
- en: '`pxp-agent.service` and logs to `/var/log/puppetlabs/pxp-agent/pxp-agent.log`.'
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pxp-agent.service`并记录到`/var/log/puppetlabs/pxp-agent/pxp-agent.log`。'
- en: 'The orchestrator service will verify via RBAC that the Puppet Enterprise console
    user has the correct permissions. For plans, it is only possible to specify users
    or groups and which plans they can run with no limit of nodes or which environment
    the plan will come from. For tasks, task targets allow a list of tasks and either
    a **Puppet Query Language** (**PQL**) query of nodes or groups of nodes to be
    specified, which the tasks can be run against. This can be done either via the
    API call, as shown at [https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target](https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target),
    or in the RBAC GUI, as shown in the following screenshot:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: orchestrator 服务将通过 RBAC 验证 Puppet Enterprise 控制台用户是否拥有正确的权限。对于计划，只能指定用户或组以及他们可以运行的计划，不限制节点或计划来源的环境。对于任务，任务目标允许指定一组任务和一个
    **Puppet 查询语言** (**PQL**) 查询节点或节点组，任务可以针对这些节点执行。这可以通过 API 调用完成，如 [https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target](https://www.puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html#orchestrator_api_post_command_task_target)
    所示，或者通过 RBAC 图形用户界面，如下图所示：
- en: '![Figure 14.4 – Creating a task target on the web console](img/B18492_14_04.jpg)'
  id: totrans-90
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.4 – 在 web 控制台上创建任务目标](img/B18492_14_04.jpg)'
- en: Figure 14.4 – Creating a task target on the web console
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.4 – 在 web 控制台上创建任务目标
- en: In the next section, we will learn how to run tasks, plans, or Puppet runs through
    orchestrator.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，我们将学习如何通过 orchestrator 运行任务、计划或 Puppet 运行。
- en: Running jobs
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 运行作业
- en: 'When tasks, plans, or Puppet runs are run through orchestrator, they become
    known as **jobs**. There are three ways to run jobs, as follows:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 当通过 orchestrator 运行任务、计划或 Puppet 运行时，它们被称为 **作业**。有三种方式运行作业，如下所示：
- en: The first way to do this is via the GUI by selecting the relevant menu on the
    left bar.
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第一种方法是通过 GUI 选择左侧栏中的相关菜单。
- en: 'The second is via the CLI on the primary server with largely the same syntax
    as the `puppet task run` and `puppet plan run` Bolt commands. The key differences
    compared to Bolt are that the `--nodes` flag is used instead of `targets` (reflecting
    the fact you will be just providing a node name, for which orchestrator will lookup
    transport information) and extra flags are available, such as the --`node-groups`
    flag, for choosing a node group to run against. Here’s an example:'
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第二种方法是通过主服务器上的 CLI，语法与 `puppet task run` 和 `puppet plan run` Bolt 命令基本相同。与 Bolt
    的关键区别在于，`--nodes` 标志用于代替 `targets`（反映了您只提供节点名称，而 orchestrator 将查找传输信息），并且提供了额外的标志，如
    --`node-groups` 标志，用于选择要运行的节点组。以下是一个示例：
- en: '[PRE1]'
  id: totrans-97
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The third way is via the APIs documented at [https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html](https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html),
    with the key calls listed here:'
  id: totrans-98
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第三种方法是通过 [https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html](https://puppet.com/docs/pe/2021.7/orchestrator_api_commands_endpoint.html)
    中文档化的 API，以下是一些关键调用：
- en: '`POST /command/deploy`: Run Puppet on demand'
  id: totrans-99
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`POST /command/deploy`: 按需运行 Puppet'
- en: '`POST /command/plan_run`: Run a plan'
  id: totrans-100
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`POST /command/plan_run`: 运行计划'
- en: '`POST /command/task`: Run a task on a set of nodes'
  id: totrans-101
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`POST /command/task`: 在一组节点上运行任务'
- en: Jobs in progress can be stopped by pressing *Ctrl* + *C* on the CLI, selecting
    `POST /command/stop` API command. Although we should be careful to note a stopped
    jobs underlying process may run to completion regardless.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 正在进行的作业可以通过按下 *Ctrl* + *C* 在 CLI 中停止，或选择 `POST /command/stop` API 命令。虽然我们应该小心，注意停止的作业底层进程可能会继续运行直到完成。
- en: An API command was introduced in PE 2021.7.1 `POST /command/stop_plan` to allow
    for plans to be stopped.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 在 PE 2021.7.1 中引入了一个 API 命令 `POST /command/stop_plan`，允许停止计划。
- en: It is also possible to schedule jobs in orchestrator via the GUI or by `API
    POST /scheduled_jobs/environment_jobs`, but great care should be taken to be aware
    of the system load of using the scheduler. Orchestrator has limitations with how
    it scales since there is no way to horizontally scale, and the queuing system
    for tasks and plans can be easily blocked by certain types of requests.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 还可以通过 GUI 或 `API POST /scheduled_jobs/environment_jobs` 在 orchestrator 中调度作业，但需要特别小心，注意使用调度器时的系统负载。由于
    orchestrator 无法水平扩展，且任务和计划的队列系统可能会被某些类型的请求轻易阻塞，因此需要特别注意其扩展性限制。
- en: Configuring performance settings
  id: totrans-105
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 配置性能设置
- en: The settings discussed in this section can all be configured in the Puppet Enterprise
    orchestrator infrastructure node group on the web console or as code in Hiera.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 本节中讨论的设置都可以在 Puppet Enterprise orchestrator 基础设施节点组中配置，通过 Web 控制台或以代码形式在 Hiera
    中进行配置。
- en: 'orchestrator can run a maximum number of tasks concurrently; this maximum number
    of concurrent tasks is configured with the `puppet_enterprise::profile::orchestrator::task_concurrency`
    parameter (default: `250`), along with `puppet_enterprise::profile::bolt_server::concurrency`
    (default: `100`) and `puppet_enterprise::profile::ace_server::concurrency` (default:
    `100`), which limit Ace and Bolt directly (they should not be greater than the
    `orchestrator::task_concurrency` total). Their sizes are mainly limited by orchestrator
    memory, which will reserve approximately ± 1 MB of RAM for each instance of capacity
    you add. Tasks are dealt with in the order they are received until they are completed;
    this means long-running tasks and tasks with large numbers of targets can potentially
    block other tasks from running and monopolize resources. Taking the case of running
    tasks taking 10 minutes to complete on 1,000, servers this would result in the
    task using the queue capacity of 250 four times and taking a total executing time
    of 40 minutes to run the tasks on all targets, during which time all other tasks
    would need to queue until it was complete. It is strongly recommended that a task
    should take no longer than 5 minutes and that careful management should take place
    to run tasks in smaller batches. It should also be noted there is no limit in
    the task queue and it risks running `puppet_enterprise::profile::orchestrator::allowed_pcp_status_requests`
    parameter. It is important to understand this does not mean the task has failed
    but simply that orchestrator cannot get a status for it within the timeout. The
    task itself may have completed after this time.'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: orchestrator 可以同时运行最多数量的任务；这个最大并发任务数通过 `puppet_enterprise::profile::orchestrator::task_concurrency`
    参数配置（默认值：`250`），以及 `puppet_enterprise::profile::bolt_server::concurrency`（默认值：`100`）和
    `puppet_enterprise::profile::ace_server::concurrency`（默认值：`100`）一起配置，直接限制 Ace
    和 Bolt（它们的数量不应大于 `orchestrator::task_concurrency` 总数）。它们的大小主要受到 orchestrator 内存的限制，orchestrator
    会为你添加的每个实例容量保留大约 ± 1 MB 的 RAM。任务会按照接收到的顺序处理，直到完成；这意味着长时间运行的任务和目标数较多的任务可能会阻塞其他任务的运行并垄断资源。以运行任务需要
    10 分钟来完成 1,000 个服务器为例，这将导致任务使用 250 的队列容量四次，执行任务的总时间为 40 分钟，在此期间，所有其他任务需要排队直到完成。强烈建议任务的执行时间不超过
    5 分钟，并且需要精心管理任务，分批运行。同时需要注意，任务队列没有限制，并且有可能触及 `puppet_enterprise::profile::orchestrator::allowed_pcp_status_requests`
    参数。理解这一点很重要，这并不意味着任务失败，而是 orchestrator 无法在超时时间内获取任务状态。任务本身可能在此之后已完成。
- en: For plans, orchestrator is similar to Puppet Server in requiring JRuby instances
    to compile plans. This capacity is set by `puppet_enterprise::profile::orchestrator::jruby_max_active_instances`,
    with heap memory for the JVM set at `puppet_enterprise::profile::orchestrator::java_args`.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 对于计划，orchestrator 与 Puppet Server 类似，需要 JRuby 实例来编译计划。这个容量由 `puppet_enterprise::profile::orchestrator::jruby_max_active_instances`
    设置，JVM 的堆内存通过 `puppet_enterprise::profile::orchestrator::java_args` 设置。
- en: Having discussed the core components and services of Puppet Enterprise, we will
    now look at how these components can be deployed using automated tools, deploying
    to Puppet-advised reference architectures to ensure that infrastructure will scale
    to user requirements.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 在讨论了 Puppet Enterprise 的核心组件和服务后，我们将进一步探讨如何使用自动化工具部署这些组件，并部署到 Puppet 推荐的参考架构上，以确保基础设施能够根据用户需求进行扩展。
- en: Automating deployment and reference architectures
  id: totrans-110
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 自动化部署与参考架构
- en: Puppet Enterprise focuses on creating standard architectures and configurations
    and the automation to deploy them. This ensures that less design effort is required
    from Puppet Enterprise customers who can find the right standard architecture
    and pattern and deploy it using provided tooling.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise 专注于创建标准架构和配置以及自动化部署它们。这确保了 Puppet Enterprise 客户能够找到合适的标准架构和模式，并使用提供的工具进行部署，从而减少了设计工作的量。
- en: Understanding supported architectures
  id: totrans-112
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 理解支持的架构
- en: 'Puppet documents three supported architectures for Puppet Enterprise, as follows:'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet 为 Puppet Enterprise 提供了三种支持的架构，如下所示：
- en: The **standard installation** is just a standalone primary server and supports
    up to 2,500 clients
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**标准安装**仅为一个独立的主服务器，并支持最多 2,500 个客户端。'
- en: The **large installation** is a primary server with compile servers behind a
    load balancer and supports up to 20,000 clients
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**大型安装**是一个主服务器，后面有编译服务器，通过负载均衡器连接，支持最多20,000个客户端。'
- en: '**Extra-large installations** are a primary server, a separate server with
    PuppetDB, and compile servers behind a load balancer supporting over 20,000 servers'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**超大型安装**包括一个主服务器，一个单独的PuppetDB服务器，以及通过负载均衡器连接的编译服务器，支持超过20,000个服务器。'
- en: 'These are illustrated in the following diagram:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是通过图示说明：
- en: '![Figure 14.5 – Standard architectures](img/B18492_14_05.jpg)'
  id: totrans-118
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.5 – 标准架构](img/B18492_14_05.jpg)'
- en: Figure 14.5 – Standard architectures
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.5 – 标准架构
- en: The standard architecture is limited by how many clients a primary server can
    run catalogs for by itself, up to 2,500 nodes. Over this level, the large architecture
    allows horizontal scaling using compiler nodes but reaches limits of how much
    load a single primary server can take running all the services together. So, at
    25,000 nodes, the extra-large architecture recommends separating out PuppetDB
    as one of the heaviest services to its own server.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 标准架构受到主服务器能为多少客户端运行目录的限制，最多支持2,500个节点。超过此数量后，大型架构允许通过编译节点进行横向扩展，但也面临单个主服务器无法承载所有服务负载的限制。因此，在25,000个节点时，超大型架构建议将PuppetDB作为最重的服务之一分离到单独的服务器上。
- en: 'In all these architectures, it is possible to provide a replica server to the
    primary server and a separate PostgreSQL server, through a method named **disaster
    recovery** (**DR**). In the event of loss of the primary or PostgreSQL server,
    DR gives the ability to perform failover actions and recover services with an
    expected loss of some services, as listed in the following tabular breakdown of
    services:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 在所有这些架构中，可以通过名为**灾难恢复**（**DR**）的方法，为主服务器和单独的PostgreSQL服务器提供副本服务器。如果主服务器或PostgreSQL服务器发生故障，灾难恢复可以执行故障转移操作并恢复服务，预期会丢失部分服务，以下是服务的详细表格：
- en: '| **Service name** | **Replication type** | **Failover approach** |'
  id: totrans-122
  prefs: []
  type: TYPE_TB
  zh: '| **服务名称** | **复制类型** | **故障转移方法** |'
- en: '| Puppet Server | None | Active / Active |'
  id: totrans-123
  prefs: []
  type: TYPE_TB
  zh: '| Puppet 服务器 | 无 | 主动 / 主动 |'
- en: '| Console services UI | None | Read-only until manual promotion |'
  id: totrans-124
  prefs: []
  type: TYPE_TB
  zh: '| 控制台服务 UI | 无 | 直到手动提升前为只读 |'
- en: '| ACE service | None | Read-only until manual promotion |'
  id: totrans-125
  prefs: []
  type: TYPE_TB
  zh: '| ACE 服务 | 无 | 直到手动提升前为只读 |'
- en: '| Bolt service | None | Read-only until manual promotion |'
  id: totrans-126
  prefs: []
  type: TYPE_TB
  zh: '| Bolt 服务 | 无 | 直到手动提升前为只读 |'
- en: '| CA | One-way replication | Read-only until manual promotion |'
  id: totrans-127
  prefs: []
  type: TYPE_TB
  zh: '| CA | 单向复制 | 直到手动提升前为只读 |'
- en: '| RBAC | One-way replication | Read-only until manual promotion |'
  id: totrans-128
  prefs: []
  type: TYPE_TB
  zh: '| RBAC | 单向复制 | 直到手动提升前为只读 |'
- en: '| Classifier | One-way replication | Read-only until manual promotion |'
  id: totrans-129
  prefs: []
  type: TYPE_TB
  zh: '| 分类器 | 单向复制 | 直到手动提升前为只读 |'
- en: '| Activity | One-way replication | Read-only until manual promotion |'
  id: totrans-130
  prefs: []
  type: TYPE_TB
  zh: '| 活动 | 单向复制 | 直到手动提升前为只读 |'
- en: '| Orchestration | One-way replication | Read-only until manual promotion |'
  id: totrans-131
  prefs: []
  type: TYPE_TB
  zh: '| 编排 | 单向复制 | 直到手动提升前为只读 |'
- en: '| File sync | One-way replication | Read-only until manual promotion |'
  id: totrans-132
  prefs: []
  type: TYPE_TB
  zh: '| 文件同步 | 单向复制 | 直到手动提升前为只读 |'
- en: '| PuppetDB | Bi-directional | Active – Active |'
  id: totrans-133
  prefs: []
  type: TYPE_TB
  zh: '| PuppetDB | 双向 | 主动 – 主动 |'
- en: Table 14.1 – Service replication and failover approach for DR
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 表 14.1 – 服务复制和灾难恢复方法
- en: PuppetDB is unique in its synchronization within Puppet Enterprise; it performs
    a read-write synchronization between primary and replica, which is why it is the
    only service in the previous list that synchronizes and is available on promotion.
    The other services that use PostgreSQL rely on a `PGLogical` synchronization from
    primary to replica, making the data read-only on the replica.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: PuppetDB在Puppet Enterprise中的同步机制是独特的；它在主服务器和副本之间执行读写同步，这也是它在前述列表中唯一可以同步并在提升时可用的服务。其他使用PostgreSQL的服务依赖于从主服务器到副本的`PGLogical`同步，使得副本上的数据为只读。
- en: What can be seen from this list is during the failure of a primary server, the
    replica will only be able to take over and compile catalogs of servers already
    registered, queries and reports from PuppetDB, and queries of node classification
    via the API. This means no new servers can be registered or removed, no new code
    can be deployed, the web console cannot be used, classification cannot be changed,
    and most of the CLI tools will be non-functional until manual promotion actions
    are taken via the `puppet infrastructure promote replica` command on the replica.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 从这个列表可以看出，在主服务器故障时，副本将只能接管并编译已经注册的服务器的目录、来自 PuppetDB 的查询和报告，以及通过 API 进行的节点分类查询。这意味着无法注册或删除新服务器，无法部署新代码，无法使用网页控制台，无法更改分类，并且大部分
    CLI 工具将无法使用，直到通过在副本上执行 `puppet infrastructure promote replica` 命令进行手动提升操作。
- en: This is an irreversible action, and the original failed primary server must
    be redeployed as a replica before it can be used again. Therefore, for many users
    attempting to fix the original primary server, this is less time-consuming than
    going through the DR process.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个不可逆的操作，原始的故障主服务器必须重新部署为副本才能再次使用。因此，对于许多试图修复原始主服务器的用户来说，这比通过 DR 过程更省时。
- en: DR should not be confused with **high availability** (**HA**), which would be
    expected for continuous service in the event of the loss of a server, and that
    is not possible in any current Puppet architecture.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: DR 不应与 **高可用性** (**HA**) 混淆，后者是在服务器丢失的情况下预期的连续服务，而这在当前任何 Puppet 架构中都是不可能的。
- en: Note
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: When using DR, peadm ensures that the compilers are split and configured into
    two groups and PuppetDB requests are distributed across the two sides of the PuppetDB
    replication to maximize capacity. If you choose not to use pecdm, ensure you follow
    this optimization, which can be seen in code at [https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp](https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp),
    with the A and B groups setting parameters for databases.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 DR 时，peadm 确保编译器被拆分并配置为两组，PuppetDB 请求在 PuppetDB 副本的两边分发，以最大化容量。如果选择不使用 pecdm，请确保遵循此优化，可在
    [https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp](https://github.com/puppetlabs/puppetlabs-peadm/blob/main/manifests/setup/node_manager.pp)
    中查看代码，A 和 B 组设置数据库的参数。
- en: 'The Puppet architecture also defines a set of multi-region patterns for how
    to deploy across regions both public and private cloud, where a region is defined
    by cloud vendors as data centers with regional low-latency connections. Full details
    are available at [https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html](https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html).
    Best practice requires compilers to have low-latency connections, and these are
    therefore best placed in the same region as primary and replica servers; similarly,
    the connection between primary and replica must be low latency. The best practice
    is, therefore, to use a centralized deployment where all Puppet infrastructure
    is in a management region that all regions can communicate with, as shown in the
    following diagram:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet 架构还定义了一套跨公共云和私有云区域部署的多区域模式，其中区域由云服务提供商定义为具有区域性低延迟连接的数据中心。完整的细节请参见 [https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html](https://puppet.com/docs/patterns-and-tactics/latest/reference-architectures/pe-multi-region-reference-architectures.html)。最佳实践要求编译器具有低延迟连接，因此最好将它们部署在与主服务器和副本服务器相同的区域；同样，主服务器和副本之间的连接必须是低延迟的。因此，最佳做法是使用集中式部署，其中所有
    Puppet 基础设施都位于一个所有区域都可以通信的管理区域，如下图所示：
- en: '![Figure 14.6 – Centralized and federated deployments](img/B18492_14_06.jpg)'
  id: totrans-142
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.6 – 集中式和联合式部署](img/B18492_14_06.jpg)'
- en: Figure 14.6 – Centralized and federated deployments
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.6 – 集中式和联合式部署
- en: Alternatively, a federated model can be used whereby Puppet infrastructure is
    placed in each region, with the downside that no single console views the whole
    estate.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 另外，也可以使用联合模型，在每个区域部署 Puppet 基础设施，缺点是没有一个控制台能够查看整个系统。
- en: Having discussed the architectures and patterns in full, it is time to see which
    tooling is available to deploy these patterns.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 讨论了架构和模式之后，接下来是查看可用于部署这些模式的工具。
- en: Deployment and configuration
  id: totrans-146
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 部署与配置
- en: 'Puppet automates the deployment of its server infrastructure in several layers.
    The first layer uses the Puppet Enterprise installer, a tarball file that is downloaded
    from Puppet containing all the necessary packages and scripts to install Puppet
    Enterprise. Once downloaded on a target server and untarred, the basic install
    can be done by running `./puppet-enterprise-installer`. It is possible to add
    custom configurations by creating a `-c` flag to its location, following the guidance
    at [https://puppet.com/docs/pe/2021.7/installing_pe.html](https://puppet.com/docs/pe/2021.7/installing_pe.html).
    Once a Puppet server is configured, the install scripts can be used to automate
    adding agents; a Bash script for Unix-based systems and a PowerShell script for
    Windows are hosted on a file server on the primary, which ensures the correct
    agent package is installed:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet通过多个层次自动化其服务器基础设施的部署。第一层使用Puppet Enterprise安装程序，这是一个从Puppet下载的tarball文件，其中包含所有必要的软件包和脚本来安装Puppet
    Enterprise。下载到目标服务器并解压后，可以通过运行`./puppet-enterprise-installer`来完成基本安装。可以通过创建`-c`标志并指向其位置，按照[https://puppet.com/docs/pe/2021.7/installing_pe.html](https://puppet.com/docs/pe/2021.7/installing_pe.html)上的指导添加自定义配置。一旦Puppet服务器配置完成，就可以使用安装脚本自动添加代理；Unix系统使用Bash脚本，Windows使用PowerShell脚本，这些脚本托管在主文件服务器上，确保正确的代理包被安装：
- en: '[PRE2]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: In the example, the options set `environment` to `production` in the `puppet.conf`
    file and ensure the service is not running. The full range of options is available
    and documented at [https://puppet.com/docs/pe/2021.7/installing_agents.html](https://puppet.com/docs/pe/2021.7/installing_agents.html).
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，选项将`environment`设置为`production`，并确保服务未运行。完整的选项范围可用并记录在[https://puppet.com/docs/pe/2021.7/installing_agents.html](https://puppet.com/docs/pe/2021.7/installing_agents.html)。
- en: This `install` script would only have installed the primary server and would
    require further manual steps to add compilers and replicas depending on the architecture
    we wanted. To deploy the next layer instead of using the Enterprise installer
    directly, we use the peadm module ([https://forge.puppet.com/modules/puppetlabs/peadm](https://forge.puppet.com/modules/puppetlabs/peadm)),
    a supported Puppet module that provides an automated way to run the Puppet Enterprise
    installer script and configure it to one of the supported architectures automatically.
    This module assumes the infrastructure required for the requested configuration
    is available and it is possible to go to another level and automatically provision
    in public cloud environments using the pecdm module ([https://github.com/puppetlabs/puppetlabs-pecdm](https://github.com/puppetlabs/puppetlabs-pecdm)).
    An example of usage of these modules was discussed in detail in [*Chapter 12*](B18492_12.xhtml#_idTextAnchor293)and
    is what we have been using throughout this book to deploy labs.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 这个`install`脚本仅安装了主服务器，且需要进一步的手动步骤才能根据我们想要的架构添加编译器和副本。为了部署下一个层级，除了直接使用Enterprise安装程序外，我们使用`peadm`模块（[https://forge.puppet.com/modules/puppetlabs/peadm](https://forge.puppet.com/modules/puppetlabs/peadm)），这是一个受支持的Puppet模块，提供了一种自动化方式来运行Puppet
    Enterprise安装脚本，并自动将其配置为支持的架构之一。此模块假设所请求的配置所需的基础设施已准备好，并且可以进一步提升，使用`pecdm`模块（[https://github.com/puppetlabs/puppetlabs-pecdm](https://github.com/puppetlabs/puppetlabs-pecdm)）在公共云环境中自动进行配置。关于这些模块的使用示例已在[*第12章*](B18492_12.xhtml#_idTextAnchor293)中详细讨论，并且是我们在本书中部署实验室时一直使用的方法。
- en: The `peadm` module itself goes beyond simple deployment and has plans and tasks
    to show the status of the server and allow the performance of version upgrades
    via its tasks and plans.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: '`peadm`模块本身不仅仅是一个简单的部署工具，它还具有显示服务器状态的计划和任务，并允许通过其任务和计划执行版本升级。'
- en: Puppet Enterprise combines modules installed in the `Enterprise` folder and
    configured either in the classifier or Hiera data with other file locations to
    place customizations. The console has a number of configurations that can be set
    either in the classification in the web console or via Hiera, such as failed login
    attempts set by `puppet_enterprise::profile::console::rbac_failed_attempts_lockout`
    and password complexity rules such as minimum password length, set by `puppet_enterprise::profile::console::password_minimum_length`.
    A full list of console customizations can be found at [https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services](https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services).
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise将安装在`Enterprise`文件夹中的模块与通过分类器或Hiera数据配置的模块结合，并与其他文件位置一起放置自定义配置。控制台有许多可以配置的项，这些项可以通过Web控制台中的分类或通过Hiera设置，例如，通过`puppet_enterprise::profile::console::rbac_failed_attempts_lockout`设置的失败登录尝试次数和通过`puppet_enterprise::profile::console::password_minimum_length`设置的密码复杂性规则，如最小密码长度。可以在[https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services](https://puppet.com/docs/pe/2021.7/config_console.html#configure_the_pe_console_and_console_services)中找到完整的控制台自定义配置列表。
- en: In addition, files can be placed for the console, by placing a file at the path
    specified by `puppet_enterprise::profile::console::disclaimer_content_path`, which
    defaults to `/etc/puppetlabs/console-services`. You can create a message to display
    when logging in to the console, such as a legal warning your organization may
    have.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，可以通过将文件放置在`puppet_enterprise::profile::console::disclaimer_content_path`指定的路径中，来为控制台放置文件，默认路径为`/etc/puppetlabs/console-services`。你可以创建一个登录控制台时显示的消息，例如贵组织可能需要的法律警告。
- en: Additionally in the console, it is possible to search for nodes based on PQL
    with predefined PQL examples selectable. It is possible to add your own PQL examples
    to the web console by simply placing a file at `/etc/puppetlabs/console-services/custom_pql_queries.json`
    using `/etc/puppetlabs/console-services/custom_pql_queries.json.example` as a
    template. The web console itself uses a self-signed CA by default, and this can
    be replaced with one signed by your organization’s CA system by placing the generated
    certificate at `/etc/puppetlabs/puppet/ssl/certs/console-cert.pem` and `/etc/puppetlabs/puppet/ssl/private_keys/console-cert.pem`.
    One last key file to consider is the license key, which is issued to you by Puppet
    and placed at `/etc/puppetlabs/license.key` with `644 root:root` permissions.
    You can view the details of licensing under the **License** tab on the web console.
    A Puppet agent run should be made for these changes and the console service restarted.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，在控制台中，还可以基于PQL搜索节点，并可以选择预定义的PQL示例。你可以通过简单地将文件放置在`/etc/puppetlabs/console-services/custom_pql_queries.json`来将自己的PQL示例添加到Web控制台，使用`/etc/puppetlabs/console-services/custom_pql_queries.json.example`作为模板。Web控制台本身默认使用自签名CA证书，可以通过将生成的证书放置在`/etc/puppetlabs/puppet/ssl/certs/console-cert.pem`和`/etc/puppetlabs/puppet/ssl/private_keys/console-cert.pem`来替换为由贵组织CA系统签名的证书。另一个需要考虑的关键文件是许可证密钥，该密钥由Puppet颁发，并放置在`/etc/puppetlabs/license.key`，权限为`644
    root:root`。你可以在Web控制台的**License**选项卡下查看许可证的详细信息。对于这些更改，应该执行一次Puppet代理运行，并重启控制台服务。
- en: Some areas of Puppet Enterprise are not currently definable through native code
    such as RBAC, classification, and LDAP, but there are APIs and Puppet modules
    that take advantage of those APIs, which can allow for storing configuration.
    For classification, there is an API to view the classification and configure node
    groups; this can also be done via the **node_manager** module ([https://forge.puppet.com/modules/WhatsARanjit/node_manager](https://forge.puppet.com/modules/WhatsARanjit/node_manager)),
    which is used by peadm. For RBAC and LDAP, the RBAC API ([https://puppet.com/docs/pe/2021.7/rbac-api.htm](https://puppet.com/docs/pe/2021.7/rbac-api.htm))
    has endpoints that can be used to manage groups, roles, and users. A Puppet module
    has been developed to use these APIs ([https://forge.puppet.com/modules/pltraining/rbac](https://forge.puppet.com/modules/pltraining/rbac))
    and it has an LDAP endpoint that has similarly had a module developed to use the
    APIs ([https://forge.puppet.com/modules/abuxton/puppet_ds).](https://forge.puppet.com/modules/abuxton/puppet_ds).
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise的某些领域当前无法通过原生代码进行定义，如RBAC、分类和LDAP，但有些API和Puppet模块可以利用这些API，从而支持配置存储。对于分类，有一个API可以查看分类并配置节点组；这也可以通过**node_manager**模块实现（[https://forge.puppet.com/modules/WhatsARanjit/node_manager](https://forge.puppet.com/modules/WhatsARanjit/node_manager)），该模块由peadm使用。对于RBAC和LDAP，RBAC
    API（[https://puppet.com/docs/pe/2021.7/rbac-api.htm](https://puppet.com/docs/pe/2021.7/rbac-api.htm)）提供了可用于管理组、角色和用户的端点。已开发了一个Puppet模块来使用这些API（[https://forge.puppet.com/modules/pltraining/rbac](https://forge.puppet.com/modules/pltraining/rbac)），并且它有一个LDAP端点，同样开发了一个模块来使用这些API（[https://forge.puppet.com/modules/abuxton/puppet_ds](https://forge.puppet.com/modules/abuxton/puppet_ds)）。
- en: )
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: )
- en: Having reviewed the architecture and deployment recommendations, we will discuss
    other supporting tools and products to work with Puppet in the following section.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 在审查完架构和部署建议之后，我们将在下一部分讨论与Puppet一起使用的其他支持工具和产品。
- en: Puppet Enterprise-related projects and tooling
  id: totrans-158
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Puppet Enterprise相关项目和工具
- en: 'Puppet Enterprise has several modules and tools developed by Puppet to ease
    the management and support of Puppet infrastructure. The most direct is the built-in
    support script; this command gathers logs and system information and compresses
    it allowing users to send detailed status information to cases with Puppet’s support
    teams. The simple version of the command is shown here: `/opt/puppetlabs/bin/puppet`
    `enterprise support`.'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise拥有由Puppet开发的多个模块和工具，以简化Puppet基础设施的管理和支持。最直接的工具是内置的支持脚本；该命令会收集日志和系统信息并进行压缩，从而允许用户将详细的状态信息发送到Puppet支持团队的案例中。该命令的简单版本如下：`/opt/puppetlabs/bin/puppet`
    `enterprise support`。
- en: Various options can be found in the documentation at [https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script](https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script)
    that allow for selecting services to be collected, to directly **Secure File Transfer
    Protocol** (**SFTP**) upload the archive as part of the command, and to encrypt
    the archive, assuming **GNU Privacy Guard** (**GPG**) keys are available.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 详细的选项可以在文档中找到：[https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script](https://puppet.com/docs/pe/2021.7/getting_support_for_pe.html#pe_support_script)，这些选项允许选择要收集的服务，将归档文件作为命令的一部分直接**安全文件传输协议**(**SFTP**)上传，并在有**GNU隐私保护**(**GPG**)密钥的情况下加密归档文件。
- en: Note
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: It is possible to use **SOScleaner** to remove hostnames and IP addresses from
    the support script contents. Visit [https://support.puppet.com/hc/en-us/articles/115003312887](https://support.puppet.com/hc/en-us/articles/115003312887)
    for details on how to install and run it.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用**SOScleaner**从支持脚本内容中删除主机名和IP地址。有关如何安装和运行它的详细信息，请访问 [https://support.puppet.com/hc/en-us/articles/115003312887](https://support.puppet.com/hc/en-us/articles/115003312887)。
- en: Having seen how to deploy Puppet infrastructure, it is important for you to
    understand how to monitor and troubleshoot any issues found, so let’s look at
    that next.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 在了解了如何部署Puppet基础设施之后，了解如何监控和排除发现的任何问题也很重要，因此我们接下来将讨论这个内容。
- en: Monitoring and troubleshooting Puppet Enterprise infrastructure
  id: totrans-164
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监控和故障排除Puppet Enterprise基础设施
- en: The **Puppet Enterprise status_check module** ([https://forge.puppet.com/modules/puppetlabs/pe_status_check](https://forge.puppet.com/modules/puppetlabs/pe_status_check))
    performs checks on both Puppet infrastructure servers and Puppet agents based
    on commonly found issues in support cases, such as confirming services are running,
    disk space is free, and certificates are not expiring. These checks can be run
    as tasks, Puppet code that will notify issues into reports, or as facts—the Splunk
    plugin shown in [*Chapter 13*](B18492_13.xhtml#_idTextAnchor321)has a dashboard
    for displaying the fact output. Using these checks means if you do experience
    any issues when you raise your support case with Puppet, you can reference the
    check number.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: '**Puppet Enterprise 状态检查模块** ([https://forge.puppet.com/modules/puppetlabs/pe_status_check](https://forge.puppet.com/modules/puppetlabs/pe_status_check))
    会根据支持案例中常见的问题，检查 Puppet 基础设施服务器和 Puppet 代理的状态，例如确认服务是否正在运行、磁盘空间是否充足以及证书是否即将过期。这些检查可以作为任务运行，Puppet
    代码会将问题通知到报告中，或者作为事实——在 [*第13章*](B18492_13.xhtml#_idTextAnchor321) 中显示的 Splunk
    插件有一个仪表板用于显示事实输出。使用这些检查意味着如果您在向 Puppet 提交支持案例时遇到问题，您可以引用检查编号。'
- en: The **support_tasks module** ([https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks](https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks))
    provides tasks that perform actions set out in knowledge base articles such as
    regenerating certificates, running the support script, and printing Puppet database
    table sizes.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: '**support_tasks 模块** ([https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks](https://forge.puppet.com/modules/puppetlabs/support_tasks/tasks))
    提供了执行知识库文章中列出的操作的任务，例如重新生成证书、运行支持脚本和打印 Puppet 数据库表大小。'
- en: Some extra console views can be configured to be visible and usable in the console;
    value reporting simply needs values entered in the **Value report** tab for how
    much time is to be reclaimed by using tasks, plans, corrective changes, and intentional
    changes, and it will also generate statistics.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 可以配置一些额外的控制台视图，使其在控制台中可见并可用；值报告只需在 **值报告** 标签页中输入使用任务、计划、纠正性更改和有意更改时可以回收的时间，系统还会生成统计数据。
- en: Puppet Enterprise can gather additional information about packages including
    unmanaged packages; this information is made visible in the `puppet_enterprise::profile::agent`
    class to a node group covering nodes you wish to collect from and by setting the
    `package_inventory_enabled` parameter to `true`.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: Puppet Enterprise 可以收集有关软件包的更多信息，包括未管理的软件包；这些信息会在 `puppet_enterprise::profile::agent`
    类中显示，供您希望从中收集信息的节点组使用，并通过将 `package_inventory_enabled` 参数设置为 `true` 来启用此功能。
- en: The final extra that can be enabled allows the monitoring and management of
    patching. In the `pe_patch` class.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 最终可以启用的额外功能是补丁管理和监控，在 `pe_patch` 类中进行。
- en: In addition to the core Puppet Enterprise infrastructure, there are additional
    Puppet products allowing management of pipelines for code deployment onto Puppet
    Enterprise and for compliance scans to be run on Puppet nodes.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 除了核心的 Puppet Enterprise 基础设施，还有其他 Puppet 产品可以管理代码部署管道，将代码部署到 Puppet Enterprise
    并在 Puppet 节点上执行合规扫描。
- en: Managing deployments and ensuring compliance
  id: totrans-171
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 管理部署并确保合规性
- en: There are two additional Puppet products to consider using with Puppet Enterprise,
    `v4` catalog API to compile a new catalog with the new code and compare it with
    the current code’s catalog, displaying the difference to ensure the impact is
    as the developer expected. These pipelines can be made in the web console for
    CD4PE or created as code in YAML files inserted into modules and control repos
    to be deployed.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 有两个额外的 Puppet 产品可以与 Puppet Enterprise 一起使用，`v4` 目录 API 用于编译新代码的目录，并将其与当前代码的目录进行比较，显示差异，以确保影响符合开发人员预期。这些管道可以在
    CD4PE 的 Web 控制台中创建，也可以作为代码通过 YAML 文件插入到模块和控制库中进行部署。
- en: '**Puppet Comply** is a compliance tool based on the **Centre for Internet Security**
    (**CIS**) benchmarks. It builds automation around the Java scanner developed by
    CIS, CIS-CAT Pro accessor ([https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro](https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro)).
    This allows hosts to be accessed against the CIS benchmarks, using orchestrator
    in Puppet Enterprise to automate and schedule runs of the scanner via tasks and
    producing dashboards of their compliance in a separate Puppet Comply console.
    An example of the home screen of Comply is shown in the following screenshot:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: '**Puppet Comply** 是一个基于**互联网安全中心**（**CIS**）基准的合规性工具。它围绕 CIS 开发的 Java 扫描器、CIS-CAT
    Pro 访问器（[https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro](https://www.cisecurity.org/cybersecurity-tools/cis-cat-pro)）构建自动化。这使得可以通过
    Puppet Enterprise 中的调度器自动访问主机，并通过任务自动化和安排扫描器运行，从而生成其合规性的仪表板，并在单独的 Puppet Comply
    控制台中查看。以下截图展示了 Comply 的主页屏幕：'
- en: '![Figure 14.7 – Puppet Comply home dashboard](img/B18492_14_07.jpg)'
  id: totrans-174
  prefs: []
  type: TYPE_IMG
  zh: '![图 14.7 – Puppet Comply 首页仪表板](img/B18492_14_07.jpg)'
- en: Figure 14.7 – Puppet Comply home dashboard
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 图 14.7 – Puppet Comply 首页仪表板
- en: It can be seen from the dashboard how many of the nodes are achieving compliance,
    how many nodes have a compliance profile set, and a list of node results listing
    which profile is assigned and compliance scores in a particular scan.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 从仪表板可以看到有多少节点已达到合规性，多少节点设置了合规性配置文件，以及节点结果的列表，列出了在特定扫描中分配的配置文件和合规性得分。
- en: It also comes with the premium `cem_linux` ([https://forge.puppet.com/modules/puppetlabs/cem_linux](https://forge.puppet.com/modules/puppetlabs/cem_linux))
    and `cem_windows` ([https://forge.puppet.com/modules/puppetlabs/cem_windows](https://forge.puppet.com/modules/puppetlabs/cem_windows))
    to speed up your adoption of Puppet, allowing base security configuration to be
    taken based on CIS benchmarks via pre-made Puppet modules. These modules are maintained
    and supported by Puppet, ensuring the enforcement code is up to date with the
    latest CIS benchmarks.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 它还提供了高级版的`cem_linux`（[https://forge.puppet.com/modules/puppetlabs/cem_linux](https://forge.puppet.com/modules/puppetlabs/cem_linux)）和`cem_windows`（[https://forge.puppet.com/modules/puppetlabs/cem_windows](https://forge.puppet.com/modules/puppetlabs/cem_windows)），以加快
    Puppet 的采用，允许基于 CIS 基准通过预制的 Puppet 模块进行基础安全配置。这些模块由 Puppet 维护和支持，确保执行代码与最新的 CIS
    基准保持一致。
- en: Both products run in the framework known as **Puppet Application Manager** (**PAM**),
    a Kubernetes-based tool for managing Puppet applications.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 这两个产品运行在被称为**Puppet 应用管理器**（**PAM**）的框架中，这是一个基于 Kubernetes 的工具，用于管理 Puppet 应用程序。
- en: Lab – Puppet Enterprise extensions and configuration
  id: totrans-179
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 实验室 – Puppet Enterprise 扩展和配置
- en: 'Executing the bolt command in the *technical requirements* section deploys
    a large deployment of Puppet Enterprise 2021.5\. With this infrstructure setup,
    we will try various extensions and configurations we have discussed, as follows:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 在*技术要求*部分执行 bolt 命令，将部署一个大型的 Puppet Enterprise 2021.5。通过这个基础设施设置，我们将尝试进行我们已讨论的各种扩展和配置，具体如下：
- en: Examine the code in peadm and the node groups that set up the A and B groups.
    Note [https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md](https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md)
    provides an explanation of the groups.
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 检查 peadm 中的代码和设置 A 和 B 组的节点组。请注意，[https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md](https://github.com/puppetlabs/puppetlabs-peadm/blob/main/documentation/classification.md)
    提供了组的解释。
- en: Create a personal user with permission to view the console and create node groups
    and view the activity log of the administrator user (try to log in without the
    view console permissions).
  id: totrans-182
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个个人用户，授予其查看控制台、创建节点组以及查看管理员用户活动日志的权限（尝试在没有查看控制台权限的情况下登录）。
- en: Enable package management on the web console for all nodes, log in as your personal
    user, and view the activity log of this.
  id: totrans-183
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启用所有节点在 Web 控制台上的包管理功能，作为个人用户登录，并查看此操作的活动日志。
- en: Enable patch management for the nodes by applying code using the `node_manager`
    module.
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过使用`node_manager`模块应用代码，为节点启用补丁管理。
- en: Customize the login message.
  id: totrans-185
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 自定义登录信息。
- en: 'Perform an upgrade to 2021.6 using the peadm upgrade plan. *Note*: Since pecdm
    includes peadm, this can be performed from your development environment.'
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 peadm 升级计划执行升级至 2021.6版本。*注意*：由于 pecdm 包含 peadm，因此可以从开发环境中执行此操作。
- en: Sample solutions are provided at [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14).
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 示例解决方案可在 [https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14](https://github.com/PacktPublishing/Puppet-8-for-DevOps-Engineers/tree/main/ch14)
    获取。
- en: Summary
  id: totrans-188
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter has reviewed how Puppet Enterprise builds on top of the open source
    tooling, providing the services necessary to secure and automate the deployment
    of Puppet. It was discussed how Puppet Enterprise bundled the open source packages
    into consistent versions, with support offerings and services from Puppet architecture
    and services teams.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 本章回顾了 Puppet Enterprise 如何在开源工具的基础上构建，提供了确保安全和自动化部署 Puppet 所需的服务。讨论了 Puppet
    Enterprise 如何将开源软件包打包成一致的版本，并通过 Puppet 架构和服务团队提供支持服务。
- en: We also discussed the additional services of Puppet Enterprise that secure user
    and API access via RBAC, giving a web frontend and additional APIs in the console
    services the ability to deploy code from Code Manager.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还讨论了 Puppet Enterprise 的附加服务，通过 RBAC 安全地保护用户和 API 访问，提供了 Web 前端和附加 API，在控制台服务中可以通过
    Code Manager 部署代码。
- en: Puppet orchestrator was then seen, to show how tasks and plans could be run
    in Puppet Enterprise with the orchestrator service running tasks and plans via
    PCP using PXP brokers to direct communication from PXP agents on nodes. The agentless
    clients could be added to the inventory service storing their transport details,
    and tasks or plans to run on them would ego via the Bolt server for nodes connected
    by WinRM or SSH, while other transports’ particular network devices such as switches
    or firewalls used the ACE server. We saw how orchestrator would store all the
    job details updating the activity service. RBAC access was discussed, showing
    how you could only limit which plans were available to a user but could set tasks
    to particular users and particular groups of nodes using target sets. Performance
    and capacity aspects of orchestrator were discussed, as well as how to run tasks
    or plans via the web console GUI or the CLI interface.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 然后介绍了 Puppet Orchestrator，展示了如何在 Puppet Enterprise 中通过 Orchestrator 服务运行任务和计划，使用
    PCP 通过 PXP 中介传输 PXP 代理与节点之间的通信。无代理客户端可以被添加到库存服务中，存储它们的传输详情，任务或计划将在 Bolt 服务器上运行，适用于通过
    WinRM 或 SSH 连接的节点，而其他网络设备（如交换机或防火墙）则使用 ACE 服务器。我们看到 Orchestrator 如何存储所有作业的细节，并更新活动服务。讨论了
    RBAC 访问控制，展示了如何限制哪些计划可供用户使用，同时可以将任务分配给特定用户和特定节点组，使用目标集。还讨论了 Orchestrator 的性能和容量方面的问题，以及如何通过
    Web 控制台 GUI 或 CLI 接口运行任务或计划。
- en: The supported architectures customers could take off the shelf to implement
    Puppet at scale and regional requirements for their estate were reviewed, showing
    the modules and scripts that wrap up to automatically deploy these architectures,
    the pecdm module deploying infrastructure in the public cloud, peadm automating
    the various steps of install and maintenance, and using the installer script.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 回顾了客户可以立即使用的支持架构，以便大规模实现 Puppet 以及满足其区域需求，展示了这些架构的模块和脚本，这些模块和脚本封装起来可以自动部署这些架构，pecdm
    模块用于在公共云中部署基础设施，peadm 用于自动化安装和维护的各个步骤，并使用安装脚本。
- en: Extras services that could be enabled in the web console to help report on the
    value Puppet delivers, patch management, and packaging reporting were reviewed,
    along with customizations and methods to automate configuration within the console
    covering customization of the console message, the certificate used on the web
    console, and the license key. Several modules were then discussed that could assist
    in reporting the status of the infrastructure and running standard tasks in the
    `support_task` and `status_check` modules.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 介绍了可以在 Web 控制台中启用的附加服务，帮助报告 Puppet 提供的价值、补丁管理和打包报告，以及定制化和自动化配置控制台的方法，包括控制台消息的定制、Web
    控制台上使用的证书和许可证密钥。随后讨论了几个模块，它们可以帮助报告基础设施状态，并在 `support_task` 和 `status_check` 模块中运行标准任务。
- en: 'Two further Puppet products that integrate with Puppet Enterprise were then
    discussed: CD4PE, which provides a pipeline to assist in automating the deployment
    of code, and Puppet Comply, which gives pre-written modules and dashboards to
    allow for reporting on CIS benchmarks.'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 随后讨论了两个与 Puppet Enterprise 集成的 Puppet 产品：CD4PE，它提供了一个管道帮助自动化部署代码，以及 Puppet Comply，它提供了预写的模块和仪表板，用于报告
    CIS 基准。
- en: While all of the architecture, tooling, packaging, and general automation could
    be achieved with Open Source Puppet, it would require development and support
    work from your own teams. So, Puppet Enterprise should be seen as a decision about
    the skills and people available in your team, tooling already invested in the
    organization and money available for tooling, and where your organization wants
    to focus its work.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然所有的架构、工具、打包和一般自动化都可以通过开源 Puppet 实现，但这需要依靠你们团队的开发和支持工作。因此，Puppet Enterprise
    应该被视为一个关于团队可用技能、组织已经投资的工具以及可用于工具的资金的决策，同时也考虑到你们组织希望集中精力在哪些工作上的问题。
- en: Now, having fully reviewed the language, the platform, and how Puppet Enterprise
    can provide preconfigured infrastructure to reduce the operational burden and
    design required, in the final chapter, we will discuss approaches to adopting
    and using Puppet, focusing on getting the best use in your organization, since
    understanding the technology is only part of the battle while understanding how
    to integrate with people and processes is often the greater challenge.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，在全面审查了语言、平台以及 Puppet Enterprise 如何提供预配置的基础设施以减少操作负担和设计要求后，在最后一章中，我们将讨论采用和使用
    Puppet 的方法，重点是如何在你的组织中获得最佳应用，因为理解技术只是战斗的一部分，而理解如何与人和流程整合通常是更大的挑战。
