

# 在 DevOps 计划阶段实施安全性

DevOps 的 **计划** 阶段侧重于从关键利益相关者和客户那里收集需求和反馈，制定优先考虑关键需求的不断演进的产品路线图，并设计灵活的软件架构。 在这一阶段实施 DevSecOps 应该关注能够在开发人员开始编写代码之前解决的安全挑战！ 此阶段的活动应包括实施敏捷的威胁建模过程，以更早地识别设计级别的安全问题，并为您的团队实施安全培训。

在本章中，我们将介绍在实施持续威胁建模过程时的有效方法。 我们还将讨论安全代码到云培训计划的不同成熟度级别。 通过本章的学习，您将对以下关键领域有了扎实的理解： 重点领域：

+   DevSecOps 中传统威胁建模的挑战

+   如何在 DevSecOps 工作流程中实施敏捷的威胁建模过程

+   如何使用 Microsoft Threat Modeling Tool 实施威胁建模

+   持续安全代码到云培训的成熟级别

这些主题将为您提供重要的知识和策略，帮助您从 DevOps 生命周期的最开始阶段就优先考虑安全。 让我们 开始吧！

# 技术要求

要按照本章的说明操作，您需要 以下内容：

+   一台带有 互联网连接的 PC

+   一个活跃的 Azure 订阅

# 了解 DevSecOps 在计划阶段的应用

预防胜于治疗

我们生活在一个 世界中，许多组织 看重他们的软件甚于他们的物理基础设施。 亚马逊、Netflix、Airbnb 和 Uber 等行业巨头通过创新的软件平台改变了他们的行业，改变了我们阅读、观看电影、旅行和通勤的方式。 对于这些组织和大多数现代公司来说，他们的关键运营不依赖于他们拥有的物理建筑，而是依赖于他们开发的软件，用于向用户提供服务。 。

尽管软件系统在许多组织中扮演着至关重要的角色，但很多组织在规划时只关注功能性和稳定性。 安全性往往成为一个次要问题，通常是在开发工作开始后很久才考虑到。 正如我们在 *第二章*中讨论的那样，这种做法在 DevOps 工作流中并不适用。 这种将安全性考虑推迟的做法，部分原因是开发和运维团队缺乏有效评估和优先排序风险的专业知识，进而无法在早期阶段规划风险缓解措施。

这时，DevSecOps 发挥了作用。 它鼓励开发、运维和安全团队从一开始就进行持续的合作——在规划阶段。 目标是将安全性作为所有软件设计的核心原则！ DevSecOps 提倡在所有参与创建和运行软件的团队中培养一种 *安全设计* 的思维方式。 为了实现这些目标，组织可以实施几种方法。 其中两个常见的方法是威胁建模和持续的 安全培训。

# 理解威胁建模及其好处

威胁是一个可能的事件 ，它可能利用应用程序设计或系统架构中的弱点，从而导致不良后果。 任何与应用程序交互的人，无论是组织内部还是外部，都可能成为这种事件的来源。 随着技术的发展，威胁的数量不断增加。 为了防止威胁利用系统漏洞，威胁建模方法可以在设计阶段应用，以指导 防御措施。

威胁建模 是一种结构化的方法，用于识别软件和系统设计中的潜在威胁和漏洞。 一旦发现这些威胁，我们可以根据其概率进行优先排序，并制定缓解计划，采取措施阻止或减少这些威胁的影响。

虽然威胁建模 可以在任何阶段进行，但最好在规划阶段进行，即在编写代码之前，在决定软件架构时进行。 这样，潜在的安全问题可以及早识别和解决，从而减少后期需要进行更加昂贵修复的情况。 在规划阶段实施威胁建模，还有助于培养预防文化，并促进主动的架构决策，从而最小化威胁的数量和影响。 就像土木工程师和汽车工程师在建造建筑物或汽车之前会规划安全功能一样，威胁建模确保我们从一开始就考虑到安全问题 在软件开发过程中。

一旦我们有了威胁模型，我们可以在软件演变的任何时候进行更新和改进。 这种方法很好，因为它可以帮助我们跟踪软件和系统的变化 如何影响威胁模型。

## 传统的威胁建模框架

威胁建模不是一个新概念 在软件设计领域。 早在 1990 年代，安全专家就开始关注如何识别和减轻软件系统中的威胁。 威胁建模的概念在 2004 年随着 Frank Swiderski 和 Window Snyder 出版的《 *威胁建模*》一书而引起了广泛关注。 这本书介绍了威胁建模的概念，并提供了如何将其纳入软件开发 生命周期的指导。

多年来，威胁建模不断发展和成熟，已经有多个方法论和框架 被开发出来 以协助这一过程。 一些 著名的威胁建模方法包括微软的 **欺骗、篡改、否认、信息泄露、拒绝服务、权限提升** (**STRIDE**) 模型， **操作关键威胁、资产和漏洞评估** (**OCTAVE**) 框架，以及 **攻击模拟和威胁分析过程** (**PASTA**) 框架。

没有一种通用的威胁建模方法；组织通常根据其项目的特定需求选择方法。 每个框架都提供了独特的视角和关注点。 有些方法侧重于以人为中心的考虑，而其他方法则侧重于风险识别（以风险为中心）或隐私缓解（以隐私为中心）。 有时，结合这些方法可以提供更全面和平衡的潜在威胁理解。 让我们来回顾一些更为 常见的框架。

12 种威胁建模方法

卡内基梅隆大学软件工程研究所的资深成员纳塔莉亚·谢甫琴科（Nataliya Shevchenko）撰写了一篇关于 12 种威胁建模方法的有趣文章。 这是一篇有趣的 文章，您可以在以下网址阅读： [https://insights.sei.cmu.edu/blog/threat-modeling-12-available-methods/](https://insights.sei.cmu.edu/blog/threat-modeling-12-available-methods/)。您还可以访问 更详细的白皮书： [https://resources.sei.cmu.edu/asset_files/WhitePaper/2018_019_001_524597.pdf](https://resources.sei.cmu.edu/asset_files/WhitePaper/2018_019_001_524597.pdf)。

我们的目标不是涵盖 传统的威胁建模方法论——对于这个，我们建议参考一本全面的书籍，如 *《威胁建模：设计安全》*，作者是 *亚当·肖斯塔克* ——我们的主要关注点是从 DevSecOps 的角度进行威胁建模。 不过，在本章后面，我们将使用微软威胁建模工具，该工具使用 STRIDE 框架进行 分析。

## DevSecOps 中的威胁建模

传统的威胁 建模框架 例如 STRIDE、PASTA 和 DREAD，在整合到 DevOps 工作流程时，由于其高强度的性质，可能会带来挑战。 它们 *速度较慢*， *需要较高技能* (需要高水平的专业知识)，并且 *时间消耗大* (需要相当的时间投入)。 花费数天甚至数周时间构建 复杂的威胁模型，使用 **数据流图** (**DFD**)和信息入口点，分类数据，识别相关威胁，及记录 缓解控制措施的过程并不少见。

然而，在一个软件更新频繁（每日或每周）或定期引入新微服务的动态 DevOps 环境中，传统的威胁模型可能并不是最有效的。 我们最终陷入了一种情况：在试图将安全集成到设计阶段的开始时，我们引入了一个早期瓶颈！ 组织内的许多团队已经认为安全会拖慢他们的流程，这只是进一步验证了这种看法。 现实情况是，为每个微服务或软件更新创建一个全面的威胁模型根本 不切实际！

鉴于 DevOps 工作流的快速节奏，需要将威胁建模转化为一种轻量级、快速且增量化的过程。 这并不是一个新想法，但在我们的实践中，我们看到越来越多的组织开始采用现代敏捷威胁建模方法，这些方法优先考虑灵活性和效率。 这些方法将威胁建模过程分解为更小、更易于管理的 模块，这些模块可以持续进行。 Mozilla 的 **快速风险评估** （**RRA**）和 Slack 的 **goSDL** 模型提供了很好的资源 ，以促进一种更轻量级的威胁建模和风险评估方法。 这些框架专注于快速评估软件设计和变更中的数据风险。 它们被设计 为快速进行评估，通常评估在 30 到 60 分钟内完成。

## 理解 Mozilla 的 RRA 过程

Mozilla 的 RRA 提供了一个 30 分钟的风险评估问卷，您可以在 [https://docs.google.com/document/d/1uD-wofmkXBz5BVq49JQQqC3DnE77vwOPDSbHdWIve9s/edit](https://docs.google.com/document/d/1uD-wofmkXBz5BVq49JQQqC3DnE77vwOPDSbHdWIve9s/edit)找到它。当团队引入新服务时，他们可以与安全团队合作，利用这个问卷评估服务的威胁场景和风险等级。 RRA 模型有四个不同的阶段，如 *图 3**.1*所示：

![Figure 3.1 – Mozilla RRA 的四个阶段](img/B19710_03_1.jpg)

Figure 3.1 – Mozilla RRA 的四个阶段

我们将在本节中涵盖这些阶段。 然而，初步步骤是清晰地定义请求 RRA 会话的流程。 让我们从这一点开始！

### 定义 RRA 请求流程

为了在组织内引入 RRA ，需要有一个简单且沟通良好的流程，供产品和工程团队遵循。 他们应该能够轻松地请求 RRA，用于新的服务或后续的软件设计更改（例如收集新数据或处理）。 这可以是一个简单的请求表格，方便开发人员在组织中常用的规划工具中访问，无论是 JIRA、Confluence、Azure Boards 还是 GitHub 项目。 与此表格一起，应该有一个最新的可用性日历，用于预订 RRA 会议。 此外，还应该有一份简短的清单，列出参加会议时需要提供的详细信息，包括服务信息、软件架构图、数据流图以及服务 地图图。

当然，这个过程不应当孤立定义。 协作是至关重要的。 通过让来自工程和安全团队的领导者与成员参与其中，我们可以确保相关视角被考虑在内。 他们的集体洞察力、专业知识和反馈可以确保确定的流程与现有团队的实践相一致，并且能够被良好地接受。 *最终目标是简化团队的 RRA 请求流程*。这也可以嵌入到标准的组织程序中，用于在 Azure DevOps 或 GitHub 组织内请求新项目或代码库。

一个好的起点是组建一个专门的安全开发生命周期团队，致力于评估和改善生命周期的现状。 从战略上看，这强制要求相关利益相关者在场，并从一开始就将安全性融入流程中。 这个团队可以由来自不同团队的成员组成 ，包括 DevSecOps 负责人， **安全运营** (**SOC**)、云卓越中心、开发人员（由于该团队所做的所有决策都会影响开发人员，因此他们应当拥有发声权）、安全冠军、基础设施架构师以及管理层。 这将需要高层管理的支持 和赞助。

重要的是要认识到 采用敏捷威胁建模技术（例如 RRA）并不否定传统威胁建模方法的价值。 平衡的策略应该是为工程团队提供选择的灵活性。 他们可以选择在处理重要软件项目时采用全面的威胁模型，例如即将推出的旗舰产品，或者在处理较小规模任务时选择 RRA，例如构建微服务或修改软件设计，如 *图 3**.2*所示：

![图 3.2 – 请求威胁建模会议的示例流程](img/B19710_03_2.jpg)

图 3.2 – 请求威胁建模会议的示例流程

注意

明确定义什么算作 *重要软件项目* 对于避免混淆是有益的。 虽然这个定义可能会随着安全团队对组织的软件交付流程的熟悉而发展，但总是从一个具体的指导原则开始会更好。 从清晰开始，并在必要时进行调整，比在 指导方针中含糊其辞更为有效。

现在，让我们回顾一下 RRA 阶段。

### 阶段 1 – 信息收集（5 分钟）

本阶段的目标 是对服务有一个高层次的理解。 此时不需要深入到服务的实现细节；这些细节可以稍后再处理。 在这一阶段，安全团队应该花更多时间倾听和学习，而不是发言。 重点应该放在提出有意义的问题上，以理解产品/工程团队的设计、观点和计划。 团队应该积极参与讨论，做好记录，并收集所有相关的 文档链接。

重要的是确保创建一个舒适开放的环境，使产品/工程团队能够安全地分享有关服务和其工作设计的信息，而不必担心被评判。 以下是一些面向背景的问题，可以帮助更好地理解 这项服务：

+   **服务的** **所有权**：

    +   公司内谁负责 这项服务？

    +   将参与此项工作的开发人员是谁 ？

    +   一旦服务上线，谁将负责监督其运营？  

    +   如果发生安全 事件，谁将响应该服务？

+   **服务的** **受众**：

    +   它是为内部使用设计的，还是对公众或指定的合作伙伴 和供应商开放的？

    +   公众用户是否会有直接访问权限？ 他们将访问服务的哪些部分？

    +   内部用户是否会有直接访问权限？ 他们将访问服务的哪些部分？ 他们能访问哪些内容？

    +   合作伙伴/供应商是否会有直接访问权限？ 他们将访问服务的哪些部分？

    +   每个受众将访问服务的哪些部分？ 服务地图和架构图可能有助于快速定义 这一点。

+   **主要的** **用户故事**：

    +   主要的 用户故事是什么？

    +   用户将如何使用 该服务？

+   **该服务将如何** **构建？**:

    +   是否有 设计文档？

    +   是否有 设计图？

    +   它将使用哪些服务来 存储数据？

    +   它将与哪些外部服务 进行通信？

    +   它将如何与外部服务 进行通信？ 是通过直接的 API 调用吗？ 还是通过消息队列？

现在，让我们看看 第二阶段。

### 第二阶段 – 构建数据字典（5-10 分钟）

这一阶段的重点是检查 该服务将处理的数据。 此阶段的目标是了解该服务将收集、处理或访问的数据。 需要考虑的一些问题包括将收集或访问什么样的数据？以及这些数据将存储在哪里？ 随着细节的展开，安全团队必须记录这些信息，并按其各自的 *分类级别*进行标注。

谈到数据分类级别时，这需要在公司层面进行定义（而不是每个项目）。 它还需要由高层管理、安保、合规以及 法律团队确定并批准。

备注

有关定义全组织数据分类级别的建议和最佳实践，请参考 此 文档： [https://learn.microsoft.com/en-us/compliance/assurance/assurance-create-data-classification-framework](https://learn.microsoft.com/en-us/compliance/assurance/assurance-create-data-classification-framework)。

如 *图 3**.3*所示，组织已经定义了四个级别的数据分类：

![图 3.3 – 示例组织级别的数据分类](img/B19710_03_3.jpg)

图 3.3 – 示例组织级别的数据分类

示例数据字典 如 *图 3**.4* 所示，提供了与在线购物平台 **eShopOnWeb**相关的四种数据类型的概述，以及它们的敏感性或分类级别。 这有助于做出有关数据处理、存储和安全的明智决策。 请注意，这仅仅是一个示例。 你定义数据字典的方法可能有所不同， 这也没问题。

![图 3.4 – 示例数据字典](img/B19710_03_4.jpg)

图 3.4 – 示例数据字典

接下来，我们将关注 第 3 阶段。

### 阶段 3 – 识别威胁场景（5-10 分钟）

此阶段的目的是识别 潜在问题，并通过赋予风险评级对其进行排序。 Mozilla RRA 过程使用 CIA 模型，侧重于机密性、完整性 和可用性：

+   **机密性**：如果数据字典中突出显示的数据分类边界被破坏，会发生什么情况？

+   **完整性**：如果数据未经授权访问和修改 会发生什么情况？

+   **可用性**：如果数据被删除、恶意加密，或者服务 被压垮，会发生什么情况？

对于这些领域，我们应记录四个要素：威胁向量、影响、可能性和风险评级。 让我们来看看 它们：

+   **威胁向量**：这些描述了攻击者可能如何危害领域（机密性、完整性和可用性）的方式。 在考虑威胁时，应该想到最严重但现实的情况，而不是极不可能发生的事件。 例如，我们不会担心 Azure 云中所有服务器同时崩溃，因为这是一个高度不可能的场景。

+   **影响**：这是评估威胁发生时可能对组织造成的潜在影响。 理想情况下，影响级别应在组织层面进行定义，并涉及相关利益相关者（业务高管、法律团队、合规团队和产品负责人）。 该定义应在 RRA 会议之前提前完成。 确保涉及正确的人员至关重要，因为安全工程师可能倾向于低估企业的风险承受能力。 为了更加谨慎，安全工程师有时会将低影响的威胁评定为高风险甚至是关键威胁。 这可能会稀释真正关键问题的重要性，导致所有问题看起来都很重要，从而降低每个问题的紧迫性。 至少，业务高管应审核并批准影响级别。

    在确定影响级别时，应该考虑多个因素：对业务收入的影响；对服务用户的影响；对组织公众声誉的影响；以及可能的法律影响。 但是，请记住，并非每个因素都适用于你所遇到的每个威胁场景。 例如，要确定对业务收入的影响，可以先查看过去的收入。

    例如，要确定对业务收入的影响，可以从查看过去的收入开始。 将任何可能影响 20% 收入的威胁评为 *关键*。根据业务代表的反馈，这一基准可以进一步细化。 在考虑对用户的影响时，预计用户数量可以是一个有用的指标。 *图 3**.5* 提供了一个组织影响评级示例，详细说明了每个级别的条件：

![图 3.5 – 组织级别影响示例](img/B19710_03_5.jpg)

图 3.5 – 组织级别影响示例

+   **可能性**：这评估威胁发生所需的努力。 这可能很难评估。 在存在设计缺陷的情况下，如何评估或预测它是否会被利用呢？ 此外，威胁可能性的动态变化不断。 今天，*难以利用* 的缺陷可能会变成明天的 *易于利用* 的缺陷，因为攻击者 的能力在不断提高。

    有些威胁的可能性较低或非常低，因为它们需要付出巨大的努力才能实现。 这些类型的威胁只能由高度激励的对手，且拥有大量资源的对手（如国家级对手）实现。 这排除了机会主义对手，并减少了它们发生的机会。

+   **风险评级**：这涉及通过结合威胁的影响和可能性来量化风险。 风险评级有助于优先处理威胁，以便可以有效地分配资源来管理和缓解最高评级的风险。 具有最高影响和最高可能性的威胁应获得最高的风险评级： *关键*。只有少数威胁向量应属于 此类别。

    *风险评级 =* *I**影响 ** *L**可能性*

![图 3.6 – 风险评级等级示例](img/B19710_03_6.jpg)

图 3.6 – 风险评级等级示例

*图 3**.7* 显示了这一阶段输出的一个示例。 在这个示例中，识别出了三种威胁情景（每个安全领域各一个）。 第一个威胁的风险评级为中等，因为暴露 **UserAddress** 信息被业务认为是低影响，且发生的可能性高。 第二个威胁的风险评级为严重，因为通过更改我们提供的文件来感染其他用户可能会违反合规性（严重影响）、影响我们大部分用户（严重影响），并造成持续的声誉损害（严重影响）。 此外，发生这种情况的可能性很高，因为我们经常看到这种情况发生在 数据泄露中。

![图 3.7 – 风险评级示例文档](img/B19710_03_7.jpg)

图 3.7 – 风险评级示例文档

现在，让我们来看一下 第 4 阶段。

### 阶段 4 – 提出安全建议（5 分钟）

本阶段旨在提出解决已识别威胁场景的策略。 建议优先处理来自 上一阶段的最高风险。

*图 3**.8* 显示了这一阶段的输出示例：

![图 3.8 – 示例风险建议文档](img/B19710_03_8.jpg)

图 3.8 – 示例风险建议文档

记住，每个组织天生都会承担一定的风险。 企业并非通过完全避免风险来获取利润。 安全的角色不是阻止组织承担风险，而是识别、评估并提供关于这些风险的见解。 这里的主要角色是教育相关方（产品所有者、开发人员、经理）了解服务设计中存在的风险、潜在的后果和可能的缓解措施。 这确保了企业能够做出充分知情的决策。 虽然安全团队有时可能会感到需要将某些风险级别宣称为不可接受，但这种做法未必总是合理的，尤其是在企业通过抢占市场先机从而获益的场景中。 与其做出决策，目标是启发他人了解 这些风险。

在本节中，我们介绍了规划阶段的威胁建模及其好处。 理论部分已结束，接下来我们将进入一些动手操作，并从 实践的角度学习威胁建模。

# 动手练习 1 – 配置实验室虚拟机

为了跟随本章及本书后续部分的练习，我们将在 Azure 中配置一个实验室 **虚拟机** (**VM**) 进行操作。 我们已经为此目的在本书的 GitHub 仓库中准备了一个 Azure ARM 模板。 该模板将在指定的 Azure 区域部署一个虚拟机和一个堡垒资源，如 *图 3**.9*所示：

![图 3.9 – 通过提供的 ARM 模板部署的资源](img/B19710_03_9.jpg)

图 3.9 – 通过提供的 ARM 模板部署的资源

以下是我们将在 本练习中完成的任务： 该练习的任务：

+   **任务 1 –**在 GitHub 中初始化模板部署；完成参数并将模板部署到 Azure

+   **任务 2 – 使用 Azure Bastion 连接到实验室虚拟机**

让我们开始吧！

## 任务 1 – 初始化模板部署到 Azure

步骤如下：

1.  打开一个网页浏览器，访问[`github.com/PacktPublishing/DevSecOps-for-Azure/tree/main/chapter-3`](https://github.com/PacktPublishing/DevSecOps-for-Azure/tree/main/chapter-3)。

    该链接将打开包含用于部署所需资源的 ARM 模板的 GitHub 仓库。

1.  在打开的 GitHub 仓库中，点击**部署到 Azure**：

![图 3.10 – 启动模板部署](img/B19710_03_10.jpg)

图 3.10 – 启动模板部署

1.  如果提示您进行身份验证，请使用您的管理用户名和密码登录 Azure 门户。

1.  在`DevSecOps-Book-RG` | `azureuser`

1.  **管理员密码**：输入一个复杂的密码。这是为已部署的虚拟机实例设置的密码。 密码必须至少包含八个字符，并且至少包含一个小写字母，一个数字和一个特殊字符。 请记下这个密码，因为在本章和本书的后续练习中需要用到它。

1.  选择**查看 + 创建**：

![图 3.11 – 填写模板参数](img/B19710_03_11.jpg)

图 3.11 – 填写模板参数

1.  验证通过后，点击**创建**。

等待部署完成后再继续进行下一个练习。 部署可能需要最多 20 分钟完成，因此在继续之前 可以去喝杯水或咖啡。

## 任务 2 – 使用 Azure Bastion 连接到实验室虚拟机

这个任务的目的是使用 Bastion 服务建立与实验室虚拟机的连接。 请按照以下步骤操作：

1.  在 Azure 门户的主页上，在搜索框中输入 `DevSecOps-LabVM` 并选择 **DevSecOps-LabVM** 虚拟机，当 它出现时：

![图 3.12 – 选择 DevSecOps-LabVM 虚拟机](img/B19710_03_12.jpg)

图 3.12 – 选择 DevSecOps-LabVM 虚拟机

1.  在 **DevSecOpsLabVM** 窗口中，在 **连接** 部分，点击 **连接**，然后点击 **转到 Bastion**：

![图 3.13 – 选择使用 Bastion 连接虚拟机的选项](img/B19710_03_13.jpg)

图 3.13 – 选择使用 Bastion 连接虚拟机的选项

1.  在 `azureuser`

1.  **身份验证** **类型**： **密码**

1.  **密码**：输入你在 模板部署期间指定的密码 。

1.  **在新浏览器中打开** **标签**：已选择

然后， 点击 **连接**。

如果提示，请启用弹出窗口以确保连接成功。 此外，如果提示，点击允许剪贴板访问 。

![图 3.14 – 配置虚拟机凭证并启动连接](img/B19710_03_14.jpg)

图 3.14 – 配置虚拟机凭证并启动连接

现在你 已经获得 访问实验室虚拟机的权限，让我们对一个 示例应用程序进行威胁建模。

# 动手练习 2 – 对电子商务应用程序进行威胁建模

要完成本次动手操作练习，你需要 先完成本章前面的动手操作练习。 在本次练习中，我们将使用 Microsoft 威胁建模工具进行威胁建模练习，这是 Microsoft 的一个基础 **安全开发生命周期** (**SDL**)。这种方法包括创建一个应用程序架构图，使用该工具识别可能的威胁，并提供如何缓解这些威胁的信息。 在本次及后续的练习中，我们将使用 eShop 电子商务应用程序。 *图 3**.15* 显示了该应用程序的参考架构。 该应用程序有两个不同版本：一个是单体版本 eShopOnWeb（可访问 [https://github.com/dotnet-architecture/eShopOnWeb](https://github.com/dotnet-architecture/eShopOnWeb)），另一个是为容器部署设计的微服务版本 eShopOnContainers（可访问 [https://github.com/dotnet-architecture/eShopOnContainers](https://github.com/dotnet-architecture/eShopOnContainers)）。 这两种版本将在 本书中提及。

![图 3.15 – eShopOnContainers 参考架构](img/B19710_03_15.jpg)

图 3.15 – eShopOnContainers 参考架构

以下是我们将在本次练习中完成的任务： ：

+   **任务 1 –** 下载并安装 Microsoft 威胁建模工具

+   **任务 2 –** 为 eShop 应用程序创建威胁模型图

+   **任务 3 –** 对模型进行威胁分析

让我们开始实际的 威胁建模。

## 任务 1 – 下载并安装 Microsoft 威胁建模工具

1.  在实验室虚拟机上，打开 一个 web 浏览器 并浏览至 [https://aka.ms/threatmodelingtool](https://aka.ms/threatmodelingtool)。这将自动将安装程序下载到 `下载` 文件夹。

1.  打开 `下载` 文件夹并双击 `TMT7` 应用程序：

![图 3.16 – 要安装的 TMT7 应用程序](img/B19710_03_16.jpg)

图 3.16 – 要安装的 TMT7 应用程序

1.  当提示时，点击**安装**以安装 该工具。 如果出现警告要求安装 .NET Framework，请点击 **是** 以安装所需版本：

![图 3.17 – 安装该工具](img/B19710_03_17.jpg)

图 3.17 – 安装该工具

工具安装完成后，转到任务 2。

注意

在本次动手实验中，我们将使用微软威胁建模工具。请注意，还有更新的工具可用，例如 Threats Manager Studio（[`threatsmanager.com`](https://threatsmanager.com)）。

## 任务 2 – 为 eShop 应用程序创建威胁模型图

1.  在实验虚拟机上，点击**开始**按钮，然后点击**微软威胁建模工具**打开它：

![图 3.18 – 打开微软威胁建模工具](img/B19710_03_18.jpg)

图 3.18 – 打开微软威胁建模工具

1.  如果系统提示您接受条款和条件，请点击**我同意**。如果系统提示您参与 客户体验，可以随意取消选中 此选项。

1.  在**微软威胁建模工具**区域的**新模型模板**部分，确保已选择**Azure 威胁模型模板**，然后点击**创建** **模型**：

![图 3.19 – 微软威胁建模工具的登录页面](img/B19710_03_19.jpg)

图 3.19 – 微软威胁建模工具的登录页面

1.  这为创建新模型打开了窗口。 请查看右侧的可用模板。 根据您在创建模型时选择的模板，模板类型会发生变化。 以下是 **Azure 威胁模型模板** 下提供的模板类别： **通用数据流**， **通用数据存储**， **通用外部交互者**， **通用进程**， **通用信任边界**，和 **通用信任线边界**。您可以展开 每个类别：

![图 3.20 – 审查模板类别和模板](img/B19710_03_20.jpg)

图 3.20 – 审查模板类别和模板

如前所述，我们将在练习中使用 eShop 应用程序。 我们希望从规划阶段开始识别威胁并添加缓解措施。 我们将基于已知的数据流，即 DFD ，来创建模型。

1.  使用以下模板 绘制两个信任边界 区域，如 *图 3**.21*所示。您需要将每个模板拖动到 图表板上：

    +   **通用信任边界** | **远程** **用户区域**

    +   **通用信任边界** | **Azure** **信任边界**：

![图 3.21 – 绘制信任边界](img/B19710_03_21.jpg)

图 3.21 – 绘制信任边界

1.  使用以下模板 将 **浏览器** 和 **移动客户端** 模板添加到 图表板：

    +   **通用外部交互者** | **浏览器**

    +   **通用外部交互者** | **移动客户端**：

![图 3.22 – 添加浏览器和移动客户端模板](img/B19710_03_22.jpg)

图 3.22 – 添加浏览器和移动客户端模板

1.  将以下模板添加到 **Azure 信任边界** 部分的 图表板上：

    +   **通用进程** | **Web 应用程序**

    +   **通用进程** | **Web API**

    +   **通用数据存储** | **Azure** **SQL 数据库**

    +   **通用数据存储** | **Azure** **Redis 缓存**:

![图 3.23 – 添加所需的通用过程和通用数据存储模板](img/B19710_03_23.jpg)

图 3.23 – 添加所需的通用过程和通用数据存储模板

1.  你也可以右键点击 每个模板，然后点击 选择 **属性** 来重命名它们并设置其他 可配置属性：

![图 3.24 – 重命名模板（可选）](img/B19710_03_24.jpg)

图 3.24 – 重命名模板（可选）

1.  最后，使用以下模板 定义 连接，如 *图 3**.25*所示：

    +   **通用数据流** | **请求**

    +   **通用数据流** | **响应**

    要创建的连接如下：

    +   浏览器与 电子商店 Web 应用之间的请求/响应连接

    +   电子商店 Web 应用与 Web API 之间的请求/响应连接

    +   移动客户端与 Web API 之间的请求/响应连接

    +   Web API 与 订购微服务之间的请求/响应连接

    +   Web API 与 购物车微服务之间的请求/响应连接

    +   订购微服务与 Azure SQL 数据库之间的请求/响应连接

    +   请求/响应连接 在购物车微服务 和 Azure Redis 缓存之间：

![图 3.25 – 简单的电子商店威胁模型](img/B19710_03_25.jpg)

图 3.25 – 简单的电子商店威胁模型

此时，我们可以继续进行 任务 3。

## 任务 3 – 对模型进行威胁分析

按照以下步骤操作：

1.  要分析模型中的威胁，请导航到 **视图** 顶部，然后选择 **分析视图** 从图标 菜单中选择：

![图 3.26 – 打开分析视图](img/B19710_03_26.jpg)

图 3.26 – 打开分析视图

1.  基于模型的潜在威胁列表将在图表下方显示。 这些 根据 **STRIDE** 模型进行分类。 列表中的每个威胁都被分配了一个严重性等级，同时还添加了可能的缓解信息。 您可以 点击 **导出 CSV** 按钮以导出 该列表：

![图 3.27 – 威胁列表](img/B19710_03_27.jpg)

图 3.27 – 威胁列表

1.  浏览生成的威胁列表及可能的缓解措施。 您可以将每个威胁的状态更新为 **未开始**， **需要调查**， **不适用**， 或 **已缓解**。

1.  一旦浏览完列表，选择 **报告**，然后点击 **创建** **完整报告**：

![图 3.28 – 创建完整报告](img/B19710_03_28.jpg)

图 3.28 – 创建完整报告

1.  当系统提示 关于 **自定义威胁属性**时，保留所有选项并点击 **生成报告**：

![图 3.29 – 生成完整报告](img/B19710_03_29.jpg)

图 3.29 – 生成完整报告

1.  在 `eShopApp`中。 点击 **保存**：

![图 3.30 – 将报告保存到桌面](img/B19710_03_30.jpg)

图 3.30 – 将报告保存到桌面

1.  当系统提示您打开文件时， 点击 **确定**：

![图 3.31 – 打开报告](img/B19710_03_31.jpg)

图 3.31 – 打开报告

1.  查看 报告：

![图 3.32 – 审查生成的报告](img/B19710_03_32.jpg)

图 3.32 – 审查生成的报告

恭喜！ 您已成功 使用 Microsoft 威胁建模工具分析了应用模型中的威胁。 接下来，我们将探索安全培训，这是 DevOps 规划阶段的重要组成部分。

# 实施持续的代码到云安全培训

一个成熟的安全代码到云培训计划应重点解决学员理解上的差距。

在任何关于安全的对话中 都很容易陷入技术细节和工具的讨论中。 然而，正是人类因素和组织文化，而非任何技术缺陷，构成了对组织安全性最为显著的风险。 根据 *2022 年数据泄露成本报告*（由 IBM 发布），21%的数据泄露是由于人为错误造成的。 这些错误是员工或承包商的无意失误，证明即使是最复杂的软件安全程序也可能因简单的人为错误而受到威胁。 例如，开发人员可能会将生产凭证提交到代码中，或者在其 IDE 中安装恶意 扩展。

IBM 2022 年数据泄露成本报告

[https://www.ibm.com/downloads/cas/3R8N1DZJ](https://www.ibm.com/downloads/cas/3R8N1DZJ)。

为了解决 DevSecOps 过程中的这一风险，组织应实施一个具有明确目标和成功衡量标准的持续安全代码到云培训项目。 接受过安全编码培训的软件工程师更不容易引入安全漏洞，更了解支持工具，且倾向于设计优先考虑安全的软件架构。

然而，许多已实施某种形式安全代码培训的组织，并没有取得成功！ 本章的目标不是指导您了解您的培训计划应包括哪些内容（关于这一点有很多文章和文档在讨论）。 相反，我们将重点介绍我们在实践中观察到的风险和挑战，这些通常导致 有限的成功。

根据我（David）在该领域咨询的经验，我观察到，具有较高成熟度的组织，通常会有清晰的预期成果和明确的战略，通常会取得更好的结果。 *图 3**.33* 展示了我在各种组织中观察到的五个成熟度级别： 各个组织：

![图 3.33 – 面向安全代码到云的培训项目的五个成熟度级别](img/B19710_03_33.jpg)

图 3.33 – 面向安全代码到云的培训项目的五个成熟度级别

让我们来看看这五个级别及 它们的特点：

+   **不存在**：这不是一个成熟的阶段 而是一个组织完全缺乏安全的代码到云培训程序的阶段。 这导致在遵守组织政策或安全 最佳实践方面，结果不一致。

+   **聚焦合规**：在这一成熟度水平中，培训主要旨在满足特定的合规或审计要求。 培训课程通常是定期的，通常每年举行一次，主要是为了满足审计基准。 由于没有全面的战略，遵循安全最佳实践和政策可能 会不一致。

+   **聚焦意识**：在这一成熟度水平中，存在初步的战略，并已分配资源，但这些仍然是较为通用的。 培训围绕普遍推荐的做法展开，而非针对 组织特定的做法。

+   **聚焦行为变化**：在这一成熟度水平中，重点放在度量分析上，以识别特定于组织的主要 *代码到云* 风险。 同时，能够有效缓解这些风险的行为也被识别出来。 然后，培训会根据这些行为进行定制。 该级别的成功通过安全事件的实际减少、员工对安全协议的合规性提高以及在 日常操作中一致应用已培训行为来衡量。

+   **聚焦文化变革**：在这一成熟度水平中，组织不仅仅改变了已识别的特定行为，而是重塑了整个过程中，从代码到云的安全态度、认知和信念。 该项目得到了高层领导的坚定支持，并定期向高管更新进展。 项目的成功定期进行审查，至少每年一次，涉及个人和 领导层层面的评估。

总之，迈向成熟的安全代码到云培训程序的道路标志着组织成熟度的不断演进。 重要的是，应该优先考虑人和文化，而非 单纯的技术细节。

# 总结

在本章中，我们探讨了在 DevOps 的计划阶段融入安全性的重要实践，重点介绍了敏捷威胁建模和持续的安全代码到云端训练。 我们突出了在 DevSecOps 环境中传统威胁建模面临的挑战。 为了应对这些挑战，我们概述了如何无缝地整合敏捷威胁建模方法，并以 Mozilla 的 RRA 为例。 最后，我们详细说明了与持续的安全代码到云端训练框架相关的成熟度阶段。 本章为你提供了重要的知识和策略，帮助你从 DevOps 生命周期的计划阶段开始优先考虑安全。 接下来，本章将讨论如何在开发工作流的预提交阶段实施安全控制。 加入我们，继续这段 启发性的旅程！

# 进一步阅读

要了解本章涵盖的主题，请查看以下资源： 以下资源：

+   *威胁建模：设计安全，由* *Adam Shostack*

+   *Mozilla 的快速风险评估* *文档*: [https://infosec.mozilla.org/guidelines/risk/rapid_risk_assessment.html](https://infosec.mozilla.org/guidelines/risk/rapid_risk_assessment.html)

+   *Slack 的 goSDL GitHub* *仓库*: [https://github.com/slackhq/goSDL](https://github.com/slackhq/goSDL)

+   *Microsoft 威胁建模工具功能* *概述*: [https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool-feature-overview?source=recommendations](https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool-feature-overview?source=recommendations)

+   *Microsoft 安全开发* *生命周期*: [https://www.microsoft.com/en-us/securityengineering/sdl](https://www.microsoft.com/en-us/securityengineering/sdl)

+   *以网络安全为中心的业务* *文化*: [https://www.researchgate.net/publication/371399113_The_Role_of_Organizational_Culture_in_Cybersecurity_Building_a_Security-First_Culture](https://www.researchgate.net/publication/371399113_The_Role_of_Organizational_Culture_in_Cybersecurity_Building_a_Security-First_Culture)
