# 1

# Salesforce 变更部署的简史

Salesforce 的交付模式每年发布三次主要版本，自 2000 年首次推出以来，平台经历了显著的发展。从最初作为一个主要的销售工具开始，Salesforce 已发展成一个独立的开发平台。随着这一变化，平台对自定义开发最佳实践的需求应运而生，并且需要高效地交付这些自定义功能。

本章将探讨在 Salesforce 平台上进行变更和交付的历史，以了解内置工具当前的不足之处。这将为理解 DevOps 流程的必要性提供背景，并展示现阶段的技术现状。我们将讨论以下主要内容：

+   自定义 Salesforce 的开端

+   Apex 和 Visualforce

+   沙盒和变更集

+   SFDX 和暂存组织

+   DevOps 中心

与本书的其他章节不同，本章并不一定提供可操作的步骤或最佳实践指南，供您在 Salesforce 实施中应用。然而，成为一名优秀 Salesforce 架构师的基本原则之一就是理解我们决策背后的 *原因*。通过回顾 Salesforce 作为开发平台的发展历史，以及它如何不断朝着现代软件开发方法和工具迈进，我们能更好地理解在 Salesforce 生态系统中实施 DevOps 的必要性。

# Salesforce 作为开发平台的历史介绍

对于任何足够复杂的 IT 系统，在实施阶段和日常运营中，考虑全面的架构因素都至关重要。这些考虑不仅仅是技术层面的内容，还包括业务层面的因素——强有力的治理、准确且及时更新的文档、可定义的指标，以及能够向企业展示的投资回报。

随着 Salesforce 的发展，应用这些架构因素的需求也随之增加。Salesforce 在许多组织中已经成为 *一等公民*，作为企业运作的数字枢纽。因此，一个适当的变更管理过程对于避免服务中断至关重要，而 DevOps 是满足这一要求的完美方法。DevOps 承诺更快、更准确的软件发布、更少的错误、更少的停机时间以及在问题发生时更快的恢复路径。

我们可以合理地将 2003 年视为 Salesforce 成为开发平台的起点。在公司首届 Dreamforce 大会——这一至今每年仍持续举办的旗舰会议上，他们宣布了客户如何自定义平台的根本性变化。这个被称为 **sforce 2.0** 的版本，最初被定位为 *按需应用服务器*，并包含一些关键功能，我们将接下来详细探讨。

## 自定义对象

此时引入的第一个重大创新是能够创建额外的自定义对象，类似于数据库表，用来补充 Salesforce 为其核心 CRM 功能提供的内置对象。这些自定义对象本身可以包含自定义字段，并共同为在平台上开发自定义业务应用提供了早期框架。

突然，Salesforce 不再仅仅是一个销售 CRM 系统，而是开始向成为一个开发自定义业务应用的平台转型。Salesforce 团队现在可以开始根据他们业务的核心需求定制流程和应用，无论他们所属的行业是什么。例如，一些 Salesforce 客户将利用这一能力来构建处理业务支持案例的能力——这项功能直到 2009 年 Service Cloud 发布时才成为平台的核心能力。

## S-Controls

S-Controls（最初称为 *sforce controls*）是新定制功能中两个编程元素之一。S-Controls 将功能和用户界面元素结合在一个容器中，可以包含任何可以在浏览器中显示的项目，例如 Java 小程序、ActiveX 控件和网页表单。

尽管 S-Controls 已经被弃用很久，但它们是开发者首次可以用编程方式定制平台的工具，它们使开发者能够将其他非 Salesforce 开发的技能和编程语言带入平台。它们使 Salesforce 开发者能够利用 HTML 和 JavaScript 创建自定义页面和用户界面组件。从这个角度来看，它们可以被视为 Lightning Web Components 的早期先驱，尽管当时并没有我们今天使用的最佳实践。

## SOQL

Sforce 2.0 还引入了 **Sforce 对象查询语言** (**SOQL**)，它提供了一种从标准对象和自定义对象中查询数据的方式，语法类似于行业标准的 SQL。这为开发者提供了一个强大的机制，能够通过编程查询 Salesforce 组织中的数据，并对查询结果进行操作。

如果从架构师的角度看 SOQL，我们可以看到它如何与确保数据质量与元数据质量同等重要的需求相一致。干净、可操作的数据是推动业务决策的关键交付物之一，应始终是架构师的重要任务之一。SOQL 提供了一种额外的方式来处理这些数据，无论是日常业务中的操作数据，还是作为从平台中提取数据进行归档的手段。我们稍后将探讨这一后者的使用案例，特别是在分析良好架构的 Salesforce DevOps 策略中备份的重要性时。

## Sforce Web 服务

sforce 2.0 的另一个基本新功能是能够将 Salesforce 与其他平台集成，这得益于通过 Web 服务 API 曝露了对象模型和业务逻辑。使用当时的标准 SOAP 和 WSDL，现在可以通过网络从更传统的开发环境和系统与 Salesforce 组织进行交互。

## 工作流

sforce 2.0 引入的最后一个重大元素是一个名为工作流的业务过程自动化引擎。通过定义响应数据变化的工作流规则，可以触发业务逻辑，处理诸如升级、通知和根据事件自动更新数据等操作。工作流仍然是一个配置而非代码的功能实现方式，但正如我们稍后看到的，作为一种低代码解决方案，并不意味着在 DevOps 中应该被忽视。

## Apex 和 Visualforce

在 2006 年的 Dreamforce 大会——Salesforce 的旗舰会议上，联合创始人 Parker Harris 揭示了迄今为止 Salesforce 平台最重要的变化。客户现在可以使用 Salesforce 自己的编程语言——**Apex**，直接在 Salesforce 内部开发自定义解决方案。

作为流行的 Java 编程语言的变体，Apex 首次通过代码实现自动化。最初仅限于触发器，开发者现在可以通过编程方式响应数据变化。

在平台演变的后期，Apex 引入了更多面向对象的范式，随着 Apex 类的到来，允许开发者构建比仅使用触发器更结构化、解耦的实现方式。

除了 Apex，Salesforce 平台的另一项重大创新是 Visualforce，后者于 2008 年推出。Visualforce 从当时的其他 UI 语言，如 ASP 或 PHP 中汲取灵感，将 HTML 与编程元素和标记结合在一起，这些标记又连接回你在 Apex 中编写的逻辑。Visualforce 很快取代了之前推出的 S-Controls，成为在 Salesforce 实现中编写自定义用户界面和页面的标准方式。

随着平台在开发和定制方面的所有这些进展，Salesforce 随后将注意力转向了如何交付这些功能。让我们在下一节中看看这些功能最初是如何被引入的。

# 沙箱和变更集

随着 Salesforce 的不断成熟，需要能够在生产环境外安全地进行更改，并在准备好时将其迁移到生产环境的需求变得愈加明显。然而，DevOps 创新的步伐似乎未能跟上 Salesforce 作为开发平台崛起的步伐。

沙盒功能在 2006 年冬季发布时推出，使客户能够在远离生产环境的安全环境中尝试更改和增强功能——但也有一个限制。沙盒的原始实现并不允许你将这些更改*回传*到生产环境，这意味着你必须手动重新创建这些更改到生产环境中。这将既耗时又容易出错。

为了应对这一不足，变更集最初在 2010 年冬季发布的 beta 版本中推出，距沙盒发布已有约四年，最终它们在 2011 年春季发布中成为了正式版本。变更集最终允许在沙盒环境中进行的代码和配置工作打包并在环境之间迁移，无论是从沙盒到沙盒，沙盒到生产，还是生产到沙盒。这为将 Salesforce 环境作为成熟应用程序开发生命周期的一部分进行规划开辟了新可能——现在，你可以在生产上线前拥有开发、QA、UAT 和预发布环境。这是迈向与其他开发平台相匹配的 DevOps 过程的第一步。

# 元数据和工具 API

为了为开发和部署提供更好的工具，Salesforce 在 2008 年春季发布了两个重要的 API——元数据 API 和 2013 年春季发布的工具 API。尽管它们都履行了相似的功能，但它们的目标和功能上有一些重要的区别。

## 元数据 API

在最简单的层面上，元数据是描述你数据*结构*的数据，但对于 Salesforce 平台来说，这有些过于简化。*元数据*一词还涵盖了 Salesforce 的许多配置和自定义元素——截至写作时，Salesforce 自己的元数据覆盖报告可在 [`developer.salesforce.com/docs/metadata-coverage`](https://developer.salesforce.com/docs/metadata-coverage) 查阅，报告显示平台上有 601 种元数据类型，其中绝大多数都在元数据 API 中得到支持。

元数据 API 可以用来在环境之间移动这些元数据。你可以从一个 Salesforce 组织中检索元数据作为 XML 文件，并将其部署到另一个组织中。就像变更集一样，这些操作的源和目标可以是沙盒、生产环境，或者正如我们稍后会学习的那样，临时组织。

此外，元数据 API 允许你在 Salesforce 组织中创建、更新和删除元数据，这为 Salesforce 开发和在平台上采用 DevOps 方法解锁了一个基本能力。

平台上的大多数 DevOps 工具都依赖于元数据 API，无论是 Salesforce 自家的 SFDX、新的 DevOps 中心，还是各种可用的第三方 Salesforce DevOps 解决方案。它们都利用元数据 API 来协调代码和配置在不同环境之间的迁移。

## 工具 API

虽然 Metadata API 大部分处理了元数据管理的繁重工作，Salesforce 推出了 Tooling API，提供了更多功能，更好地对接了 DevOps 实践，比如更小更精确的元数据检索和部署，运行单元测试并查看测试结果及相关代码覆盖率，以及支持一些额外的代码调试能力。

能够管理单元测试周期使 Tooling API 成为在 DevOps 过程和工具中另一个强有力的选择。作为架构师，我们需要确保我们不仅能够快速交付代码，而且代码质量符合要求——它不会在孤立环境中出现问题，不会破坏现有代码，并且能够在 Salesforce 组织之间无缝部署。这些都是变更失败率的因素，是我们在下一章中将要探讨的基本 DevOps 指标之一，因为我们将研究作为架构师开发 DevOps 文化的关键考虑因素。

Tooling API 主要面向希望为平台创建额外开发工具或应用程序的人群，并且其到来预示着 Salesforce 开发支持在当时流行的 IDE 中，我们将在接下来看到。

# Force.com IDE 和 Mavensmate

使用了利用元数据和工具 API 的新工具，不再需要在 Salesforce 平台内部开发。为了帮助开发人员采用这种方法，Salesforce 开始研究如何提供符合当时标准的标准化开发人员体验。让我们来看看当时可用的工具。

## Force.com IDE

早期利用这一特性的 IDE 之一就是 Salesforce 自己的 Force.com IDE。

基于流行的 Eclipse 开发环境的模块化插件架构构建，Force.com IDE 利用新的 API 允许开发人员不仅使用适当的编辑器编码，还可以直接从 IDE 将更改保存回他们的开发组织，而无需切换回 Salesforce 用户界面。

Force.com IDE 很快变得非常流行，因为它是为 Salesforce 开发人员提供现代环境的首次尝试，并具备其他平台（如 Java 或 .NET）开发人员期望的一些便利条件。然而，它同样迅速地因为速度慢和不稳定而声名狼藉。

## Mavensmate

作为 Eclipse 和插件的重量级安装的解毒剂，并作为提高速度和稳定性的潜在手段，2013 年见证了另一款 Salesforce 开发工具的到来——Mavensmate。

Mavensmate 采用了与 Force.com IDE 相同的插件方式，它有效地扩展了另一款编辑器**Sublime Text**（后来还添加了对竞争对手 Atom 编辑器的支持），但无论是底层的编辑器还是上层的 Mavensmate 插件，都要轻量得多。这使得使用 Salesforce 进行开发更加简单、快速和稳定，Mavensmate 因其速度和易用性成为了全球 Salesforce 开发者的首选——不仅仅是用于开发，还可以通过使用 Metadata 和 Tooling API 进行变更部署。

# 引入 SFDX

Salesforce 的变更管理状态在多年间大致保持稳定。对于大多数 Salesforce 开发者和管理员来说，变更集仍然是将更改从沙箱环境部署到生产环境的最终方式。

所有这一切在 2018 年 Salesforce 发布其 SFDX 工具链时发生了变化。SFDX 承诺带来了现代化的开发和部署实践，这些实践在其他平台上已有实现，并通过命令行工具提供。突然之间，存在了高级可脚本化部署、更强大的 IDE 集成以及管理变更的新方式的潜力。最重要的是，它标志着 Salesforce 朝着源代码驱动的开发模式转变，而不是传统的基于组织的模式。

SFDX 的**命令行界面**（**CLI**）与 scratch orgs 的引入紧密结合。这些是临时的开发环境，可以轻松地从 SFDX 创建和销毁，使用不同的配置（或*组织形态*）创建，并填充测试数据。从命令创建 scratch org 的能力为自动化测试开辟了新纪元，正如我们稍后将看到的那样，但它也强调了一个原则：现在，组织已不再是首要的，源代码才是核心。如果一个 scratch org 过期了，这并不是一个大问题，因为可以轻松地从源代码重新创建一个。

最终，Salesforce 意识到与开发工具紧密集成的必要性，并为流行的**Visual Studio**（**VS**）Code 环境提供了扩展，使得在 Salesforce 平台上的开发和部署变得更加简便，直接从 IDE 中操作。此外，通过构建基于开放标准的**Open Command Line Interface Framework**（**OCLIF**），它使工具能够通过插件进行扩展，这些插件来自 Salesforce 内部和外部，扩展了 SFDX CLI 的功能，填补了该工具本身无法覆盖的一些空白。

SFDX 继续是 Salesforce 推荐的开发者使用平台的方式，特别是在将其集成到 CI/CD 流水线和其他自动化工具中。截止到 2022 年 12 月，Salesforce 正在推动统一命令行界面的发展，将 SFDX 命令行和更新的 SF 命令行结合起来，后者引入了更新的结构和更简洁的方法。这一整合有望带来一个更高效的命令行工具集，提升构建强大 DevOps 流水线的便利性。

# DevOps 中心

Salesforce 长期以来一直承认平台已经超出了变更集的局限，但 SFDX（至今依然如此）在客户眼中被视为仅供开发人员和那些熟悉命令行的用户使用的工具，尽管 VS Code 扩展让它变得更易于使用。一个由第三方提供商如 Gearset、Copado、AutoRABIT 和 Flosum 等组成的庞大生态系统已崛起，为提供符合更广泛 IT 行业最佳实践的强大 DevOps 平台提供支持。这些工具为 Salesforce 开发人员和管理员提供了诸如组织间比较、版本控制、静态代码分析和部署流水线等功能。

Salesforce 通过发布 DevOps 中心进入了这一领域，该产品在 2022 年 12 月正式发布。虽然它的功能不如第三方生态系统中的现有解决方案丰富，但它代表了 Salesforce 对所有用户信息传递的变化——从变更集部署转向更易于操作的方式，无论你是低代码还是专业代码的管理员或开发人员。

我们将在后面的章节中深入探讨 DevOps 中心的具体内容（以及第三方 Salesforce DevOps 领域的领先解决方案），但重要的是要看到这个新产品在思维方式上的根本转变，特别是当它放在上述平台变更创建和交付历史的背景下来看。

DevOps 中心将 Salesforce DevOps 中经过多年逐步建立的最佳实践集中整合，并通过平台内易于理解的本地界面呈现：

+   它引导 Salesforce 从业人员向一种模型转变，在该模型中，源代码管理是变更的真实版本，而不是沙箱组织。

+   它鼓励通过工作项或用户故事来实现孤立的、增量的变更——这一概念是敏捷运动推广的，并且在许多其他平台和组织的 DevOps 策略中广泛应用。

+   最重要的是，它为变更交付提供了更好的可见性和问责制

这些是 DevOps 流程总体架构的因素，稍后在本书中我们将深入探讨。它并没有在初始版本中全面覆盖每个方面，应该被视为一个 DevOps *工具*，而不是一个 DevOps *解决方案*，但作为一种教育 Salesforce 用户了解 DevOps 基础并帮助他们逐步摆脱变更集的方式，它是一个非常坚实的起点。

# 摘要

在本章中，我们回顾了 Salesforce 作为开发平台的发展历史，并了解了多年来如何添加新功能。我们还探讨了如何在 Salesforce 上交付这些更改的方式，从变更集到使用它们的各种 API 和工具，再到 DevOps Center 的出现。

拥有这些知识后，我们不仅能够更好地理解平台的发展历程，还能理解一些设计选择背后的理由，了解一些较旧的实现方式，这在需要处理旧版 Salesforce 组织时常常会非常有用。

作为架构师，重要的是不要把 DevOps 工具当作理所当然，能够使用各种不同的方式和解决方案，不管它们有多古老，都将帮助我们改进 Salesforce DevOps 的现状，以便更好地交付我们的实施方案。在接下来的章节中，我们将讨论一些最新的工具，更重要的是，讨论塑造现代 Salesforce DevOps 的技术和流程。
